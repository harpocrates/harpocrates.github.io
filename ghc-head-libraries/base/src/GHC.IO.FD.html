<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE CPP
           , NoImplicitPrelude
           , BangPatterns
  #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# OPTIONS_GHC -Wno-identities #-}</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Whether there are identities depends on the platform</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# OPTIONS_HADDOCK hide #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Module      :  GHC.IO.FD</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Copyright   :  (c) The University of Glasgow, 1994-2008</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- License     :  see libraries/base/LICENSE</span><span>
</span><a name="line-15"></a><span class="hs-comment">--</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- Maintainer  :  libraries@haskell.org</span><span>
</span><a name="line-17"></a><span class="hs-comment">-- Stability   :  internal</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- Portability :  non-portable</span><span>
</span><a name="line-19"></a><span class="hs-comment">--</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- Raw read/write operations on file descriptors</span><span>
</span><a name="line-21"></a><span class="hs-comment">--</span><span>
</span><a name="line-22"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.IO.FD</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-25"></a><span>        </span><span class="hs-identifier">FD</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><span class="hs-identifier">openFile</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkFD</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">release</span><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><span class="hs-identifier">setNonBlockingMode</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="GHC.IO.FD.html#setNonBlockingMode"><span class="hs-identifier hs-var">readRawBufferPtr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">readRawBufferPtrNoBlock</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">writeRawBufferPtr</span><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="GHC.IO.FD.html#readRawBufferPtr"><span class="hs-identifier hs-var">stdin</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.FD.html#readRawBufferPtr"><span class="hs-identifier hs-var">stdout</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">stderr</span><span>
</span><a name="line-30"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Base</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Base.html"><span class="hs-identifier">GHC.Num</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Real</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Real.html"><span class="hs-identifier">GHC.Show</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.Show.html"><span class="hs-identifier">GHC.Enum</span></a><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.IO</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.IO.IOMode</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.IOMode.html"><span class="hs-identifier">GHC.IO.Buffer</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.IO.BufferedIO</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.IO.Device</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.IO.Device</span><span> </span><span class="hs-special">(</span><a href="GHC.IO.Device.html"><span class="hs-identifier">SeekMode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">IODeviceType</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.IO.Device.html"><span class="hs-identifier">GHC.Conc.IO</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.IO.Exception</span><span>
</span><a name="line-46"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Windows</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Bool</span><span>
</span><a name="line-49"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.C</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System.Posix.Internals</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Posix.Internals</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">FD</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">setEcho</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getEcho</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="System.Posix.Internals.html"><span class="hs-identifier">System.Posix.Types</span></a><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
# if defined(i386_HOST_ARCH)
#  define WINDOWS_CCONV stdcall
# elif defined(x86_64_HOST_ARCH)
#  define WINDOWS_CCONV ccall
# else
#  error Unknown mingw32 arch
# endif
#endif
</span><span>
</span><a name="line-67"></a><span class="hs-identifier">c_DEBUG_DUMP</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-68"></a><a name="c_DEBUG_DUMP"><a href="GHC.IO.FD.html#c_DEBUG_DUMP"><span class="hs-identifier">c_DEBUG_DUMP</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- The file-descriptor IO device</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-keyword">data</span><span> </span><a name="FD"><a href="GHC.IO.FD.html#FD"><span class="hs-identifier">FD</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FD"><a href="GHC.IO.FD.html#FD"><span class="hs-identifier">FD</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-74"></a><span>  </span><a name="fdFD"><a href="GHC.IO.FD.html#fdFD"><span class="hs-identifier">fdFD</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span class="hs-special">,</span><span>
</span><a name="line-75"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>  </span><span class="hs-comment">-- On Windows, a socket file descriptor needs to be read and written</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-comment">-- using different functions (send/recv).</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-identifier">fdIsSocket_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">Int</span><span>
</span><a name="line-79"></a><span class="hs-cpp">#else
</span><span>  </span><span class="hs-comment">-- On Unix we need to know whether this FD has O_NONBLOCK set.</span><span>
</span><a name="line-81"></a><span>  </span><span class="hs-comment">-- If it has, then we can use more efficient routines to read/write to it.</span><span>
</span><a name="line-82"></a><span>  </span><span class="hs-comment">-- It is always safe for this to be off.</span><span>
</span><a name="line-83"></a><span>  </span><a name="fdIsNonBlocking"><a href="GHC.IO.FD.html#fdIsNonBlocking"><span class="hs-identifier">fdIsNonBlocking</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-84"></a><span class="hs-cpp">#endif
</span><span class=""> }

</span><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">FD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-89"></a><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fdIsSocket_</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-operator">/=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-90"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- | @since 4.1.0.0</span><span>
</span><a name="line-93"></a><span class="hs-keyword">instance</span><span> </span><a href="GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-94"></a><span>  </span><a name="local-8214565720323809751"><a href="GHC.Show.html#show"><span class="hs-identifier">show</span></a></a><span> </span><a name="local-6989586621679352651"><a href="#local-6989586621679352651"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352651"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-comment">-- | @since 4.1.0.0</span><span>
</span><a name="line-97"></a><span class="hs-keyword">instance</span><span> </span><a href="GHC.IO.Device.html#RawIO"><span class="hs-identifier hs-type">GHC.IO.Device.RawIO</span></a><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-98"></a><span>  </span><a name="local-8214565720324029954"><a href="GHC.IO.Device.html#read"><span class="hs-identifier">read</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#fdRead"><span class="hs-identifier hs-var">fdRead</span></a><span>
</span><a name="line-99"></a><span>  </span><a name="local-8214565720324029955"><a href="GHC.IO.Device.html#readNonBlocking"><span class="hs-identifier">readNonBlocking</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#fdReadNonBlocking"><span class="hs-identifier hs-var">fdReadNonBlocking</span></a><span>
</span><a name="line-100"></a><span>  </span><a name="local-8214565720324029956"><a href="GHC.IO.Device.html#write"><span class="hs-identifier">write</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#fdWrite"><span class="hs-identifier hs-var">fdWrite</span></a><span>
</span><a name="line-101"></a><span>  </span><a name="local-8214565720324029957"><a href="GHC.IO.Device.html#writeNonBlocking"><span class="hs-identifier">writeNonBlocking</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#fdWriteNonBlocking"><span class="hs-identifier hs-var">fdWriteNonBlocking</span></a><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-comment">-- | @since 4.1.0.0</span><span>
</span><a name="line-104"></a><span class="hs-keyword">instance</span><span> </span><a href="GHC.IO.Device.html#IODevice"><span class="hs-identifier hs-type">GHC.IO.Device.IODevice</span></a><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-105"></a><span>  </span><a name="local-8214565720324029939"><a href="GHC.IO.Device.html#ready"><span class="hs-identifier">ready</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#ready"><span class="hs-identifier hs-var">ready</span></a><span>
</span><a name="line-106"></a><span>  </span><a name="local-8214565720324029940"><a href="GHC.IO.Device.html#close"><span class="hs-identifier">close</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#close"><span class="hs-identifier hs-var">close</span></a><span>
</span><a name="line-107"></a><span>  </span><a name="local-8214565720324029941"><a href="GHC.IO.Device.html#isTerminal"><span class="hs-identifier">isTerminal</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#isTerminal"><span class="hs-identifier hs-var">isTerminal</span></a><span>
</span><a name="line-108"></a><span>  </span><a name="local-8214565720324029942"><a href="GHC.IO.Device.html#isSeekable"><span class="hs-identifier">isSeekable</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#isSeekable"><span class="hs-identifier hs-var">isSeekable</span></a><span>
</span><a name="line-109"></a><span>  </span><a name="local-8214565720324029943"><a href="GHC.IO.Device.html#seek"><span class="hs-identifier">seek</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#seek"><span class="hs-identifier hs-var">seek</span></a><span>
</span><a name="line-110"></a><span>  </span><a name="local-8214565720324029944"><a href="GHC.IO.Device.html#tell"><span class="hs-identifier">tell</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#tell"><span class="hs-identifier hs-var">tell</span></a><span>
</span><a name="line-111"></a><span>  </span><a name="local-8214565720324029945"><a href="GHC.IO.Device.html#getSize"><span class="hs-identifier">getSize</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#getSize"><span class="hs-identifier hs-var">getSize</span></a><span>
</span><a name="line-112"></a><span>  </span><a name="local-8214565720324029946"><a href="GHC.IO.Device.html#setSize"><span class="hs-identifier">setSize</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#setSize"><span class="hs-identifier hs-var">setSize</span></a><span>
</span><a name="line-113"></a><span>  </span><a name="local-8214565720324029947"><a href="GHC.IO.Device.html#setEcho"><span class="hs-identifier">setEcho</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#setEcho"><span class="hs-identifier hs-var">setEcho</span></a><span>
</span><a name="line-114"></a><span>  </span><a name="local-8214565720324029948"><a href="GHC.IO.Device.html#getEcho"><span class="hs-identifier">getEcho</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#getEcho"><span class="hs-identifier hs-var">getEcho</span></a><span>
</span><a name="line-115"></a><span>  </span><a name="local-8214565720324029949"><a href="GHC.IO.Device.html#setRaw"><span class="hs-identifier">setRaw</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#setRaw"><span class="hs-identifier hs-var">setRaw</span></a><span>
</span><a name="line-116"></a><span>  </span><a name="local-8214565720324029950"><a href="GHC.IO.Device.html#devType"><span class="hs-identifier">devType</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#devType"><span class="hs-identifier hs-var">devType</span></a><span>
</span><a name="line-117"></a><span>  </span><a name="local-8214565720324029951"><a href="GHC.IO.Device.html#dup"><span class="hs-identifier">dup</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#dup"><span class="hs-identifier hs-var">dup</span></a><span>
</span><a name="line-118"></a><span>  </span><a name="local-8214565720324029952"><a href="GHC.IO.Device.html#dup2"><span class="hs-identifier">dup2</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#dup2"><span class="hs-identifier hs-var">dup2</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">-- We used to use System.Posix.Internals.dEFAULT_BUFFER_SIZE, which is</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- taken from the value of BUFSIZ on the current platform.  This value</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- varies too much though: it is 512 on Windows, 1024 on OS X and 8192</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- on Linux.  So let's just use a decent size on every platform:</span><span>
</span><a name="line-124"></a><span class="hs-identifier">dEFAULT_FD_BUFFER_SIZE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-125"></a><a name="dEFAULT_FD_BUFFER_SIZE"><a href="GHC.IO.FD.html#dEFAULT_FD_BUFFER_SIZE"><span class="hs-identifier">dEFAULT_FD_BUFFER_SIZE</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">8192</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-comment">-- | @since 4.1.0.0</span><span>
</span><a name="line-128"></a><span class="hs-keyword">instance</span><span> </span><a href="GHC.IO.BufferedIO.html#BufferedIO"><span class="hs-identifier hs-type">BufferedIO</span></a><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-129"></a><span>  </span><a name="local-8214565720324030940"><a href="GHC.IO.BufferedIO.html#newBuffer"><span class="hs-identifier">newBuffer</span></a></a><span> </span><a name="local-6989586621679352641"><a href="#local-6989586621679352641"><span class="hs-identifier">_dev</span></a></a><span> </span><a name="local-6989586621679352642"><a href="#local-6989586621679352642"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.Buffer.html#newByteBuffer"><span class="hs-identifier hs-var">newByteBuffer</span></a><span> </span><a href="GHC.IO.FD.html#dEFAULT_FD_BUFFER_SIZE"><span class="hs-identifier hs-var">dEFAULT_FD_BUFFER_SIZE</span></a><span> </span><a href="#local-6989586621679352642"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-130"></a><span>  </span><a name="local-8214565720324030941"><a href="GHC.IO.BufferedIO.html#fillReadBuffer"><span class="hs-identifier">fillReadBuffer</span></a></a><span>    </span><a name="local-6989586621679352643"><a href="#local-6989586621679352643"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352644"><a href="#local-6989586621679352644"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#readBuf%27"><span class="hs-identifier hs-var">readBuf'</span></a><span> </span><a href="#local-6989586621679352643"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352644"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-131"></a><span>  </span><a name="local-8214565720324030942"><a href="GHC.IO.BufferedIO.html#fillReadBuffer0"><span class="hs-identifier">fillReadBuffer0</span></a></a><span>   </span><a name="local-6989586621679352645"><a href="#local-6989586621679352645"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352646"><a href="#local-6989586621679352646"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.BufferedIO.html#readBufNonBlocking"><span class="hs-identifier hs-var">readBufNonBlocking</span></a><span> </span><a href="#local-6989586621679352645"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352646"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-132"></a><span>  </span><a name="local-8214565720324030944"><a href="GHC.IO.BufferedIO.html#flushWriteBuffer"><span class="hs-identifier">flushWriteBuffer</span></a></a><span>  </span><a name="local-6989586621679352647"><a href="#local-6989586621679352647"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352648"><a href="#local-6989586621679352648"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#writeBuf%27"><span class="hs-identifier hs-var">writeBuf'</span></a><span> </span><a href="#local-6989586621679352647"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352648"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-133"></a><span>  </span><a name="local-8214565720324030945"><a href="GHC.IO.BufferedIO.html#flushWriteBuffer0"><span class="hs-identifier">flushWriteBuffer0</span></a></a><span> </span><a name="local-6989586621679352649"><a href="#local-6989586621679352649"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352650"><a href="#local-6989586621679352650"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.BufferedIO.html#writeBufNonBlocking"><span class="hs-identifier hs-var">writeBufNonBlocking</span></a><span> </span><a href="#local-6989586621679352649"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352650"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-identifier">readBuf'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span class="hs-special">,</span><span> </span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span class="hs-special">)</span><span>
</span><a name="line-136"></a><a name="readBuf%27"><a href="GHC.IO.FD.html#readBuf%27"><span class="hs-identifier">readBuf'</span></a></a><span> </span><a name="local-6989586621679352652"><a href="#local-6989586621679352652"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352653"><a href="#local-6989586621679352653"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-137"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="GHC.IO.FD.html#c_DEBUG_DUMP"><span class="hs-identifier hs-var">c_DEBUG_DUMP</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-138"></a><span>      </span><a href="System.Posix.Internals.html#puts"><span class="hs-identifier hs-var">puts</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;readBuf fd=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a><span> </span><a href="#local-6989586621679352652"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679352653"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679352654"><a href="#local-6989586621679352654"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><a name="local-6989586621679352655"><a href="#local-6989586621679352655"><span class="hs-identifier">buf'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.BufferedIO.html#readBuf"><span class="hs-identifier hs-var">readBuf</span></a><span> </span><a href="#local-6989586621679352652"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352653"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-140"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="GHC.IO.FD.html#c_DEBUG_DUMP"><span class="hs-identifier hs-var">c_DEBUG_DUMP</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-141"></a><span>      </span><a href="System.Posix.Internals.html#puts"><span class="hs-identifier hs-var">puts</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;after: &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679352655"><span class="hs-identifier hs-var">buf'</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352654"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><a href="#local-6989586621679352655"><span class="hs-identifier hs-var">buf'</span></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-identifier">writeBuf'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Buffer.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><a name="writeBuf%27"><a href="GHC.IO.FD.html#writeBuf%27"><span class="hs-identifier">writeBuf'</span></a></a><span> </span><a name="local-6989586621679352656"><a href="#local-6989586621679352656"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352657"><a href="#local-6989586621679352657"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-146"></a><span>  </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="GHC.IO.FD.html#c_DEBUG_DUMP"><span class="hs-identifier hs-var">c_DEBUG_DUMP</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-147"></a><span>      </span><a href="System.Posix.Internals.html#puts"><span class="hs-identifier hs-var">puts</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;writeBuf fd=&quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a><span> </span><a href="#local-6989586621679352656"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="GHC.IO.Buffer.html#summaryBuffer"><span class="hs-identifier hs-var">summaryBuffer</span></a><span> </span><a href="#local-6989586621679352657"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>  </span><a href="GHC.IO.BufferedIO.html#writeBuf"><span class="hs-identifier hs-var">writeBuf</span></a><span> </span><a href="#local-6989586621679352656"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352657"><span class="hs-identifier hs-var">buf</span></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- opening files</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- | Open a file and make an 'FD' for it.  Truncates the file to zero</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- size when the `IOMode` is `WriteMode`.</span><span>
</span><a name="line-155"></a><span class="hs-identifier">openFile</span><span>
</span><a name="line-156"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a><span> </span><span class="hs-comment">-- ^ file to open</span><span>
</span><a name="line-157"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.IOMode.html#IOMode"><span class="hs-identifier hs-type">IOMode</span></a><span>   </span><span class="hs-comment">-- ^ mode in which to open the file</span><span>
</span><a name="line-158"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>     </span><span class="hs-comment">-- ^ open the file in non-blocking mode?</span><span>
</span><a name="line-159"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span class="hs-special">,</span><a href="GHC.IO.Device.html#IODeviceType"><span class="hs-identifier hs-type">IODeviceType</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><a name="openFile"><a href="GHC.IO.FD.html#openFile"><span class="hs-identifier">openFile</span></a></a><span> </span><a name="local-6989586621679352658"><a href="#local-6989586621679352658"><span class="hs-identifier">filepath</span></a></a><span> </span><a name="local-6989586621679352659"><a href="#local-6989586621679352659"><span class="hs-identifier">iomode</span></a></a><span> </span><a name="local-6989586621679352660"><a href="#local-6989586621679352660"><span class="hs-identifier">non_blocking</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-162"></a><span>  </span><a href="System.Posix.Internals.html#withFilePath"><span class="hs-identifier hs-var">withFilePath</span></a><span> </span><a href="#local-6989586621679352658"><span class="hs-identifier hs-var">filepath</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679352661"><a href="#local-6989586621679352661"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-165"></a><span>      </span><a name="local-6989586621679352662"><a href="#local-6989586621679352662"><span class="hs-identifier">oflags1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679352659"><span class="hs-identifier hs-var">iomode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-166"></a><span>                  </span><a href="GHC.IO.IOMode.html#ReadMode"><span class="hs-identifier hs-var">ReadMode</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#read_flags"><span class="hs-identifier hs-var">read_flags</span></a><span>
</span><a name="line-167"></a><span>                  </span><a href="GHC.IO.IOMode.html#WriteMode"><span class="hs-identifier hs-var">WriteMode</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#write_flags"><span class="hs-identifier hs-var">write_flags</span></a><span>
</span><a name="line-168"></a><span>                  </span><a href="GHC.IO.IOMode.html#ReadWriteMode"><span class="hs-identifier hs-var">ReadWriteMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#rw_flags"><span class="hs-identifier hs-var">rw_flags</span></a><span>
</span><a name="line-169"></a><span>                  </span><a href="GHC.IO.IOMode.html#AppendMode"><span class="hs-identifier hs-var">AppendMode</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#append_flags"><span class="hs-identifier hs-var">append_flags</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>      </span><span class="hs-identifier">binary_flags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">o_BINARY</span><span>
</span><a name="line-173"></a><span class="hs-cpp">#else
</span><span>      </span><a name="local-6989586621679352663"><a href="#local-6989586621679352663"><span class="hs-identifier">binary_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-175"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-177"></a><span>      </span><a name="local-6989586621679352664"><a href="#local-6989586621679352664"><span class="hs-identifier">oflags2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352662"><span class="hs-identifier hs-var">oflags1</span></a><span> </span><a href="Data.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a><span> </span><a href="#local-6989586621679352663"><span class="hs-identifier hs-var">binary_flags</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span>      </span><a name="local-6989586621679352665"><a href="#local-6989586621679352665"><span class="hs-identifier">oflags</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679352660"><span class="hs-identifier hs-var">non_blocking</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352664"><span class="hs-identifier hs-var">oflags2</span></a><span> </span><a href="Data.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a><span> </span><a href="GHC.IO.FD.html#nonblock_flags"><span class="hs-identifier hs-var">nonblock_flags</span></a><span>
</span><a name="line-180"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352664"><span class="hs-identifier hs-var">oflags2</span></a><span>
</span><a name="line-181"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-comment">-- NB. always use a safe open(), because we don't know whether open()</span><span>
</span><a name="line-184"></a><span>    </span><span class="hs-comment">-- will be fast or not.  It can be slow on NFS and FUSE filesystems,</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-comment">-- for example.</span><span>
</span><a name="line-186"></a><span>    </span><a name="local-6989586621679352666"><a href="#local-6989586621679352666"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.C.Error.html#throwErrnoIfMinus1Retry"><span class="hs-identifier hs-var">throwErrnoIfMinus1Retry</span></a><span> </span><span class="hs-string">&quot;openFile&quot;</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="System.Posix.Internals.html#c_safe_open"><span class="hs-identifier hs-var">c_safe_open</span></a><span> </span><a href="#local-6989586621679352661"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679352665"><span class="hs-identifier hs-var">oflags</span></a><span> </span><span class="hs-number">0o666</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679352668"><a href="#local-6989586621679352668"><span class="hs-identifier">fD</span></a></a><span class="hs-special">,</span><a name="local-6989586621679352669"><a href="#local-6989586621679352669"><span class="hs-identifier">fd_type</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#mkFD"><span class="hs-identifier hs-var">mkFD</span></a><span> </span><a href="#local-6989586621679352666"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352659"><span class="hs-identifier hs-var">iomode</span></a><span> </span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-comment">{-no stat-}</span><span>
</span><a name="line-189"></a><span>                            </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span class="hs-comment">{-not a socket-}</span><span>
</span><a name="line-190"></a><span>                            </span><a href="#local-6989586621679352660"><span class="hs-identifier hs-var">non_blocking</span></a><span>
</span><a name="line-191"></a><span>            </span><span class="hs-special">`</span><a href="GHC.IO.html#catchAny"><span class="hs-identifier hs-var">catchAny</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679352667"><a href="#local-6989586621679352667"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.Posix.Internals.html#c_close"><span class="hs-identifier hs-var">c_close</span></a><span> </span><a href="#local-6989586621679352666"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-192"></a><span>                                </span><a href="GHC.IO.html#throwIO"><span class="hs-identifier hs-var">throwIO</span></a><span> </span><a href="#local-6989586621679352667"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-comment">-- we want to truncate() if this is an open in WriteMode, but only</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-comment">-- if the target is a RegularFile.  ftruncate() fails on special files</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-comment">-- like /dev/null.</span><span>
</span><a name="line-197"></a><span>    </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352659"><span class="hs-identifier hs-var">iomode</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.IO.IOMode.html#WriteMode"><span class="hs-identifier hs-var">WriteMode</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><a href="#local-6989586621679352669"><span class="hs-identifier hs-var">fd_type</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.IO.Device.html#RegularFile"><span class="hs-identifier hs-var">RegularFile</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-198"></a><span>      </span><a href="GHC.IO.FD.html#setSize"><span class="hs-identifier hs-var">setSize</span></a><span> </span><a href="#local-6989586621679352668"><span class="hs-identifier hs-var">fD</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352668"><span class="hs-identifier hs-var">fD</span></a><span class="hs-special">,</span><a href="#local-6989586621679352669"><span class="hs-identifier hs-var">fd_type</span></a><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-identifier">std_flags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">output_flags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">read_flags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">write_flags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rw_flags</span><span class="hs-special">,</span><span>
</span><a name="line-203"></a><span>    </span><span class="hs-identifier">append_flags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nonblock_flags</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-204"></a><a name="std_flags"><a href="GHC.IO.FD.html#std_flags"><span class="hs-identifier">std_flags</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="System.Posix.Internals.html#o_NOCTTY"><span class="hs-identifier hs-var">o_NOCTTY</span></a><span>
</span><a name="line-205"></a><a name="output_flags"><a href="GHC.IO.FD.html#output_flags"><span class="hs-identifier">output_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#std_flags"><span class="hs-identifier hs-var">std_flags</span></a><span>    </span><a href="Data.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a><span> </span><a href="System.Posix.Internals.html#o_CREAT"><span class="hs-identifier hs-var">o_CREAT</span></a><span>
</span><a name="line-206"></a><a name="read_flags"><a href="GHC.IO.FD.html#read_flags"><span class="hs-identifier">read_flags</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#std_flags"><span class="hs-identifier hs-var">std_flags</span></a><span>    </span><a href="Data.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a><span> </span><a href="System.Posix.Internals.html#o_RDONLY"><span class="hs-identifier hs-var">o_RDONLY</span></a><span>
</span><a name="line-207"></a><a name="write_flags"><a href="GHC.IO.FD.html#write_flags"><span class="hs-identifier">write_flags</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#output_flags"><span class="hs-identifier hs-var">output_flags</span></a><span> </span><a href="Data.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a><span> </span><a href="System.Posix.Internals.html#o_WRONLY"><span class="hs-identifier hs-var">o_WRONLY</span></a><span>
</span><a name="line-208"></a><a name="rw_flags"><a href="GHC.IO.FD.html#rw_flags"><span class="hs-identifier">rw_flags</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#output_flags"><span class="hs-identifier hs-var">output_flags</span></a><span> </span><a href="Data.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a><span> </span><a href="System.Posix.Internals.html#o_RDWR"><span class="hs-identifier hs-var">o_RDWR</span></a><span>
</span><a name="line-209"></a><a name="append_flags"><a href="GHC.IO.FD.html#append_flags"><span class="hs-identifier">append_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#write_flags"><span class="hs-identifier hs-var">write_flags</span></a><span>  </span><a href="Data.Bits.html#.%7C."><span class="hs-operator hs-var">.|.</span></a><span> </span><a href="System.Posix.Internals.html#o_APPEND"><span class="hs-identifier hs-var">o_APPEND</span></a><span>
</span><a name="line-210"></a><a name="nonblock_flags"><a href="GHC.IO.FD.html#nonblock_flags"><span class="hs-identifier">nonblock_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Posix.Internals.html#o_NONBLOCK"><span class="hs-identifier hs-var">o_NONBLOCK</span></a><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-comment">-- | Make a 'FD' from an existing file descriptor.  Fails if the FD</span><span>
</span><a name="line-214"></a><span class="hs-comment">-- refers to a directory.  If the FD refers to a file, `mkFD` locks</span><span>
</span><a name="line-215"></a><span class="hs-comment">-- the file according to the Haskell 2010 single writer/multiple reader</span><span>
</span><a name="line-216"></a><span class="hs-comment">-- locking semantics (this is why we need the `IOMode` argument too).</span><span>
</span><a name="line-217"></a><span class="hs-identifier">mkFD</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-218"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.IOMode.html#IOMode"><span class="hs-identifier hs-type">IOMode</span></a><span>
</span><a name="line-219"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Device.html#IODeviceType"><span class="hs-identifier hs-type">IODeviceType</span></a><span class="hs-special">,</span><span> </span><a href="System.Posix.Types.html#CDev"><span class="hs-identifier hs-type">CDev</span></a><span class="hs-special">,</span><span> </span><a href="System.Posix.Types.html#CIno"><span class="hs-identifier hs-type">CIno</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>     </span><span class="hs-comment">-- the results of fdStat if we already know them, or we want</span><span>
</span><a name="line-221"></a><span>     </span><span class="hs-comment">-- to prevent fdToHandle_stat from doing its own stat.</span><span>
</span><a name="line-222"></a><span>     </span><span class="hs-comment">-- These are used for:</span><span>
</span><a name="line-223"></a><span>     </span><span class="hs-comment">--   - we fail if the FD refers to a directory</span><span>
</span><a name="line-224"></a><span>     </span><span class="hs-comment">--   - if the FD refers to a file, we lock it using (cdev,cino)</span><span>
</span><a name="line-225"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>   </span><span class="hs-comment">-- ^ is a socket (on Windows)</span><span>
</span><a name="line-226"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>   </span><span class="hs-comment">-- ^ is in non-blocking mode on Unix</span><span>
</span><a name="line-227"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span class="hs-special">,</span><a href="GHC.IO.Device.html#IODeviceType"><span class="hs-identifier hs-type">IODeviceType</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><a name="mkFD"><a href="GHC.IO.FD.html#mkFD"><span class="hs-identifier">mkFD</span></a></a><span> </span><a name="local-6989586621679352670"><a href="#local-6989586621679352670"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352671"><a href="#local-6989586621679352671"><span class="hs-identifier">iomode</span></a></a><span> </span><a name="local-6989586621679352672"><a href="#local-6989586621679352672"><span class="hs-identifier">mb_stat</span></a></a><span> </span><a name="local-6989586621679352673"><a href="#local-6989586621679352673"><span class="hs-identifier">is_socket</span></a></a><span> </span><a name="local-6989586621679352674"><a href="#local-6989586621679352674"><span class="hs-identifier">is_nonblock</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352673"><span class="hs-identifier hs-var">is_socket</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679352674"><span class="hs-identifier hs-var">is_nonblock</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- warning suppression</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679352676"><a href="#local-6989586621679352676"><span class="hs-identifier">fd_type</span></a></a><span class="hs-special">,</span><a name="local-6989586621679352677"><a href="#local-6989586621679352677"><span class="hs-identifier">dev</span></a></a><span class="hs-special">,</span><a name="local-6989586621679352678"><a href="#local-6989586621679352678"><span class="hs-identifier">ino</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679352672"><span class="hs-identifier hs-var">mb_stat</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-235"></a><span>          </span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Internals.html#fdStat"><span class="hs-identifier hs-var">fdStat</span></a><span> </span><a href="#local-6989586621679352670"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-236"></a><span>          </span><a href="GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621679352675"><a href="#local-6989586621679352675"><span class="hs-identifier">stat</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679352675"><span class="hs-identifier hs-var">stat</span></a><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679352679"><a href="#local-6989586621679352679"><span class="hs-identifier">write</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679352671"><span class="hs-identifier hs-var">iomode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-239"></a><span>                   </span><a href="GHC.IO.IOMode.html#ReadMode"><span class="hs-identifier hs-var">ReadMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a><span>
</span><a name="line-240"></a><span>                   </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679352676"><span class="hs-identifier hs-var">fd_type</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-243"></a><span>        </span><a href="GHC.IO.Device.html#Directory"><span class="hs-identifier hs-var">Directory</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-244"></a><span>           </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#InappropriateType"><span class="hs-identifier hs-var">InappropriateType</span></a><span> </span><span class="hs-string">&quot;openFile&quot;</span><span>
</span><a name="line-245"></a><span>                           </span><span class="hs-string">&quot;is a directory&quot;</span><span> </span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span>        </span><span class="hs-comment">-- regular files need to be locked</span><span>
</span><a name="line-248"></a><span>        </span><a href="GHC.IO.Device.html#RegularFile"><span class="hs-identifier hs-var">RegularFile</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-249"></a><span>           </span><span class="hs-comment">-- On Windows we need an additional call to get a unique device id</span><span>
</span><a name="line-250"></a><span>           </span><span class="hs-comment">-- and inode, since fstat just returns 0 for both.</span><span>
</span><a name="line-251"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621679352680"><a href="#local-6989586621679352680"><span class="hs-identifier">unique_dev</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679352681"><a href="#local-6989586621679352681"><span class="hs-identifier">unique_ino</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#getUniqueFileInfo"><span class="hs-identifier hs-var">getUniqueFileInfo</span></a><span> </span><a href="#local-6989586621679352670"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352677"><span class="hs-identifier hs-var">dev</span></a><span> </span><a href="#local-6989586621679352678"><span class="hs-identifier hs-var">ino</span></a><span>
</span><a name="line-252"></a><span>           </span><a name="local-6989586621679352682"><a href="#local-6989586621679352682"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#lockFile"><span class="hs-identifier hs-var">lockFile</span></a><span> </span><a href="#local-6989586621679352670"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352680"><span class="hs-identifier hs-var">unique_dev</span></a><span> </span><a href="#local-6989586621679352681"><span class="hs-identifier hs-var">unique_ino</span></a><span> </span><span class="hs-special">(</span><a href="Foreign.Marshal.Utils.html#fromBool"><span class="hs-identifier hs-var">fromBool</span></a><span> </span><a href="#local-6989586621679352679"><span class="hs-identifier hs-var">write</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>           </span><a href="GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352682"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>  </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-254"></a><span>                </span><a href="GHC.IO.Exception.html#ioException"><span class="hs-identifier hs-var">ioException</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.Exception.html#IOError"><span class="hs-identifier hs-var">IOError</span></a><span> </span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.IO.Exception.html#ResourceBusy"><span class="hs-identifier hs-var">ResourceBusy</span></a><span> </span><span class="hs-string">&quot;openFile&quot;</span><span>
</span><a name="line-255"></a><span>                                   </span><span class="hs-string">&quot;file is locked&quot;</span><span> </span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span>        </span><a name="local-6989586621679352683"><a href="#local-6989586621679352683"><span class="hs-identifier">_other_type</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>    </span><span class="hs-identifier">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">not</span><span> </span><span class="hs-identifier">is_socket</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">setmode</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">True</span><span> </span><span class="hs-operator">&gt;&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-263"></a><span>    </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-var">FD</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352670"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">,</span><span>
</span><a name="line-264"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS)
</span><span>                </span><span class="hs-identifier">fdIsNonBlocking</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Enum.html#fromEnum"><span class="hs-identifier hs-var">fromEnum</span></a><span> </span><a href="#local-6989586621679352674"><span class="hs-identifier hs-var">is_nonblock</span></a><span>
</span><a name="line-266"></a><span class="hs-cpp">#else
</span><span>                </span><span class="hs-identifier">fdIsSocket_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-identifier">is_socket</span><span>
</span><a name="line-268"></a><span class="hs-cpp">#endif
</span><span class="">              },
            fd_type)

getUniqueFileInfo :: CInt -&gt; CDev -&gt; CIno -&gt; IO (Word64, Word64)
</span><span class="hs-cpp">#if !defined(mingw32_HOST_OS)
</span><a name="getUniqueFileInfo"><a href="GHC.IO.FD.html#getUniqueFileInfo"><span class="hs-identifier">getUniqueFileInfo</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679352684"><a href="#local-6989586621679352684"><span class="hs-identifier">dev</span></a></a><span> </span><a name="local-6989586621679352685"><a href="#local-6989586621679352685"><span class="hs-identifier">ino</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352684"><span class="hs-identifier hs-var">dev</span></a><span class="hs-special">,</span><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352685"><span class="hs-identifier hs-var">ino</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">getUniqueFileInfo</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-277"></a><span>  </span><span class="hs-identifier">with</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">devptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-278"></a><span>    </span><span class="hs-identifier">with</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">inoptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-279"></a><span>      </span><span class="hs-identifier">c_getUniqueFileInfo</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">devptr</span><span> </span><span class="hs-identifier">inoptr</span><span>
</span><a name="line-280"></a><span>      </span><span class="hs-identifier">liftM2</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">devptr</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">inoptr</span><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-283"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;__hscore_setmode&quot;</span><span>
</span><a name="line-285"></a><span>  </span><span class="hs-identifier">setmode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-286"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-289"></a><span class="hs-comment">-- Standard file descriptors</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-identifier">stdFD</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span>
</span><a name="line-292"></a><a name="stdFD"><a href="GHC.IO.FD.html#stdFD"><span class="hs-identifier">stdFD</span></a></a><span> </span><a name="local-6989586621679352686"><a href="#local-6989586621679352686"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-var">FD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352686"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">,</span><span>
</span><a name="line-293"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>                </span><span class="hs-identifier">fdIsSocket_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-295"></a><span class="hs-cpp">#else
</span><span>                </span><span class="hs-identifier">fdIsNonBlocking</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-297"></a><span>   </span><span class="hs-comment">-- We don't set non-blocking mode on standard handles, because it may</span><span>
</span><a name="line-298"></a><span>   </span><span class="hs-comment">-- confuse other applications attached to the same TTY/pipe</span><span>
</span><a name="line-299"></a><span>   </span><span class="hs-comment">-- see Note [nonblock]</span><span>
</span><a name="line-300"></a><span class="hs-cpp">#endif
</span><span class="">                }

stdin, stdout, stderr :: FD
stdin  = stdFD 0
stdout = stdFD 1
stderr = stdFD 2

-- -----------------------------------------------------------------------------
-- Operations on file descriptors

close :: FD -&gt; IO ()
close fd =
  do let closer realFd =
           throwErrnoIfMinus1Retry_ &quot;GHC.IO.FD.close&quot; $
</span><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>           </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-317"></a><span>             </span><span class="hs-identifier">c_closesocket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">realFd</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>           </span><span class="hs-keyword">else</span><span>
</span><a name="line-319"></a><span class="hs-cpp">#endif
</span><span>             </span><a href="System.Posix.Internals.html#c_close"><span class="hs-identifier hs-var">c_close</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352689"><span class="hs-identifier hs-var">realFd</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span>     </span><span class="hs-comment">-- release the lock *first*, because otherwise if we're preempted</span><span>
</span><a name="line-323"></a><span>     </span><span class="hs-comment">-- after closing but before releasing, the FD may have been reused.</span><span>
</span><a name="line-324"></a><span>     </span><span class="hs-comment">-- (#7646)</span><span>
</span><a name="line-325"></a><span>     </span><a href="GHC.IO.FD.html#release"><span class="hs-identifier hs-var">release</span></a><span> </span><a href="#local-6989586621679352687"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span>     </span><a href="GHC.Conc.IO.html#closeFdWith"><span class="hs-identifier hs-var">closeFdWith</span></a><span> </span><a href="#local-6989586621679352688"><span class="hs-identifier hs-var">closer</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352687"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-identifier">release</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-330"></a><a name="release"><a href="GHC.IO.FD.html#release"><span class="hs-identifier">release</span></a></a><span> </span><a name="local-6989586621679352690"><a href="#local-6989586621679352690"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#unlockFile"><span class="hs-identifier hs-var">unlockFile</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352690"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>                </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">WINDOWS_CCONV</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;HsBase.h closesocket&quot;</span><span>
</span><a name="line-335"></a><span>   </span><span class="hs-identifier">c_closesocket</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-336"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-338"></a><span class="hs-identifier">isSeekable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-339"></a><a name="isSeekable"><a href="GHC.IO.FD.html#isSeekable"><span class="hs-identifier">isSeekable</span></a></a><span> </span><a name="local-6989586621679352691"><a href="#local-6989586621679352691"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-340"></a><span>  </span><a name="local-6989586621679352692"><a href="#local-6989586621679352692"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#devType"><span class="hs-identifier hs-var">devType</span></a><span> </span><a href="#local-6989586621679352691"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-341"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352692"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.IO.Device.html#RegularFile"><span class="hs-identifier hs-var">RegularFile</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a><span> </span><a href="#local-6989586621679352692"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="GHC.IO.Device.html#RawDevice"><span class="hs-identifier hs-var">RawDevice</span></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-identifier">seek</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.Device.html#SeekMode"><span class="hs-identifier hs-type">SeekMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../integer-gmp/src/%{MODULE}.html#%{NAME}/GHC.Integer.Type.html#Integer"><span class="hs-identifier hs-type">Integer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><a name="seek"><a href="GHC.IO.FD.html#seek"><span class="hs-identifier">seek</span></a></a><span> </span><a name="local-6989586621679352693"><a href="#local-6989586621679352693"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352694"><a href="#local-6989586621679352694"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679352695"><a href="#local-6989586621679352695"><span class="hs-identifier">off</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-345"></a><span>  </span><a href="Foreign.C.Error.html#throwErrnoIfMinus1Retry_"><span class="hs-identifier hs-var">throwErrnoIfMinus1Retry_</span></a><span> </span><span class="hs-string">&quot;seek&quot;</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-346"></a><span>     </span><a href="System.Posix.Internals.html#c_lseek"><span class="hs-identifier hs-var">c_lseek</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352693"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352695"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352696"><span class="hs-identifier hs-var">seektype</span></a><span>
</span><a name="line-347"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-348"></a><span>    </span><span class="hs-identifier">seektype</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-349"></a><span>    </span><a name="local-6989586621679352696"><a href="#local-6989586621679352696"><span class="hs-identifier">seektype</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679352694"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-350"></a><span>                   </span><a href="GHC.IO.Device.html#AbsoluteSeek"><span class="hs-identifier hs-var">AbsoluteSeek</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Internals.html#sEEK_SET"><span class="hs-identifier hs-var">sEEK_SET</span></a><span>
</span><a name="line-351"></a><span>                   </span><a href="GHC.IO.Device.html#RelativeSeek"><span class="hs-identifier hs-var">RelativeSeek</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Internals.html#sEEK_CUR"><span class="hs-identifier hs-var">sEEK_CUR</span></a><span>
</span><a name="line-352"></a><span>                   </span><a href="GHC.IO.Device.html#SeekFromEnd"><span class="hs-identifier hs-var">SeekFromEnd</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.Posix.Internals.html#sEEK_END"><span class="hs-identifier hs-var">sEEK_END</span></a><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span class="hs-identifier">tell</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../integer-gmp/src/%{MODULE}.html#%{NAME}/GHC.Integer.Type.html#Integer"><span class="hs-identifier hs-type">Integer</span></a><span>
</span><a name="line-355"></a><a name="tell"><a href="GHC.IO.FD.html#tell"><span class="hs-identifier">tell</span></a></a><span> </span><a name="local-6989586621679352697"><a href="#local-6989586621679352697"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-356"></a><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span class="hs-special">`</span><span>
</span><a name="line-357"></a><span>   </span><span class="hs-special">(</span><a href="Foreign.C.Error.html#throwErrnoIfMinus1Retry"><span class="hs-identifier hs-var">throwErrnoIfMinus1Retry</span></a><span> </span><span class="hs-string">&quot;hGetPosn&quot;</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-358"></a><span>      </span><a href="System.Posix.Internals.html#c_lseek"><span class="hs-identifier hs-var">c_lseek</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352697"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><a href="System.Posix.Internals.html#sEEK_CUR"><span class="hs-identifier hs-var">sEEK_CUR</span></a><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span class="hs-identifier">getSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../integer-gmp/src/%{MODULE}.html#%{NAME}/GHC.Integer.Type.html#Integer"><span class="hs-identifier hs-type">Integer</span></a><span>
</span><a name="line-361"></a><a name="getSize"><a href="GHC.IO.FD.html#getSize"><span class="hs-identifier">getSize</span></a></a><span> </span><a name="local-6989586621679352698"><a href="#local-6989586621679352698"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Posix.Internals.html#fdFileSize"><span class="hs-identifier hs-var">fdFileSize</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352698"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-identifier">setSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../integer-gmp/src/%{MODULE}.html#%{NAME}/GHC.Integer.Type.html#Integer"><span class="hs-identifier hs-type">Integer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-364"></a><a name="setSize"><a href="GHC.IO.FD.html#setSize"><span class="hs-identifier">setSize</span></a></a><span> </span><a name="local-6989586621679352699"><a href="#local-6989586621679352699"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352700"><a href="#local-6989586621679352700"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-365"></a><span>  </span><a href="Foreign.C.Error.html#throwErrnoIf_"><span class="hs-identifier hs-var">throwErrnoIf_</span></a><span> </span><span class="hs-special">(</span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;GHC.IO.FD.setSize&quot;</span><span>  </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-366"></a><span>     </span><a href="System.Posix.Internals.html#c_ftruncate"><span class="hs-identifier hs-var">c_ftruncate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352699"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352700"><span class="hs-identifier hs-var">size</span></a><span class="hs-special">)</span><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span class="hs-identifier">devType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.Device.html#IODeviceType"><span class="hs-identifier hs-type">IODeviceType</span></a><span>
</span><a name="line-369"></a><a name="devType"><a href="GHC.IO.FD.html#devType"><span class="hs-identifier">devType</span></a></a><span> </span><a name="local-6989586621679352701"><a href="#local-6989586621679352701"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679352702"><a href="#local-6989586621679352702"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.Posix.Internals.html#fdStat"><span class="hs-identifier hs-var">fdStat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352701"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679352702"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span class="hs-identifier">dup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span>
</span><a name="line-372"></a><a name="dup"><a href="GHC.IO.FD.html#dup"><span class="hs-identifier">dup</span></a></a><span> </span><a name="local-6989586621679352703"><a href="#local-6989586621679352703"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-373"></a><span>  </span><a name="local-6989586621679352704"><a href="#local-6989586621679352704"><span class="hs-identifier">newfd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.C.Error.html#throwErrnoIfMinus1"><span class="hs-identifier hs-var">throwErrnoIfMinus1</span></a><span> </span><span class="hs-string">&quot;GHC.IO.FD.dup&quot;</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="System.Posix.Internals.html#c_dup"><span class="hs-identifier hs-var">c_dup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352703"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679352703"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352704"><span class="hs-identifier hs-var">newfd</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span class="hs-identifier">dup2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span>
</span><a name="line-377"></a><a name="dup2"><a href="GHC.IO.FD.html#dup2"><span class="hs-identifier">dup2</span></a></a><span> </span><a name="local-6989586621679352705"><a href="#local-6989586621679352705"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352706"><a href="#local-6989586621679352706"><span class="hs-identifier">fdto</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-378"></a><span>  </span><span class="hs-comment">-- Windows' dup2 does not return the new descriptor, unlike Unix</span><span>
</span><a name="line-379"></a><span>  </span><a href="Foreign.C.Error.html#throwErrnoIfMinus1_"><span class="hs-identifier hs-var">throwErrnoIfMinus1_</span></a><span> </span><span class="hs-string">&quot;GHC.IO.FD.dup2&quot;</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-380"></a><span>    </span><a href="System.Posix.Internals.html#c_dup2"><span class="hs-identifier hs-var">c_dup2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352705"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352706"><span class="hs-identifier hs-var">fdto</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679352705"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352706"><span class="hs-identifier hs-var">fdto</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- original FD, with the new fdFD</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-identifier">setNonBlockingMode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span>
</span><a name="line-384"></a><a name="setNonBlockingMode"><a href="GHC.IO.FD.html#setNonBlockingMode"><span class="hs-identifier">setNonBlockingMode</span></a></a><span> </span><a name="local-6989586621679352707"><a href="#local-6989586621679352707"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352708"><a href="#local-6989586621679352708"><span class="hs-identifier">set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-385"></a><span>  </span><a href="System.Posix.Internals.html#setNonBlockingFD"><span class="hs-identifier hs-var">setNonBlockingFD</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352707"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352708"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-386"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>  </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">fd</span><span>
</span><a name="line-388"></a><span class="hs-cpp">#else
</span><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679352707"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdIsNonBlocking</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Enum.html#fromEnum"><span class="hs-identifier hs-var">fromEnum</span></a><span> </span><a href="#local-6989586621679352708"><span class="hs-identifier hs-var">set</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-390"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-392"></a><span class="hs-identifier">ready</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-393"></a><a name="ready"><a href="GHC.IO.FD.html#ready"><span class="hs-identifier">ready</span></a></a><span> </span><a name="local-6989586621679352709"><a href="#local-6989586621679352709"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352710"><a href="#local-6989586621679352710"><span class="hs-identifier">write</span></a></a><span> </span><a name="local-6989586621679352711"><a href="#local-6989586621679352711"><span class="hs-identifier">msecs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-394"></a><span>  </span><a name="local-6989586621679352712"><a href="#local-6989586621679352712"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.C.Error.html#throwErrnoIfMinus1Retry"><span class="hs-identifier hs-var">throwErrnoIfMinus1Retry</span></a><span> </span><span class="hs-string">&quot;GHC.IO.FD.ready&quot;</span><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-395"></a><span>          </span><a href="GHC.IO.FD.html#fdReady"><span class="hs-identifier hs-var">fdReady</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352709"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="GHC.Enum.html#fromEnum"><span class="hs-identifier hs-var">fromEnum</span></a><span> </span><a href="GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-6989586621679352710"><span class="hs-identifier hs-var">write</span></a><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>                            </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352711"><span class="hs-identifier hs-var">msecs</span></a><span class="hs-special">)</span><span>
</span><a name="line-397"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>                          </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span class="hs-cpp">#else
</span><span>                          </span><span class="hs-number">0</span><span>
</span><a name="line-401"></a><span class="hs-cpp">#endif
</span><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Enum.html#toEnum"><span class="hs-identifier hs-var">toEnum</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352712"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">safe</span><span> </span><span class="hs-string">&quot;fdReady&quot;</span><span>
</span><a name="line-405"></a><span>  </span><span class="hs-identifier">fdReady</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CBool"><span class="hs-identifier hs-type">CBool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Int.html#Int64"><span class="hs-identifier hs-type">Int64</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CBool"><span class="hs-identifier hs-type">CBool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-408"></a><span class="hs-comment">-- Terminal-related stuff</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-identifier">isTerminal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-411"></a><a name="isTerminal"><a href="GHC.IO.FD.html#isTerminal"><span class="hs-identifier">isTerminal</span></a></a><span> </span><a name="local-6989586621679352713"><a href="#local-6989586621679352713"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-412"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">False</span><span>
</span><a name="line-414"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">is_console</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">return</span><span class="hs-operator">.</span><span class="hs-identifier">toBool</span><span>
</span><a name="line-415"></a><span class="hs-cpp">#else
</span><span>    </span><a href="System.Posix.Internals.html#c_isatty"><span class="hs-identifier hs-var">c_isatty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352713"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><a href="GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><a href="Foreign.Marshal.Utils.html#toBool"><span class="hs-identifier hs-var">toBool</span></a><span>
</span><a name="line-417"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-419"></a><span class="hs-identifier">setEcho</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-420"></a><a name="setEcho"><a href="GHC.IO.FD.html#setEcho"><span class="hs-identifier">setEcho</span></a></a><span> </span><a name="local-6989586621679352714"><a href="#local-6989586621679352714"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352715"><a href="#local-6989586621679352715"><span class="hs-identifier">on</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Posix.Internals.html#setEcho"><span class="hs-identifier hs-var">System.Posix.Internals.setEcho</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352714"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352715"><span class="hs-identifier hs-var">on</span></a><span>
</span><a name="line-421"></a><span>
</span><a name="line-422"></a><span class="hs-identifier">getEcho</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-423"></a><a name="getEcho"><a href="GHC.IO.FD.html#getEcho"><span class="hs-identifier">getEcho</span></a></a><span> </span><a name="local-6989586621679352716"><a href="#local-6989586621679352716"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Posix.Internals.html#getEcho"><span class="hs-identifier hs-var">System.Posix.Internals.getEcho</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352716"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span class="hs-identifier">setRaw</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-426"></a><a name="setRaw"><a href="GHC.IO.FD.html#setRaw"><span class="hs-identifier">setRaw</span></a></a><span> </span><a name="local-6989586621679352717"><a href="#local-6989586621679352717"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352718"><a href="#local-6989586621679352718"><span class="hs-identifier">raw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="System.Posix.Internals.html#setCooked"><span class="hs-identifier hs-var">System.Posix.Internals.setCooked</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352717"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a><span> </span><a href="#local-6989586621679352718"><span class="hs-identifier hs-var">raw</span></a><span class="hs-special">)</span><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-429"></a><span class="hs-comment">-- Reading and Writing</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-identifier">fdRead</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-432"></a><a name="fdRead"><a href="GHC.IO.FD.html#fdRead"><span class="hs-identifier">fdRead</span></a></a><span> </span><a name="local-6989586621679352719"><a href="#local-6989586621679352719"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352720"><a href="#local-6989586621679352720"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621679352721"><a href="#local-6989586621679352721"><span class="hs-identifier">bytes</span></a></a><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679352722"><a href="#local-6989586621679352722"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#readRawBufferPtr"><span class="hs-identifier hs-var">readRawBufferPtr</span></a><span> </span><span class="hs-string">&quot;GHC.IO.FD.fdRead&quot;</span><span> </span><a href="#local-6989586621679352719"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352720"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352721"><span class="hs-identifier hs-var">bytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352722"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span class="hs-identifier">fdReadNonBlocking</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span class="hs-special">)</span><span>
</span><a name="line-437"></a><a name="fdReadNonBlocking"><a href="GHC.IO.FD.html#fdReadNonBlocking"><span class="hs-identifier">fdReadNonBlocking</span></a></a><span> </span><a name="local-6989586621679352723"><a href="#local-6989586621679352723"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352724"><a href="#local-6989586621679352724"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621679352725"><a href="#local-6989586621679352725"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-438"></a><span>  </span><a name="local-6989586621679352726"><a href="#local-6989586621679352726"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#readRawBufferPtrNoBlock"><span class="hs-identifier hs-var">readRawBufferPtrNoBlock</span></a><span> </span><span class="hs-string">&quot;GHC.IO.FD.fdReadNonBlocking&quot;</span><span> </span><a href="#local-6989586621679352723"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352724"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-439"></a><span>           </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352725"><span class="hs-identifier hs-var">bytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352726"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-441"></a><span>    </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-442"></a><span>    </span><a name="local-6989586621679352727"><a href="#local-6989586621679352727"><span class="hs-identifier">n</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621679352727"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span class="hs-identifier">fdWrite</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-446"></a><a name="fdWrite"><a href="GHC.IO.FD.html#fdWrite"><span class="hs-identifier">fdWrite</span></a></a><span> </span><a name="local-6989586621679352728"><a href="#local-6989586621679352728"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352729"><a href="#local-6989586621679352729"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621679352730"><a href="#local-6989586621679352730"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-447"></a><span>  </span><a name="local-6989586621679352731"><a href="#local-6989586621679352731"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#writeRawBufferPtr"><span class="hs-identifier hs-var">writeRawBufferPtr</span></a><span> </span><span class="hs-string">&quot;GHC.IO.FD.fdWrite&quot;</span><span> </span><a href="#local-6989586621679352728"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352729"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352730"><span class="hs-identifier hs-var">bytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679352732"><a href="#local-6989586621679352732"><span class="hs-identifier">res'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352731"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-449"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679352732"><span class="hs-identifier hs-var">res'</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a><span> </span><a href="#local-6989586621679352730"><span class="hs-identifier hs-var">bytes</span></a><span>
</span><a name="line-450"></a><span>     </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.FD.html#fdWrite"><span class="hs-identifier hs-var">fdWrite</span></a><span> </span><a href="#local-6989586621679352728"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352729"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679352732"><span class="hs-identifier hs-var">res'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352730"><span class="hs-identifier hs-var">bytes</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679352732"><span class="hs-identifier hs-var">res'</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>     </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span class="hs-comment">-- XXX ToDo: this isn't non-blocking</span><span>
</span><a name="line-454"></a><span class="hs-identifier">fdWriteNonBlocking</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-455"></a><a name="fdWriteNonBlocking"><a href="GHC.IO.FD.html#fdWriteNonBlocking"><span class="hs-identifier">fdWriteNonBlocking</span></a></a><span> </span><a name="local-6989586621679352733"><a href="#local-6989586621679352733"><span class="hs-identifier">fd</span></a></a><span> </span><a name="local-6989586621679352734"><a href="#local-6989586621679352734"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621679352735"><a href="#local-6989586621679352735"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-456"></a><span>  </span><a name="local-6989586621679352736"><a href="#local-6989586621679352736"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#writeRawBufferPtrNoBlock"><span class="hs-identifier hs-var">writeRawBufferPtrNoBlock</span></a><span> </span><span class="hs-string">&quot;GHC.IO.FD.fdWriteNonBlocking&quot;</span><span> </span><a href="#local-6989586621679352733"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="#local-6989586621679352734"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-457"></a><span>            </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352735"><span class="hs-identifier hs-var">bytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>  </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352736"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-461"></a><span class="hs-comment">-- FD operations</span><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span class="hs-comment">-- Low level routines for reading/writing to (raw)buffers:</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS)
</span><span>
</span><a name="line-467"></a><span class="hs-comment">{-
NOTE [nonblock]:

Unix has broken semantics when it comes to non-blocking I/O: you can
set the O_NONBLOCK flag on an FD, but it applies to the all other FDs
attached to the same underlying file, pipe or TTY; there's no way to
have private non-blocking behaviour for an FD.  See bug #724.

We fix this by only setting O_NONBLOCK on FDs that we create; FDs that
come from external sources or are exposed externally are left in
blocking mode.  This solution has some problems though.  We can't
completely simulate a non-blocking read without O_NONBLOCK: several
cases are wrong here.  The cases that are wrong:

  * reading/writing to a blocking FD in non-threaded mode.
    In threaded mode, we just make a safe call to read().
    In non-threaded mode we call select() before attempting to read,
    but that leaves a small race window where the data can be read
    from the file descriptor before we issue our blocking read().
  * readRawBufferNoBlock for a blocking FD

NOTE [2363]:

In the threaded RTS we could just make safe calls to read()/write()
for file descriptors in blocking mode without worrying about blocking
other threads, but the problem with this is that the thread will be
uninterruptible while it is blocked in the foreign call.  See #2363.
So now we always call fdReady() before reading, and if fdReady
indicates that there's no data, we call threadWaitRead.

-}</span><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span class="hs-identifier">readRawBufferPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CSize"><span class="hs-identifier hs-type">CSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-500"></a><a name="readRawBufferPtr"><a href="GHC.IO.FD.html#readRawBufferPtr"><span class="hs-identifier">readRawBufferPtr</span></a></a><span> </span><a name="local-6989586621679352737"><a href="#local-6989586621679352737"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352738"><a href="#local-6989586621679352738"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352739"><a href="#local-6989586621679352739"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352740"><a href="#local-6989586621679352740"><span class="hs-identifier">off</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352741"><a href="#local-6989586621679352741"><span class="hs-identifier">len</span></a></a><span>
</span><a name="line-501"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.IO.FD.html#isNonBlocking"><span class="hs-identifier hs-var">isNonBlocking</span></a><span> </span><a href="#local-6989586621679352738"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352744"><span class="hs-identifier hs-var">unsafe_read</span></a><span> </span><span class="hs-comment">-- unsafe is ok, it can't block</span><span>
</span><a name="line-502"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679352747"><a href="#local-6989586621679352747"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.C.Error.html#throwErrnoIfMinus1"><span class="hs-identifier hs-var">throwErrnoIfMinus1</span></a><span> </span><a href="#local-6989586621679352737"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-503"></a><span>                                </span><span class="hs-special">(</span><a href="GHC.IO.FD.html#unsafe_fdReady"><span class="hs-identifier hs-var">unsafe_fdReady</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352738"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-504"></a><span>                      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679352747"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-505"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679352743"><span class="hs-identifier hs-var">read</span></a><span>
</span><a name="line-506"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="GHC.Conc.IO.html#threadWaitRead"><span class="hs-identifier hs-var">threadWaitRead</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352738"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="#local-6989586621679352743"><span class="hs-identifier hs-var">read</span></a><span>
</span><a name="line-507"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-508"></a><span>    </span><a name="local-6989586621679352742"><a href="#local-6989586621679352742"><span class="hs-identifier">do_read</span></a></a><span> </span><a name="local-6989586621679352746"><a href="#local-6989586621679352746"><span class="hs-identifier">call</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span class="hs-special">`</span><span>
</span><a name="line-509"></a><span>                      </span><a href="Foreign.C.Error.html#throwErrnoIfMinus1RetryMayBlock"><span class="hs-identifier hs-var">throwErrnoIfMinus1RetryMayBlock</span></a><span> </span><a href="#local-6989586621679352737"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621679352746"><span class="hs-identifier hs-var">call</span></a><span>
</span><a name="line-510"></a><span>                            </span><span class="hs-special">(</span><a href="GHC.Conc.IO.html#threadWaitRead"><span class="hs-identifier hs-var">threadWaitRead</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352738"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>    </span><a name="local-6989586621679352743"><a href="#local-6989586621679352743"><span class="hs-identifier">read</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.FD.html#threaded"><span class="hs-identifier hs-var">threaded</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679352745"><span class="hs-identifier hs-var">safe_read</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679352744"><span class="hs-identifier hs-var">unsafe_read</span></a><span>
</span><a name="line-512"></a><span>    </span><a name="local-6989586621679352744"><a href="#local-6989586621679352744"><span class="hs-identifier">unsafe_read</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352742"><span class="hs-identifier hs-var">do_read</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#c_read"><span class="hs-identifier hs-var">c_read</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352738"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352739"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679352740"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352741"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>    </span><a name="local-6989586621679352745"><a href="#local-6989586621679352745"><span class="hs-identifier">safe_read</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352742"><span class="hs-identifier hs-var">do_read</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#c_safe_read"><span class="hs-identifier hs-var">c_safe_read</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352738"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352739"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679352740"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352741"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span class="hs-comment">-- return: -1 indicates EOF, &gt;=0 is bytes read</span><span>
</span><a name="line-516"></a><span class="hs-identifier">readRawBufferPtrNoBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CSize"><span class="hs-identifier hs-type">CSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span>
</span><a name="line-517"></a><a name="readRawBufferPtrNoBlock"><a href="GHC.IO.FD.html#readRawBufferPtrNoBlock"><span class="hs-identifier">readRawBufferPtrNoBlock</span></a></a><span> </span><a name="local-6989586621679352748"><a href="#local-6989586621679352748"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352749"><a href="#local-6989586621679352749"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352750"><a href="#local-6989586621679352750"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352751"><a href="#local-6989586621679352751"><span class="hs-identifier">off</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352752"><a href="#local-6989586621679352752"><span class="hs-identifier">len</span></a></a><span>
</span><a name="line-518"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.IO.FD.html#isNonBlocking"><span class="hs-identifier hs-var">isNonBlocking</span></a><span> </span><a href="#local-6989586621679352749"><span class="hs-identifier hs-var">fd</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352754"><span class="hs-identifier hs-var">unsafe_read</span></a><span> </span><span class="hs-comment">-- unsafe is ok, it can't block</span><span>
</span><a name="line-519"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679352759"><a href="#local-6989586621679352759"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#unsafe_fdReady"><span class="hs-identifier hs-var">unsafe_fdReady</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352749"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-520"></a><span>                      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679352759"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679352755"><span class="hs-identifier hs-var">safe_read</span></a><span>
</span><a name="line-521"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-522"></a><span>       </span><span class="hs-comment">-- XXX see note [nonblock]</span><span>
</span><a name="line-523"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-524"></a><span>   </span><a name="local-6989586621679352753"><a href="#local-6989586621679352753"><span class="hs-identifier">do_read</span></a></a><span> </span><a name="local-6989586621679352756"><a href="#local-6989586621679352756"><span class="hs-identifier">call</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679352757"><a href="#local-6989586621679352757"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#throwErrnoIfMinus1RetryOnBlock"><span class="hs-identifier hs-var">throwErrnoIfMinus1RetryOnBlock</span></a><span> </span><a href="#local-6989586621679352748"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621679352756"><span class="hs-identifier hs-var">call</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span>                     </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679352757"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-526"></a><span>                       </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-527"></a><span>                       </span><span class="hs-number">0</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>                       </span><a name="local-6989586621679352758"><a href="#local-6989586621679352758"><span class="hs-identifier">n</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352758"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>   </span><a name="local-6989586621679352754"><a href="#local-6989586621679352754"><span class="hs-identifier">unsafe_read</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352753"><span class="hs-identifier hs-var">do_read</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#c_read"><span class="hs-identifier hs-var">c_read</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352749"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352750"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679352751"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352752"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-530"></a><span>   </span><a name="local-6989586621679352755"><a href="#local-6989586621679352755"><span class="hs-identifier">safe_read</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352753"><span class="hs-identifier hs-var">do_read</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#c_safe_read"><span class="hs-identifier hs-var">c_safe_read</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352749"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352750"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679352751"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352752"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span class="hs-identifier">writeRawBufferPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CSize"><span class="hs-identifier hs-type">CSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-533"></a><a name="writeRawBufferPtr"><a href="GHC.IO.FD.html#writeRawBufferPtr"><span class="hs-identifier">writeRawBufferPtr</span></a></a><span> </span><a name="local-6989586621679352760"><a href="#local-6989586621679352760"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352761"><a href="#local-6989586621679352761"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352762"><a href="#local-6989586621679352762"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352763"><a href="#local-6989586621679352763"><span class="hs-identifier">off</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352764"><a href="#local-6989586621679352764"><span class="hs-identifier">len</span></a></a><span>
</span><a name="line-534"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.IO.FD.html#isNonBlocking"><span class="hs-identifier hs-var">isNonBlocking</span></a><span> </span><a href="#local-6989586621679352761"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352767"><span class="hs-identifier hs-var">unsafe_write</span></a><span> </span><span class="hs-comment">-- unsafe is ok, it can't block</span><span>
</span><a name="line-535"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679352770"><a href="#local-6989586621679352770"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#unsafe_fdReady"><span class="hs-identifier hs-var">unsafe_fdReady</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352761"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-536"></a><span>                     </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679352770"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-537"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679352766"><span class="hs-identifier hs-var">write</span></a><span>
</span><a name="line-538"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="GHC.Conc.IO.html#threadWaitWrite"><span class="hs-identifier hs-var">threadWaitWrite</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352761"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="#local-6989586621679352766"><span class="hs-identifier hs-var">write</span></a><span>
</span><a name="line-539"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-540"></a><span>    </span><a name="local-6989586621679352765"><a href="#local-6989586621679352765"><span class="hs-identifier">do_write</span></a></a><span> </span><a name="local-6989586621679352769"><a href="#local-6989586621679352769"><span class="hs-identifier">call</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span class="hs-special">`</span><span>
</span><a name="line-541"></a><span>                      </span><a href="Foreign.C.Error.html#throwErrnoIfMinus1RetryMayBlock"><span class="hs-identifier hs-var">throwErrnoIfMinus1RetryMayBlock</span></a><span> </span><a href="#local-6989586621679352760"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621679352769"><span class="hs-identifier hs-var">call</span></a><span>
</span><a name="line-542"></a><span>                        </span><span class="hs-special">(</span><a href="GHC.Conc.IO.html#threadWaitWrite"><span class="hs-identifier hs-var">threadWaitWrite</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352761"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>    </span><a name="local-6989586621679352766"><a href="#local-6989586621679352766"><span class="hs-identifier">write</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.FD.html#threaded"><span class="hs-identifier hs-var">threaded</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679352768"><span class="hs-identifier hs-var">safe_write</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679352767"><span class="hs-identifier hs-var">unsafe_write</span></a><span>
</span><a name="line-544"></a><span>    </span><a name="local-6989586621679352767"><a href="#local-6989586621679352767"><span class="hs-identifier">unsafe_write</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352765"><span class="hs-identifier hs-var">do_write</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#c_write"><span class="hs-identifier hs-var">c_write</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352761"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352762"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679352763"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352764"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-545"></a><span>    </span><a name="local-6989586621679352768"><a href="#local-6989586621679352768"><span class="hs-identifier">safe_write</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352765"><span class="hs-identifier hs-var">do_write</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#c_safe_write"><span class="hs-identifier hs-var">c_safe_write</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352761"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352762"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679352763"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352764"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span class="hs-identifier">writeRawBufferPtrNoBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a><span> </span><a href="GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CSize"><span class="hs-identifier hs-type">CSize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-548"></a><a name="writeRawBufferPtrNoBlock"><a href="GHC.IO.FD.html#writeRawBufferPtrNoBlock"><span class="hs-identifier">writeRawBufferPtrNoBlock</span></a></a><span> </span><a name="local-6989586621679352771"><a href="#local-6989586621679352771"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352772"><a href="#local-6989586621679352772"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352773"><a href="#local-6989586621679352773"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352774"><a href="#local-6989586621679352774"><span class="hs-identifier">off</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679352775"><a href="#local-6989586621679352775"><span class="hs-identifier">len</span></a></a><span>
</span><a name="line-549"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.IO.FD.html#isNonBlocking"><span class="hs-identifier hs-var">isNonBlocking</span></a><span> </span><a href="#local-6989586621679352772"><span class="hs-identifier hs-var">fd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352778"><span class="hs-identifier hs-var">unsafe_write</span></a><span> </span><span class="hs-comment">-- unsafe is ok, it can't block</span><span>
</span><a name="line-550"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679352783"><a href="#local-6989586621679352783"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#unsafe_fdReady"><span class="hs-identifier hs-var">unsafe_fdReady</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352772"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-551"></a><span>                     </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679352783"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679352777"><span class="hs-identifier hs-var">write</span></a><span>
</span><a name="line-552"></a><span>                               </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-553"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-554"></a><span>    </span><a name="local-6989586621679352776"><a href="#local-6989586621679352776"><span class="hs-identifier">do_write</span></a></a><span> </span><a name="local-6989586621679352780"><a href="#local-6989586621679352780"><span class="hs-identifier">call</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679352781"><a href="#local-6989586621679352781"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHC.IO.FD.html#throwErrnoIfMinus1RetryOnBlock"><span class="hs-identifier hs-var">throwErrnoIfMinus1RetryOnBlock</span></a><span> </span><a href="#local-6989586621679352771"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621679352780"><span class="hs-identifier hs-var">call</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-555"></a><span>                       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679352781"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-556"></a><span>                         </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-557"></a><span>                         </span><a name="local-6989586621679352782"><a href="#local-6989586621679352782"><span class="hs-identifier">n</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621679352782"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>    </span><a name="local-6989586621679352777"><a href="#local-6989586621679352777"><span class="hs-identifier">write</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="GHC.IO.FD.html#threaded"><span class="hs-identifier hs-var">threaded</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679352779"><span class="hs-identifier hs-var">safe_write</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679352778"><span class="hs-identifier hs-var">unsafe_write</span></a><span>
</span><a name="line-559"></a><span>    </span><a name="local-6989586621679352778"><a href="#local-6989586621679352778"><span class="hs-identifier">unsafe_write</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352776"><span class="hs-identifier hs-var">do_write</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#c_write"><span class="hs-identifier hs-var">c_write</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352772"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352773"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679352774"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352775"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-560"></a><span>    </span><a name="local-6989586621679352779"><a href="#local-6989586621679352779"><span class="hs-identifier">safe_write</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679352776"><span class="hs-identifier hs-var">do_write</span></a><span> </span><span class="hs-special">(</span><a href="System.Posix.Internals.html#c_safe_write"><span class="hs-identifier hs-var">c_safe_write</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><a href="#local-6989586621679352772"><span class="hs-identifier hs-var">fd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352773"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-special">`</span><a href="GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679352774"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679352775"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span class="hs-identifier">isNonBlocking</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHC.IO.FD.html#FD"><span class="hs-identifier hs-type">FD</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-563"></a><a name="isNonBlocking"><a href="GHC.IO.FD.html#isNonBlocking"><span class="hs-identifier">isNonBlocking</span></a></a><span> </span><a name="local-6989586621679352784"><a href="#local-6989586621679352784"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fdIsNonBlocking</span><span> </span><a href="#local-6989586621679352784"><span class="hs-identifier hs-var">fd</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;fdReady&quot;</span><span>
</span><a name="line-566"></a><span>  </span><span class="hs-identifier">unsafe_fdReady</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CBool"><span class="hs-identifier hs-type">CBool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Int.html#Int64"><span class="hs-identifier hs-type">Int64</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CBool"><span class="hs-identifier hs-type">CBool</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-567"></a><span>
</span><a name="line-568"></a><span class="hs-cpp">#else /* mingw32_HOST_OS.... */
</span><span>
</span><a name="line-570"></a><span class="hs-identifier">readRawBufferPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-571"></a><span class="hs-identifier">readRawBufferPtr</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">buf</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">off</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">len</span><span>
</span><a name="line-572"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">threaded</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">blockingReadRawBufferPtr</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">buf</span><span> </span><span class="hs-identifier">off</span><span> </span><span class="hs-identifier">len</span><span>
</span><a name="line-573"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">asyncReadRawBufferPtr</span><span>    </span><span class="hs-identifier">loc</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">buf</span><span> </span><span class="hs-identifier">off</span><span> </span><span class="hs-identifier">len</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-identifier">writeRawBufferPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-576"></a><span class="hs-identifier">writeRawBufferPtr</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">buf</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">off</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">len</span><span>
</span><a name="line-577"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">threaded</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">blockingWriteRawBufferPtr</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">buf</span><span> </span><span class="hs-identifier">off</span><span> </span><span class="hs-identifier">len</span><span>
</span><a name="line-578"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">asyncWriteRawBufferPtr</span><span>    </span><span class="hs-identifier">loc</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-identifier">buf</span><span> </span><span class="hs-identifier">off</span><span> </span><span class="hs-identifier">len</span><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span class="hs-identifier">readRawBufferPtrNoBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-581"></a><span class="hs-identifier">readRawBufferPtrNoBlock</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">readRawBufferPtr</span><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span class="hs-identifier">writeRawBufferPtrNoBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-584"></a><span class="hs-identifier">writeRawBufferPtrNoBlock</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">writeRawBufferPtr</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span class="hs-comment">-- Async versions of the read/write primitives, for the non-threaded RTS</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-identifier">asyncReadRawBufferPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-589"></a><span class="hs-identifier">asyncReadRawBufferPtr</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">buf</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">off</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">len</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-590"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">l</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">asyncRead</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdIsSocket_</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">len</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">buf</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">off</span><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-593"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">sock_errno</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">c_maperrno_func</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">rc</span><span class="hs-special">)</span><span>
</span><a name="line-594"></a><span>               </span><span class="hs-identifier">non_sock_errno</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Errno</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">rc</span><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>               </span><span class="hs-identifier">errno</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">bool</span><span> </span><span class="hs-identifier">non_sock_errno</span><span> </span><span class="hs-identifier">sock_errno</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span>
</span><a name="line-596"></a><span>           </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier">ioError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">errnoToIOError</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-identifier">errno</span><span> </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-identifier">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">l</span><span class="hs-special">)</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span class="hs-identifier">asyncWriteRawBufferPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-600"></a><span class="hs-identifier">asyncWriteRawBufferPtr</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">buf</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">off</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">len</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-601"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">l</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">asyncWrite</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdIsSocket_</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">len</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">buf</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">off</span><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">sock_errno</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">c_maperrno_func</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">rc</span><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span>               </span><span class="hs-identifier">non_sock_errno</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Errno</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">rc</span><span class="hs-special">)</span><span>
</span><a name="line-606"></a><span>               </span><span class="hs-identifier">errno</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">bool</span><span> </span><span class="hs-identifier">non_sock_errno</span><span> </span><span class="hs-identifier">sock_errno</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>           </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier">ioError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">errnoToIOError</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-identifier">errno</span><span> </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-identifier">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-608"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">l</span><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span class="hs-comment">-- Blocking versions of the read/write primitives, for the threaded RTS</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span class="hs-identifier">blockingReadRawBufferPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-613"></a><span class="hs-identifier">blockingReadRawBufferPtr</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">buf</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">off</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">len</span><span>
</span><a name="line-614"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">throwErrnoIfMinus1Retry</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-615"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">start_ptr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">buf</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">off</span><span>
</span><a name="line-616"></a><span>            </span><span class="hs-identifier">recv_ret</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">c_safe_recv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">start_ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">len</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-617"></a><span>            </span><span class="hs-identifier">read_ret</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">c_safe_read</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">start_ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">len</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>        </span><span class="hs-identifier">r</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">bool</span><span> </span><span class="hs-identifier">read_ret</span><span> </span><span class="hs-identifier">recv_ret</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>        </span><span class="hs-identifier">when</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">r</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">c_maperrno</span><span>
</span><a name="line-620"></a><span>        </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">r</span><span>
</span><a name="line-621"></a><span>      </span><span class="hs-comment">-- We trust read() to give us the correct errno but recv(), as a</span><span>
</span><a name="line-622"></a><span>      </span><span class="hs-comment">-- Winsock function, doesn't do the errno conversion so if the fd</span><span>
</span><a name="line-623"></a><span>      </span><span class="hs-comment">-- is for a socket, we do it from GetLastError() ourselves.</span><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span class="hs-identifier">blockingWriteRawBufferPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FD</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-626"></a><span class="hs-identifier">blockingWriteRawBufferPtr</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">buf</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">off</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">len</span><span>
</span><a name="line-627"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">throwErrnoIfMinus1Retry</span><span> </span><span class="hs-identifier">loc</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-628"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">start_ptr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">buf</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">off</span><span>
</span><a name="line-629"></a><span>            </span><span class="hs-identifier">send_ret</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">c_safe_send</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">start_ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">len</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-630"></a><span>            </span><span class="hs-identifier">write_ret</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">c_safe_write</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdFD</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">start_ptr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-identifier">len</span><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>        </span><span class="hs-identifier">r</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">bool</span><span> </span><span class="hs-identifier">write_ret</span><span> </span><span class="hs-identifier">send_ret</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdIsSocket</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span>
</span><a name="line-632"></a><span>        </span><span class="hs-identifier">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">r</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">c_maperrno</span><span>
</span><a name="line-633"></a><span>        </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">r</span><span>
</span><a name="line-634"></a><span>      </span><span class="hs-comment">-- We don't trust write() to give us the correct errno, and</span><span>
</span><a name="line-635"></a><span>      </span><span class="hs-comment">-- instead do the errno conversion from GetLastError()</span><span>
</span><a name="line-636"></a><span>      </span><span class="hs-comment">-- ourselves. The main reason is that we treat ERROR_NO_DATA</span><span>
</span><a name="line-637"></a><span>      </span><span class="hs-comment">-- (pipe is closing) as EPIPE, whereas write() returns EINVAL</span><span>
</span><a name="line-638"></a><span>      </span><span class="hs-comment">-- for this case. We need to detect EPIPE correctly, because it</span><span>
</span><a name="line-639"></a><span>      </span><span class="hs-comment">-- shouldn't be reported as an error when it happens on stdout.</span><span>
</span><a name="line-640"></a><span>      </span><span class="hs-comment">-- As for send()'s case, Winsock functions don't do errno</span><span>
</span><a name="line-641"></a><span>      </span><span class="hs-comment">-- conversion in any case so we have to do it ourselves.</span><span>
</span><a name="line-642"></a><span>      </span><span class="hs-comment">-- That means we're doing the errno conversion no matter if the</span><span>
</span><a name="line-643"></a><span>      </span><span class="hs-comment">-- fd is from a socket or not.</span><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span class="hs-comment">-- NOTE: &quot;safe&quot; versions of the read/write calls for use by the threaded RTS.</span><span>
</span><a name="line-646"></a><span class="hs-comment">-- These calls may block, but that's ok.</span><span>
</span><a name="line-647"></a><span>
</span><a name="line-648"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">WINDOWS_CCONV</span><span> </span><span class="hs-keyword">safe</span><span> </span><span class="hs-string">&quot;recv&quot;</span><span>
</span><a name="line-649"></a><span>   </span><span class="hs-identifier">c_safe_recv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span class="hs-comment">{-flags-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-650"></a><span>
</span><a name="line-651"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">WINDOWS_CCONV</span><span> </span><span class="hs-keyword">safe</span><span> </span><span class="hs-string">&quot;send&quot;</span><span>
</span><a name="line-652"></a><span>   </span><span class="hs-identifier">c_safe_send</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CInt</span><span class="hs-comment">{-flags-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-653"></a><span>
</span><a name="line-654"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-656"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;rtsSupportsBoundThreads&quot;</span><span> </span><span class="hs-identifier">threaded</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-659"></a><span class="hs-comment">-- utils</span><span>
</span><a name="line-660"></a><span>
</span><a name="line-661"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS)
</span><span class="hs-identifier">throwErrnoIfMinus1RetryOnBlock</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="System.Posix.Types.html#CSsize"><span class="hs-identifier hs-type">CSsize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="System.Posix.Types.html#CSsize"><span class="hs-identifier hs-type">CSsize</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="System.Posix.Types.html#CSsize"><span class="hs-identifier hs-type">CSsize</span></a><span>
</span><a name="line-663"></a><a name="throwErrnoIfMinus1RetryOnBlock"><a href="GHC.IO.FD.html#throwErrnoIfMinus1RetryOnBlock"><span class="hs-identifier">throwErrnoIfMinus1RetryOnBlock</span></a></a><span> </span><a name="local-6989586621679352785"><a href="#local-6989586621679352785"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621679352786"><a href="#local-6989586621679352786"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679352787"><a href="#local-6989586621679352787"><span class="hs-identifier">on_block</span></a></a><span>  </span><span class="hs-glyph">=</span><span>
</span><a name="line-664"></a><span>  </span><span class="hs-keyword">do</span><span>
</span><a name="line-665"></a><span>    </span><a name="local-6989586621679352788"><a href="#local-6989586621679352788"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679352786"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-666"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679352788"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="System.Posix.Types.html#CSsize"><span class="hs-identifier hs-type">CSsize</span></a><span class="hs-special">)</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span>
</span><a name="line-667"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-668"></a><span>        </span><a name="local-6989586621679352789"><a href="#local-6989586621679352789"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Foreign.C.Error.html#getErrno"><span class="hs-identifier hs-var">getErrno</span></a><span>
</span><a name="line-669"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679352789"><span class="hs-identifier hs-var">err</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="Foreign.C.Error.html#eINTR"><span class="hs-identifier hs-var">eINTR</span></a><span>
</span><a name="line-670"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="GHC.IO.FD.html#throwErrnoIfMinus1RetryOnBlock"><span class="hs-identifier hs-var">throwErrnoIfMinus1RetryOnBlock</span></a><span> </span><a href="#local-6989586621679352785"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621679352786"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679352787"><span class="hs-identifier hs-var">on_block</span></a><span>
</span><a name="line-671"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679352789"><span class="hs-identifier hs-var">err</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="Foreign.C.Error.html#eWOULDBLOCK"><span class="hs-identifier hs-var">eWOULDBLOCK</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a><span> </span><a href="#local-6989586621679352789"><span class="hs-identifier hs-var">err</span></a><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a><span> </span><a href="Foreign.C.Error.html#eAGAIN"><span class="hs-identifier hs-var">eAGAIN</span></a><span>
</span><a name="line-672"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="#local-6989586621679352787"><span class="hs-identifier hs-var">on_block</span></a><span>
</span><a name="line-673"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><a href="Foreign.C.Error.html#throwErrno"><span class="hs-identifier hs-var">throwErrno</span></a><span> </span><a href="#local-6989586621679352785"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-674"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621679352788"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-675"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-677"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- Locking/unlocking</span><span>
</span><a name="line-679"></a><span>
</span><a name="line-680"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;lockFile&quot;</span><span>
</span><a name="line-681"></a><span>  </span><span class="hs-identifier">lockFile</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;unlockFile&quot;</span><span>
</span><a name="line-684"></a><span>  </span><span class="hs-identifier">unlockFile</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../ghc-prim/src/%{MODULE}.html#%{NAME}/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a><span> </span><a href="Foreign.C.Types.html#CInt"><span class="hs-identifier hs-type">CInt</span></a><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;get_unique_file_info&quot;</span><span>
</span><a name="line-688"></a><span>  </span><span class="hs-identifier">c_getUniqueFileInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-689"></a><span class="hs-cpp">#endif
</span></pre></body></html>