<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/Single.hs

(c) Richard Eisenberg 2013
rae@cs.brynmawr.edu

This file contains functions to refine constructs to work with singleton
types. It is an internal module to the singletons package.
-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell, TupleSections, ParallelListComp, CPP #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.Single</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exp</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">cxt</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NameSpace</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Quasi</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Infer.html"><span class="hs-identifier">Data.Singletons.Deriving.Infer</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Ord.html"><span class="hs-identifier">Data.Singletons.Deriving.Ord</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Bounded.html"><span class="hs-identifier">Data.Singletons.Deriving.Bounded</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Enum.html"><span class="hs-identifier">Data.Singletons.Deriving.Enum</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Show.html"><span class="hs-identifier">Data.Singletons.Deriving.Show</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Deriving.Util.html"><span class="hs-identifier">Data.Singletons.Deriving.Util</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Util.html"><span class="hs-identifier">Data.Singletons.Util</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.html"><span class="hs-identifier">Data.Singletons.Promote</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Defun.html"><span class="hs-identifier">Data.Singletons.Promote.Defun</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Monad.html"><span class="hs-identifier">Data.Singletons.Promote.Monad</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier hs-var">promoteM</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Promote.Type.html"><span class="hs-identifier">Data.Singletons.Promote.Type</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Names.html"><span class="hs-identifier">Data.Singletons.Names</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Single.Monad.html"><span class="hs-identifier">Data.Singletons.Single.Monad</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Single.Type.html"><span class="hs-identifier">Data.Singletons.Single.Type</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Single.Data.html"><span class="hs-identifier">Data.Singletons.Single.Data</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Single.Defun.html"><span class="hs-identifier">Data.Singletons.Single.Defun</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Single.Fixity.html"><span class="hs-identifier">Data.Singletons.Single.Fixity</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Single.Eq.html"><span class="hs-identifier">Data.Singletons.Single.Eq</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Syntax.html"><span class="hs-identifier">Data.Singletons.Syntax</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Singletons.Partition.html"><span class="hs-identifier">Data.Singletons.Partition</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Desugar</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions.Type</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-comment">{-
How singletons works
~~~~~~~~~~~~~~~~~~~~

Singling, on the surface, doesn't seem all that complicated. Promote the type,
and singletonize all the terms. That's essentially what was done singletons &lt; 1.0.
But, now we want to deal with higher-order singletons. So, things are a little
more complicated.

The way to understand all of this is that *every* variable maps to something
of type (Sing t), for an appropriately-kinded t. This includes functions, which
use the &quot;SLambda&quot; instance of Sing. To apply singleton functions, we use the
applySing function.

That, in and of itself, wouldn't be too hard, but it's really annoying from
the user standpoint. After dutifully singling `map`, a user doesn't want to
have to use two `applySing`s to actually use it. So, any let-bound identifier
is eta-expanded so that the singled type has the same number of arrows as
the original type. (If there is no original type signature, then it has as
many arrows as the original had patterns.) Then, we store a use of one of the
singFunX functions in the SgM environment so that every use of a let-bound
identifier has a proper type (Sing t).

It would be consistent to avoid this eta-expansion for local lets (as opposed
to top-level lets), but that seemed like more bother than it was worth. It
may also be possible to be cleverer about nested eta-expansions and contractions,
but that also seemed not to be worth it. Though I haven't tested it, my hope
is that the eta-expansions and contractions have no runtime effect, especially
because SLambda is a *newtype* instance, not a *data* instance.

Note that to maintain the desired invariant, we must also be careful to eta-
contract constructors. This is the point of buildDataLets.
-}</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-comment">-- | Generate singleton definitions from a type that is already defined.</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- For example, the singletons package itself uses</span><span>
</span><a name="line-82"></a><span class="hs-comment">--</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- &gt; $(genSingletons [''Bool, ''Maybe, ''Either, ''[]])</span><span>
</span><a name="line-84"></a><span class="hs-comment">--</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- to generate singletons for Prelude types.</span><span>
</span><a name="line-86"></a><span class="hs-identifier">genSingletons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208355"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208355"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-87"></a><a name="genSingletons"><a href="Data.Singletons.Single.html#genSingletons"><span class="hs-identifier">genSingletons</span></a></a><span> </span><a name="local-6989586621679208356"><a href="#local-6989586621679208356"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-88"></a><span>  </span><a href="Data.Singletons.Util.html#checkForRep"><span class="hs-identifier hs-var">checkForRep</span></a><span> </span><a href="#local-6989586621679208356"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-89"></a><span>  </span><a name="local-6989586621679208357"><a href="#local-6989586621679208357"><span class="hs-identifier">ddecs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.html#singInfo"><span class="hs-identifier hs-var">singInfo</span></a><span> </span><span class="hs-operator hs-var">&lt;=&lt;</span><span> </span><span class="hs-identifier hs-var">dsInfo</span><span> </span><span class="hs-operator hs-var">&lt;=&lt;</span><span> </span><span class="hs-identifier hs-var">reifyWithLocals</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208356"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-90"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><a href="#local-6989586621679208357"><span class="hs-identifier hs-var">ddecs</span></a><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">-- | Make promoted and singleton versions of all declarations given, retaining</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- the original declarations.</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- See &lt;https://github.com/goldfirere/singletons/blob/master/README.md&gt; for</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- further explanation.</span><span>
</span><a name="line-96"></a><span class="hs-identifier">singletons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208354"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679208354"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208354"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-97"></a><a name="singletons"><a href="Data.Singletons.Single.html#singletons"><span class="hs-identifier">singletons</span></a></a><span> </span><a name="local-6989586621679208358"><a href="#local-6989586621679208358"><span class="hs-identifier">qdecs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-98"></a><span>  </span><a name="local-6989586621679208359"><a href="#local-6989586621679208359"><span class="hs-identifier">decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208358"><span class="hs-identifier hs-var">qdecs</span></a><span>
</span><a name="line-99"></a><span>  </span><a name="local-6989586621679208360"><a href="#local-6989586621679208360"><span class="hs-identifier">ddecs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">withLocalDeclarations</span><span> </span><a href="#local-6989586621679208359"><span class="hs-identifier hs-var">decs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dsDecs</span><span> </span><a href="#local-6989586621679208359"><span class="hs-identifier hs-var">decs</span></a><span>
</span><a name="line-100"></a><span>  </span><a name="local-6989586621679208361"><a href="#local-6989586621679208361"><span class="hs-identifier">singDecs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singTopLevelDecs"><span class="hs-identifier hs-var">singTopLevelDecs</span></a><span> </span><a href="#local-6989586621679208359"><span class="hs-identifier hs-var">decs</span></a><span> </span><a href="#local-6989586621679208360"><span class="hs-identifier hs-var">ddecs</span></a><span>
</span><a name="line-101"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208359"><span class="hs-identifier hs-var">decs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><a href="#local-6989586621679208361"><span class="hs-identifier hs-var">singDecs</span></a><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-comment">-- | Make promoted and singleton versions of all declarations given, discarding</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- the original declarations. Note that a singleton based on a datatype needs</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- the original datatype, so this will fail if it sees any datatype declarations.</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- Classes, instances, and functions are all fine.</span><span>
</span><a name="line-107"></a><span class="hs-identifier">singletonsOnly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208353"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679208353"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208353"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-108"></a><a name="singletonsOnly"><a href="Data.Singletons.Single.html#singletonsOnly"><span class="hs-identifier">singletonsOnly</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="Data.Singletons.Util.html#wrapDesugar"><span class="hs-identifier hs-var">wrapDesugar</span></a><span> </span><a href="Data.Singletons.Single.html#singTopLevelDecs"><span class="hs-identifier hs-var">singTopLevelDecs</span></a><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | Create instances of 'SEq' and type-level @(==)@ for each type in the list</span><span>
</span><a name="line-111"></a><span class="hs-identifier">singEqInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208352"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208352"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-112"></a><a name="singEqInstances"><a href="Data.Singletons.Single.html#singEqInstances"><span class="hs-identifier">singEqInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#singEqInstance"><span class="hs-identifier hs-var">singEqInstance</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-comment">-- | Create instance of 'SEq' and type-level @(==)@ for the given type</span><span>
</span><a name="line-115"></a><span class="hs-identifier">singEqInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208351"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208351"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-116"></a><a name="singEqInstance"><a href="Data.Singletons.Single.html#singEqInstance"><span class="hs-identifier">singEqInstance</span></a></a><span> </span><a name="local-6989586621679208362"><a href="#local-6989586621679208362"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-117"></a><span>  </span><a name="local-6989586621679208363"><a href="#local-6989586621679208363"><span class="hs-identifier">promotion</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteEqInstance"><span class="hs-identifier hs-var">promoteEqInstance</span></a><span> </span><a href="#local-6989586621679208362"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-118"></a><span>  </span><a name="local-6989586621679208364"><a href="#local-6989586621679208364"><span class="hs-identifier">dec</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singEqualityInstance"><span class="hs-identifier hs-var">singEqualityInstance</span></a><span> </span><a href="Data.Singletons.Single.Eq.html#sEqClassDesc"><span class="hs-identifier hs-var">sEqClassDesc</span></a><span> </span><a href="#local-6989586621679208362"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-119"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679208364"><span class="hs-identifier hs-var">dec</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208363"><span class="hs-identifier hs-var">promotion</span></a><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-comment">-- | Create instances of 'SEq' (only -- no instance for @(==)@, which 'SEq' generally</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- relies on) for each type in the list</span><span>
</span><a name="line-123"></a><span class="hs-identifier">singEqInstancesOnly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208350"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208350"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-124"></a><a name="singEqInstancesOnly"><a href="Data.Singletons.Single.html#singEqInstancesOnly"><span class="hs-identifier">singEqInstancesOnly</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#singEqInstanceOnly"><span class="hs-identifier hs-var">singEqInstanceOnly</span></a><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">-- | Create instances of 'SEq' (only -- no instance for @(==)@, which 'SEq' generally</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- relies on) for the given type</span><span>
</span><a name="line-128"></a><span class="hs-identifier">singEqInstanceOnly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208349"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208349"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-129"></a><a name="singEqInstanceOnly"><a href="Data.Singletons.Single.html#singEqInstanceOnly"><span class="hs-identifier">singEqInstanceOnly</span></a></a><span> </span><a name="local-6989586621679208365"><a href="#local-6989586621679208365"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#singEqualityInstance"><span class="hs-identifier hs-var">singEqualityInstance</span></a><span> </span><a href="Data.Singletons.Single.Eq.html#sEqClassDesc"><span class="hs-identifier hs-var">sEqClassDesc</span></a><span> </span><a href="#local-6989586621679208365"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">-- | Create instances of 'SDecide' for each type in the list.</span><span>
</span><a name="line-132"></a><span class="hs-identifier">singDecideInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208348"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208348"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-133"></a><a name="singDecideInstances"><a href="Data.Singletons.Single.html#singDecideInstances"><span class="hs-identifier">singDecideInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#singDecideInstance"><span class="hs-identifier hs-var">singDecideInstance</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-comment">-- | Create instance of 'SDecide' for the given type.</span><span>
</span><a name="line-136"></a><span class="hs-identifier">singDecideInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208347"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208347"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-137"></a><a name="singDecideInstance"><a href="Data.Singletons.Single.html#singDecideInstance"><span class="hs-identifier">singDecideInstance</span></a></a><span> </span><a name="local-6989586621679208366"><a href="#local-6989586621679208366"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#singEqualityInstance"><span class="hs-identifier hs-var">singEqualityInstance</span></a><span> </span><a href="Data.Singletons.Single.Eq.html#sDecideClassDesc"><span class="hs-identifier hs-var">sDecideClassDesc</span></a><span> </span><a href="#local-6989586621679208366"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- generalized function for creating equality instances</span><span>
</span><a name="line-140"></a><span class="hs-identifier">singEqualityInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208346"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Singletons.Single.Eq.html#EqualityClassDesc"><span class="hs-identifier hs-type">EqualityClassDesc</span></a><span> </span><a href="#local-6989586621679208346"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208346"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-141"></a><a name="singEqualityInstance"><a href="Data.Singletons.Single.html#singEqualityInstance"><span class="hs-identifier">singEqualityInstance</span></a></a><span> </span><a name="local-6989586621679208367"><a href="#local-6989586621679208367"><span class="hs-identifier">desc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679208368"><a href="#local-6989586621679208368"><span class="hs-identifier">className</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679208369"><a href="#local-6989586621679208369"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-142"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208370"><a href="#local-6989586621679208370"><span class="hs-identifier">tvbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208371"><a href="#local-6989586621679208371"><span class="hs-identifier">cons</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDataD</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;I cannot make an instance of &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-143"></a><span>                            </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679208368"><span class="hs-identifier hs-var">className</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; for it.&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208369"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-144"></a><span>  </span><a name="local-6989586621679208372"><a href="#local-6989586621679208372"><span class="hs-identifier">dtvbs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">dsTvb</span><span> </span><a href="#local-6989586621679208370"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-145"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208373"><a href="#local-6989586621679208373"><span class="hs-identifier">data_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679208369"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208372"><span class="hs-identifier hs-var">dtvbs</span></a><span>
</span><a name="line-146"></a><span>  </span><a name="local-6989586621679208374"><a href="#local-6989586621679208374"><span class="hs-identifier">dcons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dsCon</span><span> </span><a href="#local-6989586621679208372"><span class="hs-identifier hs-var">dtvbs</span></a><span> </span><a href="#local-6989586621679208373"><span class="hs-identifier hs-var">data_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208371"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-147"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208375"><a href="#local-6989586621679208375"><span class="hs-identifier">tyvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208372"><span class="hs-identifier hs-var">dtvbs</span></a><span>
</span><a name="line-148"></a><span>      </span><a name="local-6989586621679208376"><a href="#local-6989586621679208376"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679208369"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208375"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-149"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208377"><a href="#local-6989586621679208377"><span class="hs-identifier">scons</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Monad.html#singM"><span class="hs-identifier hs-var">singM</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Single.Data.html#singCtor"><span class="hs-identifier hs-var">singCtor</span></a><span> </span><a href="#local-6989586621679208374"><span class="hs-identifier hs-var">dcons</span></a><span>
</span><a name="line-150"></a><span>  </span><a name="local-6989586621679208378"><a href="#local-6989586621679208378"><span class="hs-identifier">eqInstance</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Eq.html#mkEqualityInstance"><span class="hs-identifier hs-var">mkEqualityInstance</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679208376"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621679208374"><span class="hs-identifier hs-var">dcons</span></a><span> </span><a href="#local-6989586621679208377"><span class="hs-identifier hs-var">scons</span></a><span> </span><a href="#local-6989586621679208367"><span class="hs-identifier hs-var">desc</span></a><span>
</span><a name="line-151"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">decToTH</span><span> </span><a href="#local-6989586621679208378"><span class="hs-identifier hs-var">eqInstance</span></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- | Create instances of 'SOrd' for the given types</span><span>
</span><a name="line-154"></a><span class="hs-identifier">singOrdInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208345"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208345"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-155"></a><a name="singOrdInstances"><a href="Data.Singletons.Single.html#singOrdInstances"><span class="hs-identifier">singOrdInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#singOrdInstance"><span class="hs-identifier hs-var">singOrdInstance</span></a><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-comment">-- | Create instance of 'SOrd' for the given type</span><span>
</span><a name="line-158"></a><span class="hs-identifier">singOrdInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208344"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208344"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-159"></a><a name="singOrdInstance"><a href="Data.Singletons.Single.html#singOrdInstance"><span class="hs-identifier">singOrdInstance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-var">singInstance</span></a><span> </span><a href="Data.Singletons.Deriving.Ord.html#mkOrdInstance"><span class="hs-identifier hs-var">mkOrdInstance</span></a><span> </span><span class="hs-string">&quot;Ord&quot;</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-comment">-- | Create instances of 'SBounded' for the given types</span><span>
</span><a name="line-162"></a><span class="hs-identifier">singBoundedInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208343"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208343"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-163"></a><a name="singBoundedInstances"><a href="Data.Singletons.Single.html#singBoundedInstances"><span class="hs-identifier">singBoundedInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#singBoundedInstance"><span class="hs-identifier hs-var">singBoundedInstance</span></a><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-comment">-- | Create instance of 'SBounded' for the given type</span><span>
</span><a name="line-166"></a><span class="hs-identifier">singBoundedInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208342"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208342"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-167"></a><a name="singBoundedInstance"><a href="Data.Singletons.Single.html#singBoundedInstance"><span class="hs-identifier">singBoundedInstance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-var">singInstance</span></a><span> </span><a href="Data.Singletons.Deriving.Bounded.html#mkBoundedInstance"><span class="hs-identifier hs-var">mkBoundedInstance</span></a><span> </span><span class="hs-string">&quot;Bounded&quot;</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-comment">-- | Create instances of 'SEnum' for the given types</span><span>
</span><a name="line-170"></a><span class="hs-identifier">singEnumInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208341"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208341"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-171"></a><a name="singEnumInstances"><a href="Data.Singletons.Single.html#singEnumInstances"><span class="hs-identifier">singEnumInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#singEnumInstance"><span class="hs-identifier hs-var">singEnumInstance</span></a><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-comment">-- | Create instance of 'SEnum' for the given type</span><span>
</span><a name="line-174"></a><span class="hs-identifier">singEnumInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208340"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208340"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-175"></a><a name="singEnumInstance"><a href="Data.Singletons.Single.html#singEnumInstance"><span class="hs-identifier">singEnumInstance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-var">singInstance</span></a><span> </span><a href="Data.Singletons.Deriving.Enum.html#mkEnumInstance"><span class="hs-identifier hs-var">mkEnumInstance</span></a><span> </span><span class="hs-string">&quot;Enum&quot;</span><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-comment">-- | Create instance of 'SShow' for the given type</span><span>
</span><a name="line-178"></a><span class="hs-comment">--</span><span>
</span><a name="line-179"></a><span class="hs-comment">-- (Not to be confused with 'showShowInstance'.)</span><span>
</span><a name="line-180"></a><span class="hs-identifier">singShowInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208339"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208339"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-181"></a><a name="singShowInstance"><a href="Data.Singletons.Single.html#singShowInstance"><span class="hs-identifier">singShowInstance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-var">singInstance</span></a><span> </span><a href="Data.Singletons.Deriving.Show.html#mkShowInstance"><span class="hs-identifier hs-var">mkShowInstance</span></a><span> </span><span class="hs-string">&quot;Show&quot;</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-comment">-- | Create instances of 'SShow' for the given types</span><span>
</span><a name="line-184"></a><span class="hs-comment">--</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- (Not to be confused with 'showSingInstances'.)</span><span>
</span><a name="line-186"></a><span class="hs-identifier">singShowInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208338"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208338"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-187"></a><a name="singShowInstances"><a href="Data.Singletons.Single.html#singShowInstances"><span class="hs-identifier">singShowInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#singShowInstance"><span class="hs-identifier hs-var">singShowInstance</span></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-comment">-- | Create instance of 'Show' for the given singleton type</span><span>
</span><a name="line-190"></a><span class="hs-comment">--</span><span>
</span><a name="line-191"></a><span class="hs-comment">-- (Not to be confused with 'singShowInstance'.)</span><span>
</span><a name="line-192"></a><span class="hs-identifier">showSingInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208337"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208337"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-193"></a><a name="showSingInstance"><a href="Data.Singletons.Single.html#showSingInstance"><span class="hs-identifier">showSingInstance</span></a></a><span> </span><a name="local-6989586621679208379"><a href="#local-6989586621679208379"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208380"><a href="#local-6989586621679208380"><span class="hs-identifier">tvbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208381"><a href="#local-6989586621679208381"><span class="hs-identifier">cons</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDataD</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;I cannot make an instance of Show for it.&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208379"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-195"></a><span>  </span><a name="local-6989586621679208382"><a href="#local-6989586621679208382"><span class="hs-identifier">dtvbs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">dsTvb</span><span> </span><a href="#local-6989586621679208380"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-196"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208383"><a href="#local-6989586621679208383"><span class="hs-identifier">data_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679208379"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208382"><span class="hs-identifier hs-var">dtvbs</span></a><span>
</span><a name="line-197"></a><span>  </span><a name="local-6989586621679208384"><a href="#local-6989586621679208384"><span class="hs-identifier">dcons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dsCon</span><span> </span><a href="#local-6989586621679208382"><span class="hs-identifier hs-var">dtvbs</span></a><span> </span><a href="#local-6989586621679208383"><span class="hs-identifier hs-var">data_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208381"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-198"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208385"><a href="#local-6989586621679208385"><span class="hs-identifier">tyvars</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208382"><span class="hs-identifier hs-var">dtvbs</span></a><span>
</span><a name="line-199"></a><span>      </span><a name="local-6989586621679208386"><a href="#local-6989586621679208386"><span class="hs-identifier">kind</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679208379"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208385"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-200"></a><span>      </span><a name="local-6989586621679208387"><a href="#local-6989586621679208387"><span class="hs-identifier">data_decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><a href="#local-6989586621679208379"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208382"><span class="hs-identifier hs-var">dtvbs</span></a><span> </span><a href="#local-6989586621679208384"><span class="hs-identifier hs-var">dcons</span></a><span>
</span><a name="line-201"></a><span>      </span><a name="local-6989586621679208388"><a href="#local-6989586621679208388"><span class="hs-identifier">deriv_show_decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-var">DerivedDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ded_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-202"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ded_type</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679208386"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-203"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ded_decl</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679208387"><span class="hs-identifier hs-var">data_decl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-204"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208389"><a href="#local-6989586621679208389"><span class="hs-identifier">show_insts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Monad.html#singM"><span class="hs-identifier hs-var">singM</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Single.html#singDerivedShowDecs"><span class="hs-identifier hs-var">singDerivedShowDecs</span></a><span> </span><a href="#local-6989586621679208388"><span class="hs-identifier hs-var">deriv_show_decl</span></a><span>
</span><a name="line-205"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><a href="#local-6989586621679208389"><span class="hs-identifier hs-var">show_insts</span></a><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-comment">-- | Create instances of 'Show' for the given singleton types</span><span>
</span><a name="line-208"></a><span class="hs-comment">--</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- (Not to be confused with 'singShowInstances'.)</span><span>
</span><a name="line-210"></a><span class="hs-identifier">showSingInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208336"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208336"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-211"></a><a name="showSingInstances"><a href="Data.Singletons.Single.html#showSingInstances"><span class="hs-identifier">showSingInstances</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#showSingInstance"><span class="hs-identifier hs-var">showSingInstance</span></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-identifier">singInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208335"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Data.Singletons.Deriving.Util.html#DerivDesc"><span class="hs-identifier hs-type">DerivDesc</span></a><span> </span><a href="#local-6989586621679208335"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208335"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-214"></a><a name="singInstance"><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier">singInstance</span></a></a><span> </span><a name="local-6989586621679208390"><a href="#local-6989586621679208390"><span class="hs-identifier">mk_inst</span></a></a><span> </span><a name="local-6989586621679208391"><a href="#local-6989586621679208391"><span class="hs-identifier">inst_name</span></a></a><span> </span><a name="local-6989586621679208392"><a href="#local-6989586621679208392"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-215"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208393"><a href="#local-6989586621679208393"><span class="hs-identifier">tvbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208394"><a href="#local-6989586621679208394"><span class="hs-identifier">cons</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDataD</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;I cannot make an instance of &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208391"><span class="hs-identifier hs-var">inst_name</span></a><span>
</span><a name="line-216"></a><span>                            </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; for it.&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208392"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-217"></a><span>  </span><a name="local-6989586621679208395"><a href="#local-6989586621679208395"><span class="hs-identifier">dtvbs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">dsTvb</span><span> </span><a href="#local-6989586621679208393"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-218"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208396"><a href="#local-6989586621679208396"><span class="hs-identifier">data_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679208392"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208395"><span class="hs-identifier hs-var">dtvbs</span></a><span>
</span><a name="line-219"></a><span>  </span><a name="local-6989586621679208397"><a href="#local-6989586621679208397"><span class="hs-identifier">dcons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dsCon</span><span> </span><a href="#local-6989586621679208395"><span class="hs-identifier hs-var">dtvbs</span></a><span> </span><a href="#local-6989586621679208396"><span class="hs-identifier hs-var">data_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208394"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-220"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208398"><a href="#local-6989586621679208398"><span class="hs-identifier">data_decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><a href="#local-6989586621679208392"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208395"><span class="hs-identifier hs-var">dtvbs</span></a><span> </span><a href="#local-6989586621679208397"><span class="hs-identifier hs-var">dcons</span></a><span>
</span><a name="line-221"></a><span>  </span><a name="local-6989586621679208399"><a href="#local-6989586621679208399"><span class="hs-identifier">raw_inst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208390"><span class="hs-identifier hs-var">mk_inst</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679208396"><span class="hs-identifier hs-var">data_ty</span></a><span> </span><a href="#local-6989586621679208398"><span class="hs-identifier hs-var">data_decl</span></a><span>
</span><a name="line-222"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208400"><a href="#local-6989586621679208400"><span class="hs-identifier">a_inst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208401"><a href="#local-6989586621679208401"><span class="hs-identifier">decs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier hs-var">promoteM</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-223"></a><span>                    </span><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><a href="#local-6989586621679208399"><span class="hs-identifier hs-var">raw_inst</span></a><span>
</span><a name="line-224"></a><span>  </span><a name="local-6989586621679208402"><a href="#local-6989586621679208402"><span class="hs-identifier">decs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Monad.html#singDecsM"><span class="hs-identifier hs-var">singDecsM</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Singletons.Single.html#singInstD"><span class="hs-identifier hs-var">singInstD</span></a><span> </span><a href="#local-6989586621679208400"><span class="hs-identifier hs-var">a_inst</span></a><span>
</span><a name="line-225"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">decsToTH</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208401"><span class="hs-identifier hs-var">decs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208402"><span class="hs-identifier hs-var">decs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-identifier">singInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208334"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208334"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-228"></a><a name="singInfo"><a href="Data.Singletons.Single.html#singInfo"><span class="hs-identifier">singInfo</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTyConI</span><span> </span><a name="local-6989586621679208403"><a href="#local-6989586621679208403"><span class="hs-identifier">dec</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-229"></a><span>  </span><a href="Data.Singletons.Single.html#singTopLevelDecs"><span class="hs-identifier hs-var">singTopLevelDecs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679208403"><span class="hs-identifier hs-var">dec</span></a><span class="hs-special">]</span><span>
</span><a name="line-230"></a><span class="hs-identifier">singInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DPrimTyConI</span><span> </span><a name="local-6989586621679208404"><a href="#local-6989586621679208404"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679208405"><a href="#local-6989586621679208405"><span class="hs-identifier">_numArgs</span></a></a><span> </span><a name="local-6989586621679208406"><a href="#local-6989586621679208406"><span class="hs-identifier">_unlifted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-231"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Singling of primitive type constructors not supported&quot;</span><span>
</span><a name="line-232"></a><span class="hs-identifier">singInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarI</span><span> </span><a name="local-6989586621679208407"><a href="#local-6989586621679208407"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679208408"><a href="#local-6989586621679208408"><span class="hs-identifier">_ty</span></a></a><span> </span><a name="local-6989586621679208409"><a href="#local-6989586621679208409"><span class="hs-identifier">_mdec</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-233"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Singling of value info not supported&quot;</span><span>
</span><a name="line-234"></a><span class="hs-identifier">singInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DTyVarI</span><span> </span><a name="local-6989586621679208410"><a href="#local-6989586621679208410"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679208411"><a href="#local-6989586621679208411"><span class="hs-identifier">_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Singling of type variable info not supported&quot;</span><span>
</span><a name="line-236"></a><span class="hs-identifier">singInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DPatSynI</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-237"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Singling of pattern synonym info not supported&quot;</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-identifier">singTopLevelDecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMonad</span><span> </span><a href="#local-6989586621679208333"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208333"><span class="hs-identifier hs-type">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-240"></a><a name="singTopLevelDecs"><a href="Data.Singletons.Single.html#singTopLevelDecs"><span class="hs-identifier">singTopLevelDecs</span></a></a><span> </span><a name="local-6989586621679208412"><a href="#local-6989586621679208412"><span class="hs-identifier">locals</span></a></a><span> </span><a name="local-6989586621679208413"><a href="#local-6989586621679208413"><span class="hs-identifier">raw_decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withLocalDeclarations</span><span> </span><a href="#local-6989586621679208412"><span class="hs-identifier hs-var">locals</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-241"></a><span>  </span><a name="local-6989586621679208414"><a href="#local-6989586621679208414"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">expand</span><span> </span><a href="#local-6989586621679208413"><span class="hs-identifier hs-var">raw_decls</span></a><span>     </span><span class="hs-comment">-- expand type synonyms</span><span>
</span><a name="line-242"></a><span>  </span><a href="Data.Singletons.Partition.html#PDecs"><span class="hs-identifier hs-var">PDecs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pd_let_decs</span><span>                </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208415"><a href="#local-6989586621679208415"><span class="hs-identifier">letDecls</span></a></a><span>
</span><a name="line-243"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_class_decs</span><span>              </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208416"><a href="#local-6989586621679208416"><span class="hs-identifier">classes</span></a></a><span>
</span><a name="line-244"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_instance_decs</span><span>           </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208417"><a href="#local-6989586621679208417"><span class="hs-identifier">insts</span></a></a><span>
</span><a name="line-245"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_data_decs</span><span>               </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208418"><a href="#local-6989586621679208418"><span class="hs-identifier">datas</span></a></a><span>
</span><a name="line-246"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_ty_syn_decs</span><span>             </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208419"><a href="#local-6989586621679208419"><span class="hs-identifier">ty_syns</span></a></a><span>
</span><a name="line-247"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_open_type_family_decs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208420"><a href="#local-6989586621679208420"><span class="hs-identifier">o_tyfams</span></a></a><span>
</span><a name="line-248"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_closed_type_family_decs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208421"><a href="#local-6989586621679208421"><span class="hs-identifier">c_tyfams</span></a></a><span>
</span><a name="line-249"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_derived_eq_decs</span><span>         </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208422"><a href="#local-6989586621679208422"><span class="hs-identifier">derivedEqDecs</span></a></a><span>
</span><a name="line-250"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pd_derived_show_decs</span><span>       </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208423"><a href="#local-6989586621679208423"><span class="hs-identifier">derivedShowDecs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Partition.html#partitionDecs"><span class="hs-identifier hs-var">partitionDecs</span></a><span> </span><a href="#local-6989586621679208414"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679208428"><a href="#local-6989586621679208428"><span class="hs-identifier">letDecEnv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208429"><a href="#local-6989586621679208429"><span class="hs-identifier">classes'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208430"><a href="#local-6989586621679208430"><span class="hs-identifier">insts'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679208431"><a href="#local-6989586621679208431"><span class="hs-identifier">promDecls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier hs-var">promoteM</span></a><span> </span><a href="#local-6989586621679208412"><span class="hs-identifier hs-var">locals</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-253"></a><span>    </span><a href="Data.Singletons.Promote.Defun.html#defunTypeDecls"><span class="hs-identifier hs-var">defunTypeDecls</span></a><span> </span><a href="#local-6989586621679208419"><span class="hs-identifier hs-var">ty_syns</span></a><span> </span><a href="#local-6989586621679208421"><span class="hs-identifier hs-var">c_tyfams</span></a><span> </span><a href="#local-6989586621679208420"><span class="hs-identifier hs-var">o_tyfams</span></a><span>
</span><a name="line-254"></a><span>    </span><a href="Data.Singletons.Promote.html#promoteDataDecs"><span class="hs-identifier hs-var">promoteDataDecs</span></a><span> </span><a href="#local-6989586621679208418"><span class="hs-identifier hs-var">datas</span></a><span>
</span><a name="line-255"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679208424"><a href="#local-6989586621679208424"><span class="hs-identifier">letDecEnv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a><span> </span><a href="Data.Singletons.Util.html#noPrefix"><span class="hs-identifier hs-var">noPrefix</span></a><span> </span><a href="#local-6989586621679208415"><span class="hs-identifier hs-var">letDecls</span></a><span>
</span><a name="line-256"></a><span>    </span><a name="local-6989586621679208425"><a href="#local-6989586621679208425"><span class="hs-identifier">classes'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Promote.html#promoteClassDec"><span class="hs-identifier hs-var">promoteClassDec</span></a><span> </span><a href="#local-6989586621679208416"><span class="hs-identifier hs-var">classes</span></a><span>
</span><a name="line-257"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208426"><a href="#local-6989586621679208426"><span class="hs-identifier">meth_sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">lde_types</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">cd_lde</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208416"><span class="hs-identifier hs-var">classes</span></a><span>
</span><a name="line-258"></a><span>    </span><a name="local-6989586621679208427"><a href="#local-6989586621679208427"><span class="hs-identifier">insts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a><span> </span><a href="#local-6989586621679208426"><span class="hs-identifier hs-var">meth_sigs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208417"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-259"></a><span>    </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Data.Singletons.Promote.html#promoteDerivedEqDec"><span class="hs-identifier hs-var">promoteDerivedEqDec</span></a><span> </span><a href="#local-6989586621679208422"><span class="hs-identifier hs-var">derivedEqDecs</span></a><span>
</span><a name="line-260"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208424"><span class="hs-identifier hs-var">letDecEnv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208425"><span class="hs-identifier hs-var">classes'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208427"><span class="hs-identifier hs-var">insts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span>  </span><a href="Data.Singletons.Single.Monad.html#singDecsM"><span class="hs-identifier hs-var">singDecsM</span></a><span> </span><a href="#local-6989586621679208412"><span class="hs-identifier hs-var">locals</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-263"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208432"><a href="#local-6989586621679208432"><span class="hs-identifier">letBinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="Data.Singletons.Single.html#buildDataLets"><span class="hs-identifier hs-var">buildDataLets</span></a><span> </span><a href="#local-6989586621679208418"><span class="hs-identifier hs-var">datas</span></a><span>
</span><a name="line-264"></a><span>                </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="Data.Singletons.Single.html#buildMethLets"><span class="hs-identifier hs-var">buildMethLets</span></a><span> </span><a href="#local-6989586621679208416"><span class="hs-identifier hs-var">classes</span></a><span>
</span><a name="line-265"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679208438"><a href="#local-6989586621679208438"><span class="hs-identifier">newLetDecls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208439"><a href="#local-6989586621679208439"><span class="hs-identifier">singIDefunDecls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208440"><a href="#local-6989586621679208440"><span class="hs-identifier">newDecls</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>                            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Monad.html#bindLets"><span class="hs-identifier hs-var">bindLets</span></a><span> </span><a href="#local-6989586621679208432"><span class="hs-identifier hs-var">letBinds</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-267"></a><span>                               </span><a href="Data.Singletons.Single.html#singLetDecEnv"><span class="hs-identifier hs-var">singLetDecEnv</span></a><span> </span><a href="#local-6989586621679208428"><span class="hs-identifier hs-var">letDecEnv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-268"></a><span>                                 </span><a name="local-6989586621679208433"><a href="#local-6989586621679208433"><span class="hs-identifier">newDataDecls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.Data.html#singDataD"><span class="hs-identifier hs-var">singDataD</span></a><span> </span><a href="#local-6989586621679208418"><span class="hs-identifier hs-var">datas</span></a><span>
</span><a name="line-269"></a><span>                                 </span><a name="local-6989586621679208434"><a href="#local-6989586621679208434"><span class="hs-identifier">newClassDecls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Single.html#singClassD"><span class="hs-identifier hs-var">singClassD</span></a><span> </span><a href="#local-6989586621679208429"><span class="hs-identifier hs-var">classes'</span></a><span>
</span><a name="line-270"></a><span>                                 </span><a name="local-6989586621679208435"><a href="#local-6989586621679208435"><span class="hs-identifier">newInstDecls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Single.html#singInstD"><span class="hs-identifier hs-var">singInstD</span></a><span> </span><a href="#local-6989586621679208430"><span class="hs-identifier hs-var">insts'</span></a><span>
</span><a name="line-271"></a><span>                                 </span><a name="local-6989586621679208436"><a href="#local-6989586621679208436"><span class="hs-identifier">newDerivedEqDecs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#singDerivedEqDecs"><span class="hs-identifier hs-var">singDerivedEqDecs</span></a><span> </span><a href="#local-6989586621679208422"><span class="hs-identifier hs-var">derivedEqDecs</span></a><span>
</span><a name="line-272"></a><span>                                 </span><a name="local-6989586621679208437"><a href="#local-6989586621679208437"><span class="hs-identifier">newDerivedShowDecs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="Data.Singletons.Single.html#singDerivedShowDecs"><span class="hs-identifier hs-var">singDerivedShowDecs</span></a><span> </span><a href="#local-6989586621679208423"><span class="hs-identifier hs-var">derivedShowDecs</span></a><span>
</span><a name="line-273"></a><span>                                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679208433"><span class="hs-identifier hs-var">newDataDecls</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208434"><span class="hs-identifier hs-var">newClassDecls</span></a><span>
</span><a name="line-274"></a><span>                                                       </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208435"><span class="hs-identifier hs-var">newInstDecls</span></a><span>
</span><a name="line-275"></a><span>                                                       </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208436"><span class="hs-identifier hs-var">newDerivedEqDecs</span></a><span>
</span><a name="line-276"></a><span>                                                       </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208437"><span class="hs-identifier hs-var">newDerivedShowDecs</span></a><span>
</span><a name="line-277"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679208431"><span class="hs-identifier hs-var">promDecls</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DLetDec</span><span> </span><a href="#local-6989586621679208438"><span class="hs-identifier hs-var">newLetDecls</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208439"><span class="hs-identifier hs-var">singIDefunDecls</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208440"><span class="hs-identifier hs-var">newDecls</span></a><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-comment">-- see comment at top of file</span><span>
</span><a name="line-280"></a><span class="hs-identifier">buildDataLets</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DExp</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-281"></a><a name="buildDataLets"><a href="Data.Singletons.Single.html#buildDataLets"><span class="hs-identifier">buildDataLets</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><a name="local-6989586621679208441"><a href="#local-6989586621679208441"><span class="hs-identifier">_name</span></a></a><span> </span><a name="local-6989586621679208442"><a href="#local-6989586621679208442"><span class="hs-identifier">_tvbs</span></a></a><span> </span><a name="local-6989586621679208443"><a href="#local-6989586621679208443"><span class="hs-identifier">cons</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621679208444"><span class="hs-identifier hs-var">con_num_args</span></a><span> </span><a href="#local-6989586621679208443"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-283"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-identifier">con_num_args</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DExp</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-285"></a><span>    </span><a name="local-6989586621679208444"><a href="#local-6989586621679208444"><span class="hs-identifier">con_num_args</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DCon</span><span> </span><a name="local-6989586621679208446"><a href="#local-6989586621679208446"><span class="hs-identifier">_tvbs</span></a></a><span> </span><a name="local-6989586621679208447"><a href="#local-6989586621679208447"><span class="hs-identifier">_cxt</span></a></a><span> </span><a name="local-6989586621679208448"><a href="#local-6989586621679208448"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679208449"><a href="#local-6989586621679208449"><span class="hs-identifier">fields</span></a></a><span> </span><a name="local-6989586621679208450"><a href="#local-6989586621679208450"><span class="hs-identifier">_rty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-286"></a><span>      </span><span class="hs-special">(</span><a href="#local-6989586621679208448"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#tysOfConFields"><span class="hs-identifier hs-var">tysOfConFields</span></a><span> </span><a href="#local-6989586621679208449"><span class="hs-identifier hs-var">fields</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>                         </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679208448"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Names.html#singDataConName"><span class="hs-identifier hs-var">singDataConName</span></a><span> </span><a href="#local-6989586621679208448"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>      </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679208445"><span class="hs-identifier hs-var">rec_selectors</span></a><span> </span><a href="#local-6989586621679208449"><span class="hs-identifier hs-var">fields</span></a><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span>    </span><span class="hs-identifier">rec_selectors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DConFields</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DExp</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-291"></a><span>    </span><a name="local-6989586621679208445"><a href="#local-6989586621679208445"><span class="hs-identifier">rec_selectors</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DNormalC</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-identifier">rec_selectors</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DRecC</span><span> </span><a name="local-6989586621679208451"><a href="#local-6989586621679208451"><span class="hs-identifier">fields</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-293"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208452"><a href="#local-6989586621679208452"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#fstOf3"><span class="hs-identifier hs-var">fstOf3</span></a><span> </span><a href="#local-6989586621679208451"><span class="hs-identifier hs-var">fields</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-294"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208453"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679208453"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208453"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679208453"><a href="#local-6989586621679208453"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208452"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-comment">-- see comment at top of file</span><span>
</span><a name="line-298"></a><span class="hs-identifier">buildMethLets</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#UClassDecl"><span class="hs-identifier hs-type">UClassDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DExp</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-299"></a><a name="buildMethLets"><a href="Data.Singletons.Single.html#buildMethLets"><span class="hs-identifier">buildMethLets</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier hs-var">ClassDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cd_lde</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_types</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208454"><a href="#local-6989586621679208454"><span class="hs-identifier">meth_sigs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-300"></a><span>  </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679208455"><span class="hs-identifier hs-var">mk_bind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679208454"><span class="hs-identifier hs-var">meth_sigs</span></a><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-302"></a><span>    </span><a name="local-6989586621679208455"><a href="#local-6989586621679208455"><span class="hs-identifier">mk_bind</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679208456"><a href="#local-6989586621679208456"><span class="hs-identifier">meth_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208457"><a href="#local-6989586621679208457"><span class="hs-identifier">meth_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-303"></a><span>      </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621679208456"><span class="hs-identifier hs-var">meth_name</span></a><span>
</span><a name="line-304"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a><span> </span><a href="#local-6989586621679208457"><span class="hs-identifier hs-var">meth_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679208456"><span class="hs-identifier hs-var">meth_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208456"><span class="hs-identifier hs-var">meth_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-identifier">singClassD</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#AClassDecl"><span class="hs-identifier hs-type">AClassDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DDec</span><span>
</span><a name="line-308"></a><a name="singClassD"><a href="Data.Singletons.Single.html#singClassD"><span class="hs-identifier">singClassD</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier hs-var">ClassDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cd_cxt</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208458"><a href="#local-6989586621679208458"><span class="hs-identifier">cls_cxt</span></a></a><span>
</span><a name="line-309"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208459"><a href="#local-6989586621679208459"><span class="hs-identifier">cls_name</span></a></a><span>
</span><a name="line-310"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cd_tvbs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208460"><a href="#local-6989586621679208460"><span class="hs-identifier">cls_tvbs</span></a></a><span>
</span><a name="line-311"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cd_fds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208461"><a href="#local-6989586621679208461"><span class="hs-identifier">cls_fundeps</span></a></a><span>
</span><a name="line-312"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cd_lde</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_defns</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208462"><a href="#local-6989586621679208462"><span class="hs-identifier">default_defns</span></a></a><span>
</span><a name="line-313"></a><span>                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_types</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208463"><a href="#local-6989586621679208463"><span class="hs-identifier">meth_sigs</span></a></a><span>
</span><a name="line-314"></a><span>                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_infix</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208464"><a href="#local-6989586621679208464"><span class="hs-identifier">fixities</span></a></a><span>
</span><a name="line-315"></a><span>                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_proms</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208465"><a href="#local-6989586621679208465"><span class="hs-identifier">promoted_defaults</span></a></a><span>
</span><a name="line-316"></a><span>                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_bound_kvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208466"><a href="#local-6989586621679208466"><span class="hs-identifier">meth_bound_kvs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-317"></a><span>  </span><a href="Data.Singletons.Single.Monad.html#bindContext"><span class="hs-identifier hs-var">bindContext</span></a><span> </span><span class="hs-special">[</span><a href="Data.Singletons.Util.html#foldPredTvbs"><span class="hs-identifier hs-var">foldPredTvbs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConPr</span><span> </span><a href="#local-6989586621679208459"><span class="hs-identifier hs-var">cls_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208460"><span class="hs-identifier hs-var">cls_tvbs</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-318"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679208490"><a href="#local-6989586621679208490"><span class="hs-identifier">sing_sigs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679208491"><a href="#local-6989586621679208491"><span class="hs-identifier">tyvar_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208492"><a href="#local-6989586621679208492"><span class="hs-identifier">cxts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208493"><a href="#local-6989586621679208493"><span class="hs-identifier">res_kis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208494"><a href="#local-6989586621679208494"><span class="hs-identifier">singIDefunss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unzip6</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.html#singTySig"><span class="hs-identifier hs-var">singTySig</span></a><span> </span><a href="#local-6989586621679208467"><span class="hs-identifier hs-var">no_meth_defns</span></a><span> </span><a href="#local-6989586621679208463"><span class="hs-identifier hs-var">meth_sigs</span></a><span> </span><a href="#local-6989586621679208466"><span class="hs-identifier hs-var">meth_bound_kvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>                             </span><a href="#local-6989586621679208469"><span class="hs-identifier hs-var">meth_names</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679208469"><span class="hs-identifier hs-var">meth_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>    </span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621679208494"><span class="hs-identifier hs-var">singIDefunss</span></a><span>
</span><a name="line-322"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208495"><a href="#local-6989586621679208495"><span class="hs-identifier">default_sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-323"></a><span>                       </span><span class="hs-identifier hs-var">zipWith4</span><span> </span><a href="#local-6989586621679208470"><span class="hs-identifier hs-var">mk_default_sig</span></a><span> </span><a href="#local-6989586621679208469"><span class="hs-identifier hs-var">meth_names</span></a><span> </span><a href="#local-6989586621679208490"><span class="hs-identifier hs-var">sing_sigs</span></a><span> </span><a href="#local-6989586621679208491"><span class="hs-identifier hs-var">tyvar_names</span></a><span> </span><a href="#local-6989586621679208493"><span class="hs-identifier hs-var">res_kis</span></a><span>
</span><a name="line-324"></a><span>        </span><a name="local-6989586621679208496"><a href="#local-6989586621679208496"><span class="hs-identifier">res_ki_map</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679208469"><span class="hs-identifier hs-var">meth_names</span></a><span>
</span><a name="line-325"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621679208468"><span class="hs-identifier hs-var">always_sig</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208493"><span class="hs-identifier hs-var">res_kis</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>    </span><a name="local-6989586621679208497"><a href="#local-6989586621679208497"><span class="hs-identifier">sing_meths</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.html#singLetDecRHS"><span class="hs-identifier hs-var">singLetDecRHS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679208491"><span class="hs-identifier hs-var">tyvar_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>                                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679208492"><span class="hs-identifier hs-var">cxts</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>                                               </span><a href="#local-6989586621679208496"><span class="hs-identifier hs-var">res_ki_map</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-329"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679208462"><span class="hs-identifier hs-var">default_defns</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>    </span><a name="local-6989586621679208498"><a href="#local-6989586621679208498"><span class="hs-identifier">fixities'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Data.Singletons.Single.Fixity.html#singInfixDecl"><span class="hs-identifier hs-var">singInfixDecl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679208464"><span class="hs-identifier hs-var">fixities</span></a><span>
</span><a name="line-331"></a><span>    </span><a name="local-6989586621679208499"><a href="#local-6989586621679208499"><span class="hs-identifier">cls_cxt'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Single.Type.html#singPred"><span class="hs-identifier hs-var">singPred</span></a><span> </span><a href="#local-6989586621679208458"><span class="hs-identifier hs-var">cls_cxt</span></a><span>
</span><a name="line-332"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DClassD</span><span> </span><a href="#local-6989586621679208499"><span class="hs-identifier hs-var">cls_cxt'</span></a><span>
</span><a name="line-333"></a><span>                     </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singClassName"><span class="hs-identifier hs-var">singClassName</span></a><span> </span><a href="#local-6989586621679208459"><span class="hs-identifier hs-var">cls_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>                     </span><a href="#local-6989586621679208460"><span class="hs-identifier hs-var">cls_tvbs</span></a><span>
</span><a name="line-335"></a><span>                     </span><a href="#local-6989586621679208461"><span class="hs-identifier hs-var">cls_fundeps</span></a><span>   </span><span class="hs-comment">-- they are fine without modification</span><span>
</span><a name="line-336"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DLetDec</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208490"><span class="hs-identifier hs-var">sing_sigs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208497"><span class="hs-identifier hs-var">sing_meths</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208498"><span class="hs-identifier hs-var">fixities'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208495"><span class="hs-identifier hs-var">default_sigs</span></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-338"></a><span>    </span><a name="local-6989586621679208467"><a href="#local-6989586621679208467"><span class="hs-identifier">no_meth_defns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Internal error: can't find declared method type&quot;</span><span>
</span><a name="line-339"></a><span>    </span><a name="local-6989586621679208468"><a href="#local-6989586621679208468"><span class="hs-identifier">always_sig</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Internal error: no signature for default method&quot;</span><span>
</span><a name="line-340"></a><span>    </span><a name="local-6989586621679208469"><a href="#local-6989586621679208469"><span class="hs-identifier">meth_names</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keys</span><span> </span><a href="#local-6989586621679208463"><span class="hs-identifier hs-var">meth_sigs</span></a><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span>    </span><a name="local-6989586621679208470"><a href="#local-6989586621679208470"><span class="hs-identifier">mk_default_sig</span></a></a><span> </span><a name="local-6989586621679208472"><a href="#local-6989586621679208472"><span class="hs-identifier">meth_name</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DSigD</span><span> </span><a name="local-6989586621679208473"><a href="#local-6989586621679208473"><span class="hs-identifier">s_name</span></a></a><span> </span><a name="local-6989586621679208474"><a href="#local-6989586621679208474"><span class="hs-identifier">sty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679208475"><a href="#local-6989586621679208475"><span class="hs-identifier">bound_kvs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679208476"><a href="#local-6989586621679208476"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-343"></a><span>      </span><span class="hs-identifier hs-var">DDefaultSigD</span><span> </span><a href="#local-6989586621679208473"><span class="hs-identifier hs-var">s_name</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679208471"><span class="hs-identifier hs-var">add_constraints</span></a><span> </span><a href="#local-6989586621679208472"><span class="hs-identifier hs-var">meth_name</span></a><span> </span><a href="#local-6989586621679208474"><span class="hs-identifier hs-var">sty</span></a><span> </span><a href="#local-6989586621679208475"><span class="hs-identifier hs-var">bound_kvs</span></a><span> </span><a href="#local-6989586621679208476"><span class="hs-identifier hs-var">res_ki</span></a><span>
</span><a name="line-344"></a><span>    </span><span class="hs-identifier">mk_default_sig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Internal error: a singled signature isn't a signature.&quot;</span><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span>    </span><a name="local-6989586621679208471"><a href="#local-6989586621679208471"><span class="hs-identifier">add_constraints</span></a></a><span> </span><a name="local-6989586621679208477"><a href="#local-6989586621679208477"><span class="hs-identifier">meth_name</span></a></a><span> </span><a name="local-6989586621679208478"><a href="#local-6989586621679208478"><span class="hs-identifier">sty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679208479"><a href="#local-6989586621679208479"><span class="hs-identifier">bound_kvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679208480"><a href="#local-6989586621679208480"><span class="hs-identifier">res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- Maybe monad</span><span>
</span><a name="line-347"></a><span>      </span><a name="local-6989586621679208488"><a href="#local-6989586621679208488"><span class="hs-identifier">prom_dflt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679208477"><span class="hs-identifier hs-var">meth_name</span></a><span> </span><a href="#local-6989586621679208465"><span class="hs-identifier hs-var">promoted_defaults</span></a><span>
</span><a name="line-348"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208489"><a href="#local-6989586621679208489"><span class="hs-identifier">default_pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Util.html#foldPred"><span class="hs-identifier hs-var">foldPred</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConPr</span><span> </span><a href="Data.Singletons.Names.html#equalityName"><span class="hs-identifier hs-var">equalityName</span></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>                                </span><span class="hs-comment">-- NB: Need the res_ki here to prevent ambiguous</span><span>
</span><a name="line-350"></a><span>                                </span><span class="hs-comment">-- kinds in result-inferred default methods.</span><span>
</span><a name="line-351"></a><span>                                </span><span class="hs-comment">-- See #175</span><span>
</span><a name="line-352"></a><span>                               </span><span class="hs-special">[</span><span> </span><a href="Data.Singletons.Names.html#foldApply"><span class="hs-identifier hs-var">foldApply</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679208477"><span class="hs-identifier hs-var">meth_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208486"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DSigT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208480"><span class="hs-identifier hs-var">res_ki</span></a><span>
</span><a name="line-353"></a><span>                               </span><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Names.html#foldApply"><span class="hs-identifier hs-var">foldApply</span></a><span> </span><a href="#local-6989586621679208488"><span class="hs-identifier hs-var">prom_dflt</span></a><span> </span><a href="#local-6989586621679208486"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-354"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DForallT</span><span> </span><a href="#local-6989586621679208481"><span class="hs-identifier hs-var">tvbs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208489"><span class="hs-identifier hs-var">default_pred</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679208482"><span class="hs-identifier hs-var">cxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#ravel"><span class="hs-identifier hs-var">ravel</span></a><span> </span><a href="#local-6989586621679208483"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621679208484"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-356"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679208481"><a href="#local-6989586621679208481"><span class="hs-identifier">tvbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208482"><a href="#local-6989586621679208482"><span class="hs-identifier">cxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208483"><a href="#local-6989586621679208483"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208484"><a href="#local-6989586621679208484"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unravel</span><span> </span><a href="#local-6989586621679208478"><span class="hs-identifier hs-var">sty</span></a><span>
</span><a name="line-357"></a><span>        </span><a name="local-6989586621679208485"><a href="#local-6989586621679208485"><span class="hs-identifier">bound_kv_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621679208479"><span class="hs-identifier hs-var">bound_kvs</span></a><span>
</span><a name="line-358"></a><span>        </span><span class="hs-comment">-- Filter out explicitly bound kind variables. Otherwise, if you had</span><span>
</span><a name="line-359"></a><span>        </span><span class="hs-comment">-- the following class (#312):</span><span>
</span><a name="line-360"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-361"></a><span>        </span><span class="hs-comment">--  class Foo a where</span><span>
</span><a name="line-362"></a><span>        </span><span class="hs-comment">--    bar :: a -&gt; b -&gt; b</span><span>
</span><a name="line-363"></a><span>        </span><span class="hs-comment">--    bar _ x = x</span><span>
</span><a name="line-364"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-365"></a><span>        </span><span class="hs-comment">-- Then it would be singled to:</span><span>
</span><a name="line-366"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-367"></a><span>        </span><span class="hs-comment">--  class SFoo a where</span><span>
</span><a name="line-368"></a><span>        </span><span class="hs-comment">--    sBar :: forall b (x :: a) (y :: b). Sing x -&gt; Sing y -&gt; Sing (sBar x y)</span><span>
</span><a name="line-369"></a><span>        </span><span class="hs-comment">--    default :: forall b (x :: a) (y :: b).</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-comment">--               (Bar b x y) ~ (BarDefault b x y) =&gt; ...</span><span>
</span><a name="line-371"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-372"></a><span>        </span><span class="hs-comment">-- Which applies Bar/BarDefault to b, which shouldn't happen.</span><span>
</span><a name="line-373"></a><span>        </span><a name="local-6989586621679208486"><a href="#local-6989586621679208486"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#tvbToType"><span class="hs-identifier hs-var">tvbToType</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-374"></a><span>              </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679208487"><a href="#local-6989586621679208487"><span class="hs-identifier">tvb</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679208487"><span class="hs-identifier hs-var">tvb</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208485"><span class="hs-identifier hs-var">bound_kv_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208481"><span class="hs-identifier hs-var">tvbs</span></a><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-identifier">singInstD</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#AInstDecl"><span class="hs-identifier hs-type">AInstDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DDec</span><span>
</span><a name="line-378"></a><a name="singInstD"><a href="Data.Singletons.Single.html#singInstD"><span class="hs-identifier">singInstD</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#InstDecl"><span class="hs-identifier hs-var">InstDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">id_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208500"><a href="#local-6989586621679208500"><span class="hs-identifier">cxt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">id_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208501"><a href="#local-6989586621679208501"><span class="hs-identifier">inst_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">id_arg_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208502"><a href="#local-6989586621679208502"><span class="hs-identifier">inst_tys</span></a></a><span>
</span><a name="line-379"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">id_sigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208503"><a href="#local-6989586621679208503"><span class="hs-identifier">inst_sigs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">id_meths</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208504"><a href="#local-6989586621679208504"><span class="hs-identifier">ann_meths</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-380"></a><span>  </span><a href="Data.Singletons.Single.Monad.html#bindContext"><span class="hs-identifier hs-var">bindContext</span></a><span> </span><a href="#local-6989586621679208500"><span class="hs-identifier hs-var">cxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-381"></a><span>    </span><a name="local-6989586621679208560"><a href="#local-6989586621679208560"><span class="hs-identifier">cxt'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Single.Type.html#singPred"><span class="hs-identifier hs-var">singPred</span></a><span> </span><a href="#local-6989586621679208500"><span class="hs-identifier hs-var">cxt</span></a><span>
</span><a name="line-382"></a><span>    </span><a name="local-6989586621679208561"><a href="#local-6989586621679208561"><span class="hs-identifier">inst_kis</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679208502"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-383"></a><span>    </span><a name="local-6989586621679208562"><a href="#local-6989586621679208562"><span class="hs-identifier">meths</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="#local-6989586621679208506"><span class="hs-identifier hs-var">sing_meth</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208504"><span class="hs-identifier hs-var">ann_meths</span></a><span>
</span><a name="line-384"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DInstanceD</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-385"></a><span>                       </span><a href="#local-6989586621679208560"><span class="hs-identifier hs-var">cxt'</span></a><span>
</span><a name="line-386"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl</span><span> </span><span class="hs-identifier hs-var">DAppT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="#local-6989586621679208505"><span class="hs-identifier hs-var">s_inst_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208561"><span class="hs-identifier hs-var">inst_kis</span></a><span class="hs-special">)</span><span>
</span><a name="line-387"></a><span>                       </span><a href="#local-6989586621679208562"><span class="hs-identifier hs-var">meths</span></a><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-390"></a><span>    </span><a name="local-6989586621679208505"><a href="#local-6989586621679208505"><span class="hs-identifier">s_inst_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#singClassName"><span class="hs-identifier hs-var">singClassName</span></a><span> </span><a href="#local-6989586621679208501"><span class="hs-identifier hs-var">inst_name</span></a><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span>    </span><span class="hs-identifier">sing_meth</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-393"></a><span>    </span><a name="local-6989586621679208506"><a href="#local-6989586621679208506"><span class="hs-identifier">sing_meth</span></a></a><span> </span><a name="local-6989586621679208507"><a href="#local-6989586621679208507"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679208508"><a href="#local-6989586621679208508"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-394"></a><span>      </span><a name="local-6989586621679208509"><a href="#local-6989586621679208509"><span class="hs-identifier">mb_s_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">dsReify</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>      </span><a name="local-6989586621679208510"><a href="#local-6989586621679208510"><span class="hs-identifier">inst_kis</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679208502"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-396"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208511"><a href="#local-6989586621679208511"><span class="hs-identifier">mk_subst</span></a></a><span> </span><a name="local-6989586621679208513"><a href="#local-6989586621679208513"><span class="hs-identifier">cls_tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679208514"><span class="hs-identifier hs-var">vis_cls_tvbs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208510"><span class="hs-identifier hs-var">inst_kis</span></a><span>
</span><a name="line-397"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-398"></a><span>              </span><span class="hs-comment">-- This is a half-hearted attempt to address the underlying problem</span><span>
</span><a name="line-399"></a><span>              </span><span class="hs-comment">-- in #358, where we can sometimes have more class type variables</span><span>
</span><a name="line-400"></a><span>              </span><span class="hs-comment">-- (due to implicit kind arguments) than class arguments. This just</span><span>
</span><a name="line-401"></a><span>              </span><span class="hs-comment">-- ensures that the explicit type variables are properly mapped</span><span>
</span><a name="line-402"></a><span>              </span><span class="hs-comment">-- to the class arguments, leaving the implicit kind variables</span><span>
</span><a name="line-403"></a><span>              </span><span class="hs-comment">-- unmapped. That could potentially cause *other* problems, but</span><span>
</span><a name="line-404"></a><span>              </span><span class="hs-comment">-- those are perhaps best avoided by using InstanceSigs. At the</span><span>
</span><a name="line-405"></a><span>              </span><span class="hs-comment">-- very least, this workaround will make error messages slightly</span><span>
</span><a name="line-406"></a><span>              </span><span class="hs-comment">-- less confusing.</span><span>
</span><a name="line-407"></a><span>              </span><a name="local-6989586621679208514"><a href="#local-6989586621679208514"><span class="hs-identifier">vis_cls_tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679208513"><span class="hs-identifier hs-var">cls_tvbs</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679208510"><span class="hs-identifier hs-var">inst_kis</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208513"><span class="hs-identifier hs-var">cls_tvbs</span></a><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span>          </span><span class="hs-identifier">sing_meth_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-410"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DCxt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DKind</span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>          </span><a name="local-6989586621679208512"><a href="#local-6989586621679208512"><span class="hs-identifier">sing_meth_ty</span></a></a><span> </span><a name="local-6989586621679208515"><a href="#local-6989586621679208515"><span class="hs-identifier">bound_kvs</span></a></a><span> </span><a name="local-6989586621679208516"><a href="#local-6989586621679208516"><span class="hs-identifier">inner_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-412"></a><span>            </span><span class="hs-comment">-- Make sure to expand through type synonyms here! Not doing so</span><span>
</span><a name="line-413"></a><span>            </span><span class="hs-comment">-- resulted in #167.</span><span>
</span><a name="line-414"></a><span>            </span><a name="local-6989586621679208517"><a href="#local-6989586621679208517"><span class="hs-identifier">raw_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">expand</span><span> </span><a href="#local-6989586621679208516"><span class="hs-identifier hs-var">inner_ty</span></a><span>
</span><a name="line-415"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621679208518"><a href="#local-6989586621679208518"><span class="hs-identifier">s_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208519"><a href="#local-6989586621679208519"><span class="hs-identifier">_num_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208520"><a href="#local-6989586621679208520"><span class="hs-identifier">tyvar_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208521"><a href="#local-6989586621679208521"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208522"><a href="#local-6989586621679208522"><span class="hs-identifier">_arg_kis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208523"><a href="#local-6989586621679208523"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Type.html#singType"><span class="hs-identifier hs-var">singType</span></a><span> </span><a href="#local-6989586621679208515"><span class="hs-identifier hs-var">bound_kvs</span></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208517"><span class="hs-identifier hs-var">raw_ty</span></a><span>
</span><a name="line-417"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208518"><span class="hs-identifier hs-var">s_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208520"><span class="hs-identifier hs-var">tyvar_names</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208521"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208523"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679208554"><a href="#local-6989586621679208554"><span class="hs-identifier">s_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208555"><a href="#local-6989586621679208555"><span class="hs-identifier">tyvar_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208556"><a href="#local-6989586621679208556"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208557"><a href="#local-6989586621679208557"><span class="hs-identifier">m_res_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208503"><span class="hs-identifier hs-var">inst_sigs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-420"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679208524"><a href="#local-6989586621679208524"><span class="hs-identifier">inst_sig</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-421"></a><span>          </span><span class="hs-comment">-- We have an InstanceSig, so just single that type. Take care to</span><span>
</span><a name="line-422"></a><span>          </span><span class="hs-comment">-- avoid binding the variables bound by the instance head as well.</span><span>
</span><a name="line-423"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208525"><a href="#local-6989586621679208525"><span class="hs-identifier">inst_bound</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">fvDPred</span><span> </span><a href="#local-6989586621679208500"><span class="hs-identifier hs-var">cxt</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">fvDType</span><span> </span><a href="#local-6989586621679208510"><span class="hs-identifier hs-var">inst_kis</span></a><span>
</span><a name="line-424"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621679208526"><a href="#local-6989586621679208526"><span class="hs-identifier">s_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208527"><a href="#local-6989586621679208527"><span class="hs-identifier">tyvar_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208528"><a href="#local-6989586621679208528"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208529"><a href="#local-6989586621679208529"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208512"><span class="hs-identifier hs-var">sing_meth_ty</span></a><span> </span><a href="#local-6989586621679208525"><span class="hs-identifier hs-var">inst_bound</span></a><span> </span><a href="#local-6989586621679208524"><span class="hs-identifier hs-var">inst_sig</span></a><span>
</span><a name="line-425"></a><span>          </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208526"><span class="hs-identifier hs-var">s_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208527"><span class="hs-identifier hs-var">tyvar_names</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208528"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679208529"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679208509"><span class="hs-identifier hs-var">mb_s_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-427"></a><span>          </span><span class="hs-comment">-- We don't have an InstanceSig, so we must compute the type to use</span><span>
</span><a name="line-428"></a><span>          </span><span class="hs-comment">-- in the singled instance ourselves through reification.</span><span>
</span><a name="line-429"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarI</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DForallT</span><span> </span><a name="local-6989586621679208530"><a href="#local-6989586621679208530"><span class="hs-identifier">cls_tvbs</span></a></a><span> </span><a name="local-6989586621679208531"><a href="#local-6989586621679208531"><span class="hs-identifier">_cls_pred</span></a></a><span> </span><a name="local-6989586621679208532"><a href="#local-6989586621679208532"><span class="hs-identifier">s_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-430"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208533"><a href="#local-6989586621679208533"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679208511"><span class="hs-identifier hs-var">mk_subst</span></a><span> </span><a href="#local-6989586621679208530"><span class="hs-identifier hs-var">cls_tvbs</span></a><span>
</span><a name="line-431"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679208534"><a href="#local-6989586621679208534"><span class="hs-identifier">sing_tvbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208535"><a href="#local-6989586621679208535"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208536"><a href="#local-6989586621679208536"><span class="hs-identifier">_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208537"><a href="#local-6989586621679208537"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unravel</span><span> </span><a href="#local-6989586621679208532"><span class="hs-identifier hs-var">s_ty</span></a><span>
</span><a name="line-432"></a><span>                </span><a name="local-6989586621679208538"><a href="#local-6989586621679208538"><span class="hs-identifier">m_res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679208537"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-433"></a><span>                  </span><a name="local-6989586621679208539"><a href="#local-6989586621679208539"><span class="hs-identifier">_sing</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679208540"><a href="#local-6989586621679208540"><span class="hs-identifier">_prom_func</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DSigT</span><span class="hs-special">`</span><span> </span><a name="local-6989586621679208541"><a href="#local-6989586621679208541"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#substKind"><span class="hs-identifier hs-var">substKind</span></a><span> </span><a href="#local-6989586621679208533"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621679208541"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>                  </span><span class="hs-identifier">_</span><span>                                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span> </span><a href="Data.Singletons.Util.html#substType"><span class="hs-identifier hs-var">substType</span></a><span> </span><a href="#local-6989586621679208533"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621679208532"><span class="hs-identifier hs-var">s_ty</span></a><span>
</span><a name="line-437"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679208534"><span class="hs-identifier hs-var">sing_tvbs</span></a><span>
</span><a name="line-438"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#substPred"><span class="hs-identifier hs-var">substPred</span></a><span> </span><a href="#local-6989586621679208533"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208535"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-439"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208538"><span class="hs-identifier hs-var">m_res_ki</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-441"></a><span>            </span><a name="local-6989586621679208542"><a href="#local-6989586621679208542"><span class="hs-identifier">mb_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">dsReify</span><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-442"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679208542"><span class="hs-identifier hs-var">mb_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-443"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarI</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DForallT</span><span> </span><a name="local-6989586621679208543"><a href="#local-6989586621679208543"><span class="hs-identifier">cls_tvbs</span></a></a><span> </span><a name="local-6989586621679208544"><a href="#local-6989586621679208544"><span class="hs-identifier">_cls_pred</span></a></a><span> </span><a name="local-6989586621679208545"><a href="#local-6989586621679208545"><span class="hs-identifier">inner_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-444"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208546"><a href="#local-6989586621679208546"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679208511"><span class="hs-identifier hs-var">mk_subst</span></a><span> </span><a href="#local-6989586621679208543"><span class="hs-identifier hs-var">cls_tvbs</span></a><span>
</span><a name="line-445"></a><span>                    </span><a name="local-6989586621679208547"><a href="#local-6989586621679208547"><span class="hs-identifier">cls_kvb_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">fvDType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208543"><span class="hs-identifier hs-var">cls_tvbs</span></a><span>
</span><a name="line-446"></a><span>                    </span><a name="local-6989586621679208548"><a href="#local-6989586621679208548"><span class="hs-identifier">cls_tvb_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a><span> </span><a href="#local-6989586621679208543"><span class="hs-identifier hs-var">cls_tvbs</span></a><span>
</span><a name="line-447"></a><span>                    </span><a name="local-6989586621679208549"><a href="#local-6989586621679208549"><span class="hs-identifier">cls_bound</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679208547"><span class="hs-identifier hs-var">cls_kvb_names</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208548"><span class="hs-identifier hs-var">cls_tvb_names</span></a><span>
</span><a name="line-448"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621679208550"><a href="#local-6989586621679208550"><span class="hs-identifier">s_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208551"><a href="#local-6989586621679208551"><span class="hs-identifier">tyvar_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208552"><a href="#local-6989586621679208552"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208553"><a href="#local-6989586621679208553"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208512"><span class="hs-identifier hs-var">sing_meth_ty</span></a><span> </span><a href="#local-6989586621679208549"><span class="hs-identifier hs-var">cls_bound</span></a><span> </span><a href="#local-6989586621679208545"><span class="hs-identifier hs-var">inner_ty</span></a><span>
</span><a name="line-449"></a><span>                </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span> </span><a href="Data.Singletons.Util.html#substType"><span class="hs-identifier hs-var">substType</span></a><span> </span><a href="#local-6989586621679208546"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621679208550"><span class="hs-identifier hs-var">s_ty</span></a><span>
</span><a name="line-450"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208551"><span class="hs-identifier hs-var">tyvar_names</span></a><span>
</span><a name="line-451"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208552"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-452"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#substKind"><span class="hs-identifier hs-var">substKind</span></a><span> </span><a href="#local-6989586621679208546"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621679208553"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Cannot find type of method &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208558"><a href="#local-6989586621679208558"><span class="hs-identifier">kind_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.singleton</span><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208557"><span class="hs-identifier hs-var">m_res_ki</span></a><span>
</span><a name="line-456"></a><span>      </span><a name="local-6989586621679208559"><a href="#local-6989586621679208559"><span class="hs-identifier">meth'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singLetDecRHS"><span class="hs-identifier hs-var">singLetDecRHS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.singleton</span><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208555"><span class="hs-identifier hs-var">tyvar_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-457"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.singleton</span><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208556"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>                             </span><a href="#local-6989586621679208558"><span class="hs-identifier hs-var">kind_map</span></a><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208508"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-459"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DLetDec</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DSigD</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208507"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208554"><span class="hs-identifier hs-var">s_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208559"><span class="hs-identifier hs-var">meth'</span></a><span class="hs-special">]</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-identifier">singLetDecEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#ALetDecEnv"><span class="hs-identifier hs-type">ALetDecEnv</span></a><span>
</span><a name="line-462"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><a href="#local-6989586621679208332"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-463"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">DLetDec</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208332"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>                 </span><span class="hs-comment">-- Return:</span><span>
</span><a name="line-465"></a><span>                 </span><span class="hs-comment">--</span><span>
</span><a name="line-466"></a><span>                 </span><span class="hs-comment">-- 1. The singled let-decs</span><span>
</span><a name="line-467"></a><span>                 </span><span class="hs-comment">-- 2. SingI instances for any defunctionalization symbols</span><span>
</span><a name="line-468"></a><span>                 </span><span class="hs-comment">--    (see Data.Singletons.Single.Defun)</span><span>
</span><a name="line-469"></a><span>                 </span><span class="hs-comment">-- 3. The result of running the `SgM a` action</span><span>
</span><a name="line-470"></a><a name="singLetDecEnv"><a href="Data.Singletons.Single.html#singLetDecEnv"><span class="hs-identifier">singLetDecEnv</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-var">LetDecEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lde_defns</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208563"><a href="#local-6989586621679208563"><span class="hs-identifier">defns</span></a></a><span>
</span><a name="line-471"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_types</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208564"><a href="#local-6989586621679208564"><span class="hs-identifier">types</span></a></a><span>
</span><a name="line-472"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_infix</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208565"><a href="#local-6989586621679208565"><span class="hs-identifier">infix_decls</span></a></a><span>
</span><a name="line-473"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_proms</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208566"><a href="#local-6989586621679208566"><span class="hs-identifier">proms</span></a></a><span>
</span><a name="line-474"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lde_bound_kvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208567"><a href="#local-6989586621679208567"><span class="hs-identifier">bound_kvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span>              </span><a name="local-6989586621679208568"><a href="#local-6989586621679208568"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-476"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208569"><a href="#local-6989586621679208569"><span class="hs-identifier">prom_list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679208566"><span class="hs-identifier hs-var">proms</span></a><span>
</span><a name="line-477"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208570"><a href="#local-6989586621679208570"><span class="hs-identifier">typeSigs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208571"><a href="#local-6989586621679208571"><span class="hs-identifier">letBinds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208572"><a href="#local-6989586621679208572"><span class="hs-identifier">tyvarNames</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208573"><a href="#local-6989586621679208573"><span class="hs-identifier">cxts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208574"><a href="#local-6989586621679208574"><span class="hs-identifier">res_kis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208575"><a href="#local-6989586621679208575"><span class="hs-identifier">singIDefunss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-478"></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unzip6</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.html#singTySig"><span class="hs-identifier hs-var">singTySig</span></a><span> </span><a href="#local-6989586621679208563"><span class="hs-identifier hs-var">defns</span></a><span> </span><a href="#local-6989586621679208564"><span class="hs-identifier hs-var">types</span></a><span> </span><a href="#local-6989586621679208567"><span class="hs-identifier hs-var">bound_kvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208569"><span class="hs-identifier hs-var">prom_list</span></a><span>
</span><a name="line-479"></a><span>  </span><a name="local-6989586621679208576"><a href="#local-6989586621679208576"><span class="hs-identifier">infix_decls'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Data.Singletons.Single.Fixity.html#singInfixDecl"><span class="hs-identifier hs-var">singInfixDecl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679208565"><span class="hs-identifier hs-var">infix_decls</span></a><span>
</span><a name="line-480"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208577"><a href="#local-6989586621679208577"><span class="hs-identifier">res_ki_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208578"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208579"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679208578"><a href="#local-6989586621679208578"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679208579"><a href="#local-6989586621679208579"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-481"></a><span>                                                     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679208569"><span class="hs-identifier hs-var">prom_list</span></a><span> </span><a href="#local-6989586621679208574"><span class="hs-identifier hs-var">res_kis</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-482"></a><span>  </span><a href="Data.Singletons.Single.Monad.html#bindLets"><span class="hs-identifier hs-var">bindLets</span></a><span> </span><a href="#local-6989586621679208571"><span class="hs-identifier hs-var">letBinds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-483"></a><span>    </span><a name="local-6989586621679208580"><a href="#local-6989586621679208580"><span class="hs-identifier">let_decs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.html#singLetDecRHS"><span class="hs-identifier hs-var">singLetDecRHS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679208572"><span class="hs-identifier hs-var">tyvarNames</span></a><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679208573"><span class="hs-identifier hs-var">cxts</span></a><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>                                             </span><a href="#local-6989586621679208577"><span class="hs-identifier hs-var">res_ki_map</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679208563"><span class="hs-identifier hs-var">defns</span></a><span class="hs-special">)</span><span>
</span><a name="line-487"></a><span>    </span><a name="local-6989586621679208581"><a href="#local-6989586621679208581"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208568"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-488"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208576"><span class="hs-identifier hs-var">infix_decls'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208570"><span class="hs-identifier hs-var">typeSigs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208580"><span class="hs-identifier hs-var">let_decs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621679208575"><span class="hs-identifier hs-var">singIDefunss</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208581"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-identifier">singTySig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a><span>  </span><span class="hs-comment">-- definitions</span><span>
</span><a name="line-491"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DType</span><span>       </span><span class="hs-comment">-- type signatures</span><span>
</span><a name="line-492"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- bound kind variables</span><span>
</span><a name="line-493"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DType</span><span>   </span><span class="hs-comment">-- the type is the promoted type, not the type sig!</span><span>
</span><a name="line-494"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">DLetDec</span><span>               </span><span class="hs-comment">-- the new type signature</span><span>
</span><a name="line-495"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DExp</span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- the let-bind entry</span><span>
</span><a name="line-496"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- the scoped tyvar names in the tysig</span><span>
</span><a name="line-497"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DCxt</span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- the context of the type signature</span><span>
</span><a name="line-498"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>           </span><span class="hs-comment">-- the result kind in the tysig</span><span>
</span><a name="line-499"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- SingI instances for defun symbols</span><span>
</span><a name="line-500"></a><span>                 </span><span class="hs-special">)</span><span>
</span><a name="line-501"></a><a name="singTySig"><a href="Data.Singletons.Single.html#singTySig"><span class="hs-identifier">singTySig</span></a></a><span> </span><a name="local-6989586621679208582"><a href="#local-6989586621679208582"><span class="hs-identifier">defns</span></a></a><span> </span><a name="local-6989586621679208583"><a href="#local-6989586621679208583"><span class="hs-identifier">types</span></a></a><span> </span><a name="local-6989586621679208584"><a href="#local-6989586621679208584"><span class="hs-identifier">bound_kvs</span></a></a><span> </span><a name="local-6989586621679208585"><a href="#local-6989586621679208585"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679208586"><a href="#local-6989586621679208586"><span class="hs-identifier">prom_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-502"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208596"><a href="#local-6989586621679208596"><span class="hs-identifier">sName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-503"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208583"><span class="hs-identifier hs-var">types</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-504"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-505"></a><span>      </span><a name="local-6989586621679208597"><a href="#local-6989586621679208597"><span class="hs-identifier">num_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208587"><span class="hs-identifier hs-var">guess_num_args</span></a><span>
</span><a name="line-506"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679208598"><a href="#local-6989586621679208598"><span class="hs-identifier">sty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208599"><a href="#local-6989586621679208599"><span class="hs-identifier">tyvar_names</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208589"><span class="hs-identifier hs-var">mk_sing_ty</span></a><span> </span><a href="#local-6989586621679208597"><span class="hs-identifier hs-var">num_args</span></a><span>
</span><a name="line-507"></a><span>      </span><a name="local-6989586621679208600"><a href="#local-6989586621679208600"><span class="hs-identifier">singIDefuns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Defun.html#singDefuns"><span class="hs-identifier hs-var">singDefuns</span></a><span> </span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">VarName</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-508"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208599"><span class="hs-identifier hs-var">tyvar_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-509"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">DSigD</span><span> </span><a href="#local-6989586621679208596"><span class="hs-identifier hs-var">sName</span></a><span> </span><a href="#local-6989586621679208598"><span class="hs-identifier hs-var">sty</span></a><span>
</span><a name="line-510"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a><span> </span><a href="#local-6989586621679208597"><span class="hs-identifier hs-var">num_args</span></a><span> </span><a href="#local-6989586621679208586"><span class="hs-identifier hs-var">prom_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><a href="#local-6989586621679208596"><span class="hs-identifier hs-var">sName</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208599"><span class="hs-identifier hs-var">tyvar_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-514"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208600"><span class="hs-identifier hs-var">singIDefuns</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679208601"><a href="#local-6989586621679208601"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-516"></a><span>      </span><a name="local-6989586621679208602"><a href="#local-6989586621679208602"><span class="hs-identifier">all_bound_kvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208588"><span class="hs-identifier hs-var">lookup_bound_kvs</span></a><span>
</span><a name="line-517"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679208603"><a href="#local-6989586621679208603"><span class="hs-identifier">sty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208604"><a href="#local-6989586621679208604"><span class="hs-identifier">num_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208605"><a href="#local-6989586621679208605"><span class="hs-identifier">tyvar_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208606"><a href="#local-6989586621679208606"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208607"><a href="#local-6989586621679208607"><span class="hs-identifier">arg_kis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208608"><a href="#local-6989586621679208608"><span class="hs-identifier">res_ki</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Type.html#singType"><span class="hs-identifier hs-var">singType</span></a><span> </span><a href="#local-6989586621679208602"><span class="hs-identifier hs-var">all_bound_kvs</span></a><span> </span><a href="#local-6989586621679208586"><span class="hs-identifier hs-var">prom_ty</span></a><span> </span><a href="#local-6989586621679208601"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-519"></a><span>      </span><a name="local-6989586621679208609"><a href="#local-6989586621679208609"><span class="hs-identifier">bound_cxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Monad.html#askContext"><span class="hs-identifier hs-var">askContext</span></a><span>
</span><a name="line-520"></a><span>      </span><a name="local-6989586621679208610"><a href="#local-6989586621679208610"><span class="hs-identifier">singIDefuns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Defun.html#singDefuns"><span class="hs-identifier hs-var">singDefuns</span></a><span> </span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">VarName</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208609"><span class="hs-identifier hs-var">bound_cxt</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679208606"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679208607"><span class="hs-identifier hs-var">arg_kis</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679208608"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">DSigD</span><span> </span><a href="#local-6989586621679208596"><span class="hs-identifier hs-var">sName</span></a><span> </span><a href="#local-6989586621679208603"><span class="hs-identifier hs-var">sty</span></a><span>
</span><a name="line-523"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a><span> </span><a href="#local-6989586621679208604"><span class="hs-identifier hs-var">num_args</span></a><span> </span><a href="#local-6989586621679208586"><span class="hs-identifier hs-var">prom_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><a href="#local-6989586621679208596"><span class="hs-identifier hs-var">sName</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208605"><span class="hs-identifier hs-var">tyvar_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208606"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679208608"><span class="hs-identifier hs-var">res_ki</span></a><span>
</span><a name="line-527"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208610"><span class="hs-identifier hs-var">singIDefuns</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-529"></a><span>    </span><span class="hs-identifier">guess_num_args</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-530"></a><span>    </span><a name="local-6989586621679208587"><a href="#local-6989586621679208587"><span class="hs-identifier">guess_num_args</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-531"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208582"><span class="hs-identifier hs-var">defns</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-532"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Internal error: promotion known for something not let-bound.&quot;</span><span>
</span><a name="line-533"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#AValue"><span class="hs-identifier hs-var">AValue</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679208590"><a href="#local-6989586621679208590"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679208590"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-534"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#AFunction"><span class="hs-identifier hs-var">AFunction</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679208591"><a href="#local-6989586621679208591"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679208591"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span>    </span><span class="hs-identifier">lookup_bound_kvs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>    </span><a name="local-6989586621679208588"><a href="#local-6989586621679208588"><span class="hs-identifier">lookup_bound_kvs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-538"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208584"><span class="hs-identifier hs-var">bound_kvs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-539"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Internal error: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679208585"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; has no type variable &quot;</span><span>
</span><a name="line-540"></a><span>                          </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;bindings, despite having a type signature&quot;</span><span>
</span><a name="line-541"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679208592"><a href="#local-6989586621679208592"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679208592"><span class="hs-identifier hs-var">kvs</span></a><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span>      </span><span class="hs-comment">-- create a Sing t1 -&gt; Sing t2 -&gt; ... type of a given arity and result type</span><span>
</span><a name="line-544"></a><span>    </span><span class="hs-identifier">mk_sing_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-545"></a><span>    </span><a name="local-6989586621679208589"><a href="#local-6989586621679208589"><span class="hs-identifier">mk_sing_ty</span></a></a><span> </span><a name="local-6989586621679208593"><a href="#local-6989586621679208593"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-546"></a><span>      </span><a name="local-6989586621679208594"><a href="#local-6989586621679208594"><span class="hs-identifier">arg_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621679208593"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;arg&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-547"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">DForallT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DPlainTV</span><span> </span><a href="#local-6989586621679208594"><span class="hs-identifier hs-var">arg_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-548"></a><span>                        </span><span class="hs-special">(</span><a href="Data.Singletons.Util.html#ravel"><span class="hs-identifier hs-var">ravel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679208595"><a href="#local-6989586621679208595"><span class="hs-identifier">nm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679208595"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208594"><span class="hs-identifier hs-var">arg_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-549"></a><span>                               </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span>
</span><a name="line-550"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl</span><span> </span><a href="Data.Singletons.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679208586"><span class="hs-identifier hs-var">prom_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679208594"><span class="hs-identifier hs-var">arg_names</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208594"><span class="hs-identifier hs-var">arg_names</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span class="hs-identifier">singLetDecRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-554"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DCxt</span><span>    </span><span class="hs-comment">-- the context of the type signature</span><span>
</span><a name="line-555"></a><span>                                  </span><span class="hs-comment">-- (might not be known)</span><span>
</span><a name="line-556"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>   </span><span class="hs-comment">-- result kind (might not be known)</span><span>
</span><a name="line-557"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DLetDec</span><span>
</span><a name="line-558"></a><a name="singLetDecRHS"><a href="Data.Singletons.Single.html#singLetDecRHS"><span class="hs-identifier">singLetDecRHS</span></a></a><span> </span><a name="local-6989586621679208611"><a href="#local-6989586621679208611"><span class="hs-identifier">bound_names</span></a></a><span> </span><a name="local-6989586621679208612"><a href="#local-6989586621679208612"><span class="hs-identifier">cxts</span></a></a><span> </span><a name="local-6989586621679208613"><a href="#local-6989586621679208613"><span class="hs-identifier">res_kis</span></a></a><span> </span><a name="local-6989586621679208614"><a href="#local-6989586621679208614"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679208615"><a href="#local-6989586621679208615"><span class="hs-identifier">ld_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-559"></a><span>  </span><a href="Data.Singletons.Single.Monad.html#bindContext"><span class="hs-identifier hs-var">bindContext</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.findWithDefault</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679208614"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208612"><span class="hs-identifier hs-var">cxts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-560"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679208615"><span class="hs-identifier hs-var">ld_rhs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-561"></a><span>      </span><a href="Data.Singletons.Syntax.html#AValue"><span class="hs-identifier hs-var">AValue</span></a><span> </span><a name="local-6989586621679208616"><a href="#local-6989586621679208616"><span class="hs-identifier">prom</span></a></a><span> </span><a name="local-6989586621679208617"><a href="#local-6989586621679208617"><span class="hs-identifier">num_arrows</span></a></a><span> </span><a name="local-6989586621679208618"><a href="#local-6989586621679208618"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-562"></a><span>        </span><span class="hs-identifier hs-var">DValD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarPa</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208614"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-563"></a><span>        </span><span class="hs-special">(</span><a href="Data.Singletons.Single.Monad.html#wrapUnSingFun"><span class="hs-identifier hs-var">wrapUnSingFun</span></a><span> </span><a href="#local-6989586621679208617"><span class="hs-identifier hs-var">num_arrows</span></a><span> </span><a href="#local-6989586621679208616"><span class="hs-identifier hs-var">prom</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208618"><span class="hs-identifier hs-var">exp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679208614"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208613"><span class="hs-identifier hs-var">res_kis</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>      </span><a href="Data.Singletons.Syntax.html#AFunction"><span class="hs-identifier hs-var">AFunction</span></a><span> </span><a name="local-6989586621679208619"><a href="#local-6989586621679208619"><span class="hs-identifier">prom_fun</span></a></a><span> </span><a name="local-6989586621679208620"><a href="#local-6989586621679208620"><span class="hs-identifier">num_arrows</span></a></a><span> </span><a name="local-6989586621679208621"><a href="#local-6989586621679208621"><span class="hs-identifier">clauses</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-565"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208622"><a href="#local-6989586621679208622"><span class="hs-identifier">tyvar_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679208614"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208611"><span class="hs-identifier hs-var">bound_names</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-566"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-567"></a><span>                            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679208624"><a href="#local-6989586621679208624"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679208624"><span class="hs-identifier hs-var">ns</span></a><span>
</span><a name="line-568"></a><span>            </span><a name="local-6989586621679208623"><a href="#local-6989586621679208623"><span class="hs-identifier">res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679208614"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208613"><span class="hs-identifier hs-var">res_kis</span></a><span>
</span><a name="line-569"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-570"></a><span>        </span><span class="hs-identifier hs-var">DFunD</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208614"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-571"></a><span>              </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.html#singClause"><span class="hs-identifier hs-var">singClause</span></a><span> </span><a href="#local-6989586621679208619"><span class="hs-identifier hs-var">prom_fun</span></a><span> </span><a href="#local-6989586621679208620"><span class="hs-identifier hs-var">num_arrows</span></a><span> </span><a href="#local-6989586621679208622"><span class="hs-identifier hs-var">tyvar_names</span></a><span> </span><a href="#local-6989586621679208623"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208621"><span class="hs-identifier hs-var">clauses</span></a><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span class="hs-identifier">singClause</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DType</span><span>   </span><span class="hs-comment">-- the promoted function</span><span>
</span><a name="line-574"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>     </span><span class="hs-comment">-- the number of arrows in the type. If this is more</span><span>
</span><a name="line-575"></a><span>                      </span><span class="hs-comment">-- than the number of patterns, we need to eta-expand</span><span>
</span><a name="line-576"></a><span>                      </span><span class="hs-comment">-- with unSingFun.</span><span>
</span><a name="line-577"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- the names of the forall'd vars in the type sig of this</span><span>
</span><a name="line-578"></a><span>                      </span><span class="hs-comment">-- function. This list should have at least the length as the</span><span>
</span><a name="line-579"></a><span>                      </span><span class="hs-comment">-- number of patterns in the clause</span><span>
</span><a name="line-580"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>   </span><span class="hs-comment">-- result kind, if known</span><span>
</span><a name="line-581"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier hs-type">ADClause</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DClause</span><span>
</span><a name="line-582"></a><a name="singClause"><a href="Data.Singletons.Single.html#singClause"><span class="hs-identifier">singClause</span></a></a><span> </span><a name="local-6989586621679208625"><a href="#local-6989586621679208625"><span class="hs-identifier">prom_fun</span></a></a><span> </span><a name="local-6989586621679208626"><a href="#local-6989586621679208626"><span class="hs-identifier">num_arrows</span></a></a><span> </span><a name="local-6989586621679208627"><a href="#local-6989586621679208627"><span class="hs-identifier">bound_names</span></a></a><span> </span><a name="local-6989586621679208628"><a href="#local-6989586621679208628"><span class="hs-identifier">res_ki</span></a></a><span>
</span><a name="line-583"></a><span>           </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier hs-var">ADClause</span></a><span> </span><a name="local-6989586621679208629"><a href="#local-6989586621679208629"><span class="hs-identifier">var_proms</span></a></a><span> </span><a name="local-6989586621679208630"><a href="#local-6989586621679208630"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621679208631"><a href="#local-6989586621679208631"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span>  </span><span class="hs-comment">-- Fix #166:</span><span>
</span><a name="line-586"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208626"><span class="hs-identifier hs-var">num_arrows</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679208630"><span class="hs-identifier hs-var">pats</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-587"></a><span>    </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Function being promoted to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprint</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeToTH</span><span> </span><a href="#local-6989586621679208625"><span class="hs-identifier hs-var">prom_fun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-588"></a><span>           </span><span class="hs-string">&quot; has too many arguments.&quot;</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208632"><a href="#local-6989586621679208632"><span class="hs-identifier">sPats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208633"><a href="#local-6989586621679208633"><span class="hs-identifier">sigPaExpsSigs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.html#singPat"><span class="hs-identifier hs-var">singPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679208629"><span class="hs-identifier hs-var">var_proms</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208630"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-591"></a><span>  </span><a name="local-6989586621679208634"><a href="#local-6989586621679208634"><span class="hs-identifier">sBody</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208631"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621679208628"><span class="hs-identifier hs-var">res_ki</span></a><span>
</span><a name="line-592"></a><span>    </span><span class="hs-comment">-- when calling unSingFun, the promoted pats aren't in scope, so we use the</span><span>
</span><a name="line-593"></a><span>    </span><span class="hs-comment">-- bound_names instead</span><span>
</span><a name="line-594"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208635"><a href="#local-6989586621679208635"><span class="hs-identifier">pattern_bound_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621679208627"><span class="hs-identifier hs-var">bound_names</span></a><span> </span><a href="#local-6989586621679208630"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-595"></a><span>       </span><span class="hs-comment">-- this does eta-expansion. See comment at top of file.</span><span>
</span><a name="line-596"></a><span>      </span><a name="local-6989586621679208636"><a href="#local-6989586621679208636"><span class="hs-identifier">sBody'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#wrapUnSingFun"><span class="hs-identifier hs-var">wrapUnSingFun</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208626"><span class="hs-identifier hs-var">num_arrows</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679208630"><span class="hs-identifier hs-var">pats</span></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl</span><span> </span><a href="Data.Singletons.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621679208625"><span class="hs-identifier hs-var">prom_fun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679208635"><span class="hs-identifier hs-var">pattern_bound_names</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208634"><span class="hs-identifier hs-var">sBody</span></a><span>
</span><a name="line-598"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DClause</span><span> </span><a href="#local-6989586621679208632"><span class="hs-identifier hs-var">sPats</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Single.html#mkSigPaCaseE"><span class="hs-identifier hs-var">mkSigPaCaseE</span></a><span> </span><a href="#local-6989586621679208633"><span class="hs-identifier hs-var">sigPaExpsSigs</span></a><span> </span><a href="#local-6989586621679208636"><span class="hs-identifier hs-var">sBody'</span></a><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span class="hs-identifier">singPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">Name</span><span>   </span><span class="hs-comment">-- from term-level names to type-level names</span><span>
</span><a name="line-601"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a><span>
</span><a name="line-602"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Util.html#QWithAux"><span class="hs-identifier hs-type">QWithAux</span></a><span> </span><a href="Data.Singletons.Syntax.html#SingDSigPaInfos"><span class="hs-identifier hs-type">SingDSigPaInfos</span></a><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DPat</span><span>
</span><a name="line-603"></a><a name="singPat"><a href="Data.Singletons.Single.html#singPat"><span class="hs-identifier">singPat</span></a></a><span> </span><a name="local-6989586621679208637"><a href="#local-6989586621679208637"><span class="hs-identifier">var_proms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679208638"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-604"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-605"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Util.html#QWithAux"><span class="hs-identifier hs-type">QWithAux</span></a><span> </span><a href="Data.Singletons.Syntax.html#SingDSigPaInfos"><span class="hs-identifier hs-type">SingDSigPaInfos</span></a><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DPat</span><span>
</span><a name="line-606"></a><span>    </span><a name="local-6989586621679208638"><a href="#local-6989586621679208638"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADLitPa"><span class="hs-identifier hs-var">ADLitPa</span></a><span> </span><a name="local-6989586621679208639"><a href="#local-6989586621679208639"><span class="hs-identifier">_lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-607"></a><span>      </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Singling of literal patterns not yet supported&quot;</span><span>
</span><a name="line-608"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADVarPa"><span class="hs-identifier hs-var">ADVarPa</span></a><span> </span><a name="local-6989586621679208640"><a href="#local-6989586621679208640"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-609"></a><span>      </span><a name="local-6989586621679208642"><a href="#local-6989586621679208642"><span class="hs-identifier">tyname</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679208640"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679208637"><span class="hs-identifier hs-var">var_proms</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-610"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-611"></a><span>                    </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Internal error: unknown variable when singling pattern&quot;</span><span>
</span><a name="line-612"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679208641"><a href="#local-6989586621679208641"><span class="hs-identifier">tyname</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679208641"><span class="hs-identifier hs-var">tyname</span></a><span>
</span><a name="line-613"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DVarPa</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208640"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DSigPa</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679208642"><span class="hs-identifier hs-var">tyname</span></a><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADConPa"><span class="hs-identifier hs-var">ADConPa</span></a><span> </span><a name="local-6989586621679208643"><a href="#local-6989586621679208643"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679208644"><a href="#local-6989586621679208644"><span class="hs-identifier">pats</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DConPa</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singDataConName"><span class="hs-identifier hs-var">singDataConName</span></a><span> </span><a href="#local-6989586621679208643"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621679208638"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679208644"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-615"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADTildePa"><span class="hs-identifier hs-var">ADTildePa</span></a><span> </span><a name="local-6989586621679208645"><a href="#local-6989586621679208645"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-616"></a><span>      </span><a href="Data.Singletons.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a><span>
</span><a name="line-617"></a><span>        </span><span class="hs-string">&quot;Lazy pattern converted into regular pattern during singleton generation.&quot;</span><span>
</span><a name="line-618"></a><span>      </span><a href="#local-6989586621679208638"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679208645"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-619"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADBangPa"><span class="hs-identifier hs-var">ADBangPa</span></a><span> </span><a name="local-6989586621679208646"><a href="#local-6989586621679208646"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DBangPa</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679208638"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679208646"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-620"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADSigPa"><span class="hs-identifier hs-var">ADSigPa</span></a><span> </span><a name="local-6989586621679208647"><a href="#local-6989586621679208647"><span class="hs-identifier">prom_pat</span></a></a><span> </span><a name="local-6989586621679208648"><a href="#local-6989586621679208648"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621679208649"><a href="#local-6989586621679208649"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-621"></a><span>      </span><a name="local-6989586621679208650"><a href="#local-6989586621679208650"><span class="hs-identifier">pat'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679208638"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679208648"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-622"></a><span>      </span><span class="hs-comment">-- Normally, calling dPatToDExp would be dangerous, since it fails if the</span><span>
</span><a name="line-623"></a><span>      </span><span class="hs-comment">-- supplied pattern contains any wildcard patterns. However, promotePat</span><span>
</span><a name="line-624"></a><span>      </span><span class="hs-comment">-- (which produced the pattern we're passing into dPatToDExp) maintains</span><span>
</span><a name="line-625"></a><span>      </span><span class="hs-comment">-- an invariant that any promoted pattern signatures will be free of</span><span>
</span><a name="line-626"></a><span>      </span><span class="hs-comment">-- wildcard patterns in the underlying pattern.</span><span>
</span><a name="line-627"></a><span>      </span><span class="hs-comment">-- See Note [Singling pattern signatures].</span><span>
</span><a name="line-628"></a><span>      </span><a href="Data.Singletons.Util.html#addElement"><span class="hs-identifier hs-var">addElement</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dPatToDExp</span><span> </span><a href="#local-6989586621679208650"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">DSigT</span><span> </span><a href="#local-6989586621679208647"><span class="hs-identifier hs-var">prom_pat</span></a><span> </span><a href="#local-6989586621679208649"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679208650"><span class="hs-identifier hs-var">pat'</span></a><span>
</span><a name="line-630"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a href="Data.Singletons.Syntax.html#ADWildPa"><span class="hs-identifier hs-var">ADWildPa</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">DWildPa</span><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span class="hs-comment">-- | If given a non-empty list of 'SingDSigPaInfos', construct a case expression</span><span>
</span><a name="line-633"></a><span class="hs-comment">-- that brings singleton equality constraints into scope via pattern-matching.</span><span>
</span><a name="line-634"></a><span class="hs-comment">-- See @Note [Singling pattern signatures]@.</span><span>
</span><a name="line-635"></a><span class="hs-identifier">mkSigPaCaseE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#SingDSigPaInfos"><span class="hs-identifier hs-type">SingDSigPaInfos</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DExp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DExp</span><span>
</span><a name="line-636"></a><a name="mkSigPaCaseE"><a href="Data.Singletons.Single.html#mkSigPaCaseE"><span class="hs-identifier">mkSigPaCaseE</span></a></a><span> </span><a name="local-6989586621679208651"><a href="#local-6989586621679208651"><span class="hs-identifier">exps_with_sigs</span></a></a><span> </span><a name="local-6989586621679208652"><a href="#local-6989586621679208652"><span class="hs-identifier">exp</span></a></a><span>
</span><a name="line-637"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679208651"><span class="hs-identifier hs-var">exps_with_sigs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679208652"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-638"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-639"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679208653"><a href="#local-6989586621679208653"><span class="hs-identifier">exps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208654"><a href="#local-6989586621679208654"><span class="hs-identifier">sigs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621679208651"><span class="hs-identifier hs-var">exps_with_sigs</span></a><span>
</span><a name="line-640"></a><span>          </span><a name="local-6989586621679208655"><a href="#local-6989586621679208655"><span class="hs-identifier">scrutinee</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTupleDExp</span><span> </span><a href="#local-6989586621679208653"><span class="hs-identifier hs-var">exps</span></a><span>
</span><a name="line-641"></a><span>          </span><a name="local-6989586621679208656"><a href="#local-6989586621679208656"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DSigPa</span><span> </span><span class="hs-identifier hs-var">DWildPa</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">DAppT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#singFamilyName"><span class="hs-identifier hs-var">singFamilyName</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208654"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-642"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">DCaseE</span><span> </span><a href="#local-6989586621679208655"><span class="hs-identifier hs-var">scrutinee</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DMatch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTupleDPat</span><span> </span><a href="#local-6989586621679208656"><span class="hs-identifier hs-var">pats</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208652"><span class="hs-identifier hs-var">exp</span></a><span class="hs-special">]</span><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span class="hs-comment">-- Note [Annotate case return type]</span><span>
</span><a name="line-645"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-646"></a><span class="hs-comment">--</span><span>
</span><a name="line-647"></a><span class="hs-comment">-- We're straining GHC's type inference here. One particular trouble area</span><span>
</span><a name="line-648"></a><span class="hs-comment">-- is determining the return type of a GADT pattern match. In general, GHC</span><span>
</span><a name="line-649"></a><span class="hs-comment">-- cannot infer return types of GADT pattern matches because the return type</span><span>
</span><a name="line-650"></a><span class="hs-comment">-- becomes &quot;untouchable&quot; in the case matches. See the OutsideIn paper. But,</span><span>
</span><a name="line-651"></a><span class="hs-comment">-- during singletonization, we *know* the return type. So, just add a type</span><span>
</span><a name="line-652"></a><span class="hs-comment">-- annotation. See #54.</span><span>
</span><a name="line-653"></a><span>
</span><a name="line-654"></a><span class="hs-comment">-- Note [Why error is so special]</span><span>
</span><a name="line-655"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-656"></a><span class="hs-comment">-- Some of the transformations that happen before this point produce impossible</span><span>
</span><a name="line-657"></a><span class="hs-comment">-- case matches. We must be careful when processing these so as not to make</span><span>
</span><a name="line-658"></a><span class="hs-comment">-- an error GHC will complain about. When binding the case-match variables, we</span><span>
</span><a name="line-659"></a><span class="hs-comment">-- normally include an equality constraint saying that the scrutinee is equal</span><span>
</span><a name="line-660"></a><span class="hs-comment">-- to the matched pattern. But, we can't do this in inaccessible matches, because</span><span>
</span><a name="line-661"></a><span class="hs-comment">-- equality is bogus, and GHC (rightly) complains. However, we then have another</span><span>
</span><a name="line-662"></a><span class="hs-comment">-- problem, because GHC doesn't have enough information when type-checking the</span><span>
</span><a name="line-663"></a><span class="hs-comment">-- RHS of the inaccessible match to deem it type-safe. The solution: treat error</span><span>
</span><a name="line-664"></a><span class="hs-comment">-- as super-special, so that GHC doesn't look too hard at singletonized error</span><span>
</span><a name="line-665"></a><span class="hs-comment">-- calls. Specifically, DON'T do the applySing stuff. Just use sError, which</span><span>
</span><a name="line-666"></a><span class="hs-comment">-- has a custom type (Sing x -&gt; a) anyway.</span><span>
</span><a name="line-667"></a><span>
</span><a name="line-668"></a><span class="hs-comment">-- Note [Singling pattern signatures]</span><span>
</span><a name="line-669"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-670"></a><span class="hs-comment">-- We want to single a pattern signature, like so:</span><span>
</span><a name="line-671"></a><span class="hs-comment">--</span><span>
</span><a name="line-672"></a><span class="hs-comment">--   f :: Maybe a -&gt; a</span><span>
</span><a name="line-673"></a><span class="hs-comment">--   f (Just x :: Maybe a) = x</span><span>
</span><a name="line-674"></a><span class="hs-comment">--</span><span>
</span><a name="line-675"></a><span class="hs-comment">-- Na&#239;vely, one might expect this to single straightfowardly as:</span><span>
</span><a name="line-676"></a><span class="hs-comment">--</span><span>
</span><a name="line-677"></a><span class="hs-comment">--   sF :: forall (z :: Maybe a). Sing z -&gt; Sing (F z)</span><span>
</span><a name="line-678"></a><span class="hs-comment">--   sF (SJust sX :: Sing (Just x :: Maybe a)) = sX</span><span>
</span><a name="line-679"></a><span class="hs-comment">--</span><span>
</span><a name="line-680"></a><span class="hs-comment">-- But the way GHC typechecks patterns prevents this from working, as GHC won't</span><span>
</span><a name="line-681"></a><span class="hs-comment">-- know that the type `z` is actually `Just x` until /after/ the entirety of</span><span>
</span><a name="line-682"></a><span class="hs-comment">-- the `SJust sX` pattern has been typechecked. (See Trac #12018 for an</span><span>
</span><a name="line-683"></a><span class="hs-comment">-- extended discussion on this topic.)</span><span>
</span><a name="line-684"></a><span class="hs-comment">--</span><span>
</span><a name="line-685"></a><span class="hs-comment">-- To work around this design, we resort to a somewhat unsightly trick:</span><span>
</span><a name="line-686"></a><span class="hs-comment">-- immediately after matching on all the patterns, we perform a case on every</span><span>
</span><a name="line-687"></a><span class="hs-comment">-- pattern with a pattern signature, like so:</span><span>
</span><a name="line-688"></a><span class="hs-comment">--</span><span>
</span><a name="line-689"></a><span class="hs-comment">--   sF :: forall (z :: Maybe a). Sing z -&gt; Sing (F z)</span><span>
</span><a name="line-690"></a><span class="hs-comment">--   sF (SJust sX :: Sing z)</span><span>
</span><a name="line-691"></a><span class="hs-comment">--     = case (SJust sX :: Sing z) of</span><span>
</span><a name="line-692"></a><span class="hs-comment">--         (_ :: Sing (Just x :: Maybe a)) -&gt; sX</span><span>
</span><a name="line-693"></a><span class="hs-comment">--</span><span>
</span><a name="line-694"></a><span class="hs-comment">-- Now GHC accepts the fact that `z` is `Just x`, and all is well. In order</span><span>
</span><a name="line-695"></a><span class="hs-comment">-- to support this construction, the type of singPat is augmented with some</span><span>
</span><a name="line-696"></a><span class="hs-comment">-- extra information in the form of SingDSigPaInfos:</span><span>
</span><a name="line-697"></a><span class="hs-comment">--</span><span>
</span><a name="line-698"></a><span class="hs-comment">--   type SingDSigPaInfos = [(DExp, DType)]</span><span>
</span><a name="line-699"></a><span class="hs-comment">--</span><span>
</span><a name="line-700"></a><span class="hs-comment">-- Where the DExps corresponds to the expressions we case on just after the</span><span>
</span><a name="line-701"></a><span class="hs-comment">-- patterns (`SJust sX :: Sing x`, in the example above), and the DTypes</span><span>
</span><a name="line-702"></a><span class="hs-comment">-- correspond to the singled pattern signatures to use in the case alternative</span><span>
</span><a name="line-703"></a><span class="hs-comment">-- (`Sing (Just x :: Maybe a)` in the example above). singPat appends to the</span><span>
</span><a name="line-704"></a><span class="hs-comment">-- list of SingDSigPaInfos whenever it processes a DSigPa (pattern signature),</span><span>
</span><a name="line-705"></a><span class="hs-comment">-- and call sites can pass these SingDSigPaInfos to mkSigPaCaseE to construct a</span><span>
</span><a name="line-706"></a><span class="hs-comment">-- case expression like the one featured above.</span><span>
</span><a name="line-707"></a><span class="hs-comment">--</span><span>
</span><a name="line-708"></a><span class="hs-comment">-- Some interesting consequences of this design:</span><span>
</span><a name="line-709"></a><span class="hs-comment">--</span><span>
</span><a name="line-710"></a><span class="hs-comment">-- 1. We must promote DPats to ADPats, a variation of DPat where the annotated</span><span>
</span><a name="line-711"></a><span class="hs-comment">--    DSigPa counterpart, ADSigPa, stores the type that the original DPat was</span><span>
</span><a name="line-712"></a><span class="hs-comment">--    promoted to. This is necessary since promoting the type might have</span><span>
</span><a name="line-713"></a><span class="hs-comment">--    generated fresh variable names, so we need to be able to use the same</span><span>
</span><a name="line-714"></a><span class="hs-comment">--    names when singling.</span><span>
</span><a name="line-715"></a><span class="hs-comment">--</span><span>
</span><a name="line-716"></a><span class="hs-comment">-- 2. Also when promoting a DSigPa to an ADSigPa, we remove any wildcards from</span><span>
</span><a name="line-717"></a><span class="hs-comment">--    the underlying pattern. To see why this is necessary, consider singling</span><span>
</span><a name="line-718"></a><span class="hs-comment">--    this example:</span><span>
</span><a name="line-719"></a><span class="hs-comment">--</span><span>
</span><a name="line-720"></a><span class="hs-comment">--      g (Just _ :: Maybe a) = &quot;hi&quot;</span><span>
</span><a name="line-721"></a><span class="hs-comment">--</span><span>
</span><a name="line-722"></a><span class="hs-comment">--    This must single to something like this:</span><span>
</span><a name="line-723"></a><span class="hs-comment">--</span><span>
</span><a name="line-724"></a><span class="hs-comment">--      sG (SJust _ :: Sing z)</span><span>
</span><a name="line-725"></a><span class="hs-comment">--        = case (SJust _ :: Sing z) of</span><span>
</span><a name="line-726"></a><span class="hs-comment">--            (_ :: Sing (Just _ :: Maybe a)) -&gt; &quot;hi&quot;</span><span>
</span><a name="line-727"></a><span class="hs-comment">--</span><span>
</span><a name="line-728"></a><span class="hs-comment">--    But `SJust _` is not a valid expression, and since the minimal th-desugar</span><span>
</span><a name="line-729"></a><span class="hs-comment">--    AST lacks as-patterns, we can't replace it with something like</span><span>
</span><a name="line-730"></a><span class="hs-comment">--    `sG x@(SJust _ :: Sing z) = case x of ...`. But even if the th-desugar</span><span>
</span><a name="line-731"></a><span class="hs-comment">--    AST /did/ have as-patterns, we'd still be in trouble, as `Just _` isn't</span><span>
</span><a name="line-732"></a><span class="hs-comment">--    a valid type without the use of -XPartialTypeSignatures, which isn't a</span><span>
</span><a name="line-733"></a><span class="hs-comment">--    design we want to force upon others.</span><span>
</span><a name="line-734"></a><span class="hs-comment">--</span><span>
</span><a name="line-735"></a><span class="hs-comment">--    We work around both issues by simply converting all wildcard patterns</span><span>
</span><a name="line-736"></a><span class="hs-comment">--    from the pattern that has a signature. That means our example becomes:</span><span>
</span><a name="line-737"></a><span class="hs-comment">--</span><span>
</span><a name="line-738"></a><span class="hs-comment">--      sG (SJust sWild :: Sing z)</span><span>
</span><a name="line-739"></a><span class="hs-comment">--        = case (SJust sWild :: Sing z) of</span><span>
</span><a name="line-740"></a><span class="hs-comment">--            (_ :: Sing (Just wild :: Maybe a)) -&gt; &quot;hi&quot;</span><span>
</span><a name="line-741"></a><span class="hs-comment">--</span><span>
</span><a name="line-742"></a><span class="hs-comment">--    And now everything is hunky-dory.</span><span>
</span><a name="line-743"></a><span>
</span><a name="line-744"></a><span class="hs-identifier">singExp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>   </span><span class="hs-comment">-- the kind of the expression, if known</span><span>
</span><a name="line-745"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DExp</span><span>
</span><a name="line-746"></a><span>  </span><span class="hs-comment">-- See Note [Why error is so special]</span><span>
</span><a name="line-747"></a><a name="singExp"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier">singExp</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADVarE"><span class="hs-identifier hs-var">ADVarE</span></a><span> </span><a name="local-6989586621679208657"><a href="#local-6989586621679208657"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Syntax.html#ADAppE"><span class="hs-identifier hs-var">ADAppE</span></a><span class="hs-special">`</span><span> </span><a name="local-6989586621679208658"><a href="#local-6989586621679208658"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679208659"><a href="#local-6989586621679208659"><span class="hs-identifier">_res_ki</span></a></a><span>
</span><a name="line-748"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679208657"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Data.Singletons.Names.html#errorName"><span class="hs-identifier hs-var">errorName</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DAppE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208657"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-749"></a><span>                       </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208658"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#symbolName"><span class="hs-identifier hs-var">symbolName</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span class="hs-identifier">singExp</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADVarE"><span class="hs-identifier hs-var">ADVarE</span></a><span> </span><a name="local-6989586621679208660"><a href="#local-6989586621679208660"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679208661"><a href="#local-6989586621679208661"><span class="hs-identifier">_res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a><span> </span><a href="#local-6989586621679208660"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-751"></a><span class="hs-identifier">singExp</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADConE"><span class="hs-identifier hs-var">ADConE</span></a><span> </span><a name="local-6989586621679208662"><a href="#local-6989586621679208662"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679208663"><a href="#local-6989586621679208663"><span class="hs-identifier">_res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.Monad.html#lookupConE"><span class="hs-identifier hs-var">lookupConE</span></a><span> </span><a href="#local-6989586621679208662"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-752"></a><span class="hs-identifier">singExp</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADLitE"><span class="hs-identifier hs-var">ADLitE</span></a><span> </span><a name="local-6989586621679208664"><a href="#local-6989586621679208664"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>  </span><a name="local-6989586621679208665"><a href="#local-6989586621679208665"><span class="hs-identifier">_res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#singLit"><span class="hs-identifier hs-var">singLit</span></a><span> </span><a href="#local-6989586621679208664"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-753"></a><span class="hs-identifier">singExp</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADAppE"><span class="hs-identifier hs-var">ADAppE</span></a><span> </span><a name="local-6989586621679208666"><a href="#local-6989586621679208666"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621679208667"><a href="#local-6989586621679208667"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679208668"><a href="#local-6989586621679208668"><span class="hs-identifier">_res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-754"></a><span>  </span><a name="local-6989586621679208669"><a href="#local-6989586621679208669"><span class="hs-identifier">e1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208666"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-755"></a><span>  </span><a name="local-6989586621679208670"><a href="#local-6989586621679208670"><span class="hs-identifier">e2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208667"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-756"></a><span>  </span><span class="hs-comment">-- `applySing undefined x` kills type inference, because GHC can't figure</span><span>
</span><a name="line-757"></a><span>  </span><span class="hs-comment">-- out the type of `undefined`. So we don't emit `applySing` there.</span><span>
</span><a name="line-758"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a><span> </span><a href="#local-6989586621679208669"><span class="hs-identifier hs-var">e1'</span></a><span>
</span><a name="line-759"></a><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679208669"><span class="hs-identifier hs-var">e1'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppE</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208670"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-760"></a><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><a href="Data.Singletons.Names.html#applySingName"><span class="hs-identifier hs-var">applySingName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppE</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208669"><span class="hs-identifier hs-var">e1'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppE</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208670"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-761"></a><span class="hs-identifier">singExp</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADLamE"><span class="hs-identifier hs-var">ADLamE</span></a><span> </span><a name="local-6989586621679208671"><a href="#local-6989586621679208671"><span class="hs-identifier">ty_names</span></a></a><span> </span><a name="local-6989586621679208672"><a href="#local-6989586621679208672"><span class="hs-identifier">prom_lam</span></a></a><span> </span><a name="local-6989586621679208673"><a href="#local-6989586621679208673"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621679208674"><a href="#local-6989586621679208674"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679208675"><a href="#local-6989586621679208675"><span class="hs-identifier">_res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-762"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208676"><a href="#local-6989586621679208676"><span class="hs-identifier">sNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a><span> </span><a href="#local-6989586621679208673"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-763"></a><span>  </span><a name="local-6989586621679208677"><a href="#local-6989586621679208677"><span class="hs-identifier">exp'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208674"><span class="hs-identifier hs-var">exp</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-764"></a><span>  </span><span class="hs-comment">-- we need to bind the type variables... but DLamE doesn't allow SigT patterns.</span><span>
</span><a name="line-765"></a><span>  </span><span class="hs-comment">-- So: build a case</span><span>
</span><a name="line-766"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208678"><a href="#local-6989586621679208678"><span class="hs-identifier">caseExp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DCaseE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTupleDExp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">DVarE</span><span> </span><a href="#local-6989586621679208676"><span class="hs-identifier hs-var">sNames</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-767"></a><span>                       </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DMatch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTupleDPat</span><span>
</span><a name="line-768"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DWildPa</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DSigPa</span><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-769"></a><span>                                      </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-770"></a><span>                                      </span><span class="hs-identifier hs-var">DVarT</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208671"><span class="hs-identifier hs-var">ty_names</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208677"><span class="hs-identifier hs-var">exp'</span></a><span class="hs-special">]</span><span>
</span><a name="line-771"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679208673"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208672"><span class="hs-identifier hs-var">prom_lam</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DLamE</span><span> </span><a href="#local-6989586621679208676"><span class="hs-identifier hs-var">sNames</span></a><span> </span><a href="#local-6989586621679208678"><span class="hs-identifier hs-var">caseExp</span></a><span>
</span><a name="line-772"></a><span class="hs-identifier">singExp</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADCaseE"><span class="hs-identifier hs-var">ADCaseE</span></a><span> </span><a name="local-6989586621679208679"><a href="#local-6989586621679208679"><span class="hs-identifier">exp</span></a></a><span> </span><a name="local-6989586621679208680"><a href="#local-6989586621679208680"><span class="hs-identifier">matches</span></a></a><span> </span><a name="local-6989586621679208681"><a href="#local-6989586621679208681"><span class="hs-identifier">ret_ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679208682"><a href="#local-6989586621679208682"><span class="hs-identifier">res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-773"></a><span>    </span><span class="hs-comment">-- See Note [Annotate case return type]</span><span>
</span><a name="line-774"></a><span>  </span><span class="hs-identifier hs-var">DSigE</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DCaseE</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208679"><span class="hs-identifier hs-var">exp</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Single.html#singMatch"><span class="hs-identifier hs-var">singMatch</span></a><span> </span><a href="#local-6989586621679208682"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208680"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">)</span><span>
</span><a name="line-775"></a><span>        </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679208681"><span class="hs-identifier hs-var">ret_ty</span></a><span> </span><span class="hs-special">`</span><a href="Data.Singletons.Single.html#maybeSigT"><span class="hs-identifier hs-var">maybeSigT</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208682"><span class="hs-identifier hs-var">res_ki</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-776"></a><span class="hs-identifier">singExp</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADLetE"><span class="hs-identifier hs-var">ADLetE</span></a><span> </span><a name="local-6989586621679208683"><a href="#local-6989586621679208683"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679208684"><a href="#local-6989586621679208684"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679208685"><a href="#local-6989586621679208685"><span class="hs-identifier">res_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-777"></a><span>  </span><span class="hs-comment">-- We intentionally discard the SingI instances for exp's defunctionalization</span><span>
</span><a name="line-778"></a><span>  </span><span class="hs-comment">-- symbols, as we also do not generate the declarations for the</span><span>
</span><a name="line-779"></a><span>  </span><span class="hs-comment">-- defunctionalization symbols in the first place during promotion.</span><span>
</span><a name="line-780"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208686"><a href="#local-6989586621679208686"><span class="hs-identifier">let_decs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679208687"><a href="#local-6989586621679208687"><span class="hs-identifier">exp'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singLetDecEnv"><span class="hs-identifier hs-var">singLetDecEnv</span></a><span> </span><a href="#local-6989586621679208683"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208684"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621679208685"><span class="hs-identifier hs-var">res_ki</span></a><span>
</span><a name="line-781"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DLetE</span><span> </span><a href="#local-6989586621679208686"><span class="hs-identifier hs-var">let_decs</span></a><span> </span><a href="#local-6989586621679208687"><span class="hs-identifier hs-var">exp'</span></a><span>
</span><a name="line-782"></a><span class="hs-identifier">singExp</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADSigE"><span class="hs-identifier hs-var">ADSigE</span></a><span> </span><a name="local-6989586621679208688"><a href="#local-6989586621679208688"><span class="hs-identifier">prom_exp</span></a></a><span> </span><a name="local-6989586621679208689"><a href="#local-6989586621679208689"><span class="hs-identifier">exp</span></a></a><span> </span><a name="local-6989586621679208690"><a href="#local-6989586621679208690"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-783"></a><span>  </span><a name="local-6989586621679208691"><a href="#local-6989586621679208691"><span class="hs-identifier">exp'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208689"><span class="hs-identifier hs-var">exp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679208690"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DSigE</span><span> </span><a href="#local-6989586621679208691"><span class="hs-identifier hs-var">exp'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#singFamilyName"><span class="hs-identifier hs-var">singFamilyName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">DSigT</span><span> </span><a href="#local-6989586621679208688"><span class="hs-identifier hs-var">prom_exp</span></a><span> </span><a href="#local-6989586621679208690"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span class="hs-comment">-- See Note [DerivedDecl]</span><span>
</span><a name="line-787"></a><span class="hs-identifier">singDerivedEqDecs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#DerivedEqDecl"><span class="hs-identifier hs-type">DerivedEqDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-788"></a><a name="singDerivedEqDecs"><a href="Data.Singletons.Single.html#singDerivedEqDecs"><span class="hs-identifier">singDerivedEqDecs</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-var">DerivedDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ded_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208692"><a href="#local-6989586621679208692"><span class="hs-identifier">mb_ctxt</span></a></a><span>
</span><a name="line-789"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ded_type</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208693"><a href="#local-6989586621679208693"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-790"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ded_decl</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679208694"><a href="#local-6989586621679208694"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-791"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208695"><a href="#local-6989586621679208695"><span class="hs-identifier">scons</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Monad.html#singM"><span class="hs-identifier hs-var">singM</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Single.Data.html#singCtor"><span class="hs-identifier hs-var">singCtor</span></a><span> </span><a href="#local-6989586621679208694"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-792"></a><span>  </span><a name="local-6989586621679208696"><a href="#local-6989586621679208696"><span class="hs-identifier">mb_sctxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Data.Singletons.Single.Type.html#singPred"><span class="hs-identifier hs-var">singPred</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208692"><span class="hs-identifier hs-var">mb_ctxt</span></a><span>
</span><a name="line-793"></a><span>  </span><a name="local-6989586621679208697"><a href="#local-6989586621679208697"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a><span> </span><a href="#local-6989586621679208693"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-794"></a><span>  </span><a name="local-6989586621679208698"><a href="#local-6989586621679208698"><span class="hs-identifier">sEqInst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Eq.html#mkEqualityInstance"><span class="hs-identifier hs-var">mkEqualityInstance</span></a><span> </span><a href="#local-6989586621679208696"><span class="hs-identifier hs-var">mb_sctxt</span></a><span> </span><a href="#local-6989586621679208697"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621679208694"><span class="hs-identifier hs-var">cons</span></a><span> </span><a href="#local-6989586621679208695"><span class="hs-identifier hs-var">scons</span></a><span> </span><a href="Data.Singletons.Single.Eq.html#sEqClassDesc"><span class="hs-identifier hs-var">sEqClassDesc</span></a><span>
</span><a name="line-795"></a><span>  </span><span class="hs-comment">-- Beware! The user might have specified an instance context like this:</span><span>
</span><a name="line-796"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-797"></a><span>  </span><span class="hs-comment">--   deriving instance Eq a =&gt; Eq (T a Int)</span><span>
</span><a name="line-798"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-799"></a><span>  </span><span class="hs-comment">-- When we single the context, it will become (SEq a). But we do *not* want</span><span>
</span><a name="line-800"></a><span>  </span><span class="hs-comment">-- this for the SDecide instance! The simplest solution is to simply replace</span><span>
</span><a name="line-801"></a><span>  </span><span class="hs-comment">-- all occurrences of SEq with SDecide in the context.</span><span>
</span><a name="line-802"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208699"><a href="#local-6989586621679208699"><span class="hs-identifier">mb_sctxtDecide</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Data.Singletons.Single.html#sEqToSDecide"><span class="hs-identifier hs-var">sEqToSDecide</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208696"><span class="hs-identifier hs-var">mb_sctxt</span></a><span>
</span><a name="line-803"></a><span>  </span><a name="local-6989586621679208700"><a href="#local-6989586621679208700"><span class="hs-identifier">sDecideInst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.Eq.html#mkEqualityInstance"><span class="hs-identifier hs-var">mkEqualityInstance</span></a><span> </span><a href="#local-6989586621679208699"><span class="hs-identifier hs-var">mb_sctxtDecide</span></a><span> </span><a href="#local-6989586621679208697"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621679208694"><span class="hs-identifier hs-var">cons</span></a><span> </span><a href="#local-6989586621679208695"><span class="hs-identifier hs-var">scons</span></a><span> </span><a href="Data.Singletons.Single.Eq.html#sDecideClassDesc"><span class="hs-identifier hs-var">sDecideClassDesc</span></a><span>
</span><a name="line-804"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679208698"><span class="hs-identifier hs-var">sEqInst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679208700"><span class="hs-identifier hs-var">sDecideInst</span></a><span class="hs-special">]</span><span>
</span><a name="line-805"></a><span>
</span><a name="line-806"></a><span class="hs-comment">-- Walk a DPred, replacing all occurrences of SEq with SDecide.</span><span>
</span><a name="line-807"></a><span class="hs-identifier">sEqToSDecide</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DPred</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DPred</span><span>
</span><a name="line-808"></a><a name="sEqToSDecide"><a href="Data.Singletons.Single.html#sEqToSDecide"><span class="hs-identifier">sEqToSDecide</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Names.html#modifyConNameDPred"><span class="hs-identifier hs-var">modifyConNameDPred</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679208701"><a href="#local-6989586621679208701"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-809"></a><span>  </span><span class="hs-comment">-- Why don't we directly compare n to sEqClassName? Because n is almost certainly</span><span>
</span><a name="line-810"></a><span>  </span><span class="hs-comment">-- produced from a call to singClassName, which uses unqualified Names. Ugh.</span><span>
</span><a name="line-811"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679208701"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="Data.Singletons.Names.html#sEqClassName"><span class="hs-identifier hs-var">sEqClassName</span></a><span>
</span><a name="line-812"></a><span>     </span><span class="hs-keyword">then</span><span> </span><a href="Data.Singletons.Names.html#sDecideClassName"><span class="hs-identifier hs-var">sDecideClassName</span></a><span>
</span><a name="line-813"></a><span>     </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679208701"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-814"></a><span>
</span><a name="line-815"></a><span class="hs-comment">-- See Note [DerivedDecl]</span><span>
</span><a name="line-816"></a><span class="hs-identifier">singDerivedShowDecs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Data.Singletons.Syntax.html#DerivedShowDecl"><span class="hs-identifier hs-type">DerivedShowDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DDec</span><span class="hs-special">]</span><span>
</span><a name="line-817"></a><a name="singDerivedShowDecs"><a href="Data.Singletons.Single.html#singDerivedShowDecs"><span class="hs-identifier">singDerivedShowDecs</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-var">DerivedDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ded_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208702"><a href="#local-6989586621679208702"><span class="hs-identifier">mb_cxt</span></a></a><span>
</span><a name="line-818"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ded_type</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679208703"><a href="#local-6989586621679208703"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-819"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ded_decl</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679208704"><a href="#local-6989586621679208704"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-820"></a><span>    </span><a name="local-6989586621679208705"><a href="#local-6989586621679208705"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">qNewName</span><span> </span><span class="hs-string">&quot;z&quot;</span><span>
</span><a name="line-821"></a><span>    </span><span class="hs-comment">-- Derive the Show instance for the singleton type, like this:</span><span>
</span><a name="line-822"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-823"></a><span>    </span><span class="hs-comment">--   deriving instance (ShowSing a, ShowSing b) =&gt; Sing (Sing (z :: Either a b))</span><span>
</span><a name="line-824"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-825"></a><span>    </span><span class="hs-comment">-- Be careful: we want to generate an instance context that uses ShowSing,</span><span>
</span><a name="line-826"></a><span>    </span><span class="hs-comment">-- not SShow.</span><span>
</span><a name="line-827"></a><span>    </span><a name="local-6989586621679208706"><a href="#local-6989586621679208706"><span class="hs-identifier">show_cxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Deriving.Infer.html#inferConstraintsDef"><span class="hs-identifier hs-var">inferConstraintsDef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Data.Singletons.Deriving.Show.html#mkShowSingContext"><span class="hs-identifier hs-var">mkShowSingContext</span></a><span> </span><a href="#local-6989586621679208702"><span class="hs-identifier hs-var">mb_cxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-828"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConPr</span><span> </span><a href="Data.Singletons.Names.html#showSingName"><span class="hs-identifier hs-var">showSingName</span></a><span class="hs-special">)</span><span>
</span><a name="line-829"></a><span>                                    </span><a href="#local-6989586621679208703"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621679208704"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-830"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208707"><a href="#local-6989586621679208707"><span class="hs-identifier">show_inst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DStandaloneDerivD</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679208706"><span class="hs-identifier hs-var">show_cxt</span></a><span>
</span><a name="line-831"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConT</span><span> </span><a href="Data.Singletons.Names.html#showName"><span class="hs-identifier hs-var">showName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">DSigT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarT</span><span> </span><a href="#local-6989586621679208705"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208703"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-832"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679208707"><span class="hs-identifier hs-var">show_inst</span></a><span class="hs-special">]</span><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DExp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-835"></a><a name="isException"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier">isException</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><a name="local-6989586621679208708"><a href="#local-6989586621679208708"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679208708"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;sUndefined&quot;</span><span>
</span><a name="line-836"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DConE</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-837"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DLitE</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-838"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DAppE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><a name="local-6989586621679208709"><a href="#local-6989586621679208709"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">nameBase</span><span> </span><a href="#local-6989586621679208709"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;sError&quot;</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-839"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DAppE</span><span> </span><a name="local-6989586621679208710"><a href="#local-6989586621679208710"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a><span> </span><a href="#local-6989586621679208710"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-840"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DAppTypeE</span><span> </span><a name="local-6989586621679208711"><a href="#local-6989586621679208711"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a><span> </span><a href="#local-6989586621679208711"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-841"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DLamE</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-842"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DCaseE</span><span> </span><a name="local-6989586621679208712"><a href="#local-6989586621679208712"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a><span> </span><a href="#local-6989586621679208712"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-843"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DLetE</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679208713"><a href="#local-6989586621679208713"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a><span> </span><a href="#local-6989586621679208713"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-844"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DSigE</span><span> </span><a name="local-6989586621679208714"><a href="#local-6989586621679208714"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a><span> </span><a href="#local-6989586621679208714"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-845"></a><span class="hs-identifier">isException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DStaticE</span><span> </span><a name="local-6989586621679208715"><a href="#local-6989586621679208715"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a><span> </span><a href="#local-6989586621679208715"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span class="hs-identifier">singMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span>  </span><span class="hs-comment">-- ^ the result kind, if known</span><span>
</span><a name="line-848"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier hs-type">ADMatch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DMatch</span><span>
</span><a name="line-849"></a><a name="singMatch"><a href="Data.Singletons.Single.html#singMatch"><span class="hs-identifier">singMatch</span></a></a><span> </span><a name="local-6989586621679208716"><a href="#local-6989586621679208716"><span class="hs-identifier">res_ki</span></a></a><span> </span><span class="hs-special">(</span><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier hs-var">ADMatch</span></a><span> </span><a name="local-6989586621679208717"><a href="#local-6989586621679208717"><span class="hs-identifier">var_proms</span></a></a><span> </span><a name="local-6989586621679208718"><a href="#local-6989586621679208718"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621679208719"><a href="#local-6989586621679208719"><span class="hs-identifier">exp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-850"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679208720"><a href="#local-6989586621679208720"><span class="hs-identifier">sPat</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679208721"><a href="#local-6989586621679208721"><span class="hs-identifier">sigPaExpsSigs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Single.html#singPat"><span class="hs-identifier hs-var">singPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><a href="#local-6989586621679208717"><span class="hs-identifier hs-var">var_proms</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679208718"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-851"></a><span>  </span><a name="local-6989586621679208722"><a href="#local-6989586621679208722"><span class="hs-identifier">sExp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a><span> </span><a href="#local-6989586621679208719"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621679208716"><span class="hs-identifier hs-var">res_ki</span></a><span>
</span><a name="line-852"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DMatch</span><span> </span><a href="#local-6989586621679208720"><span class="hs-identifier hs-var">sPat</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Data.Singletons.Single.html#mkSigPaCaseE"><span class="hs-identifier hs-var">mkSigPaCaseE</span></a><span> </span><a href="#local-6989586621679208721"><span class="hs-identifier hs-var">sigPaExpsSigs</span></a><span> </span><a href="#local-6989586621679208722"><span class="hs-identifier hs-var">sExp</span></a><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span class="hs-identifier">singLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Lit</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a><span> </span><span class="hs-identifier hs-type">DExp</span><span>
</span><a name="line-855"></a><a name="singLit"><a href="Data.Singletons.Single.html#singLit"><span class="hs-identifier">singLit</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IntegerL</span><span> </span><a name="local-6989586621679208723"><a href="#local-6989586621679208723"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-856"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679208723"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-857"></a><span>                </span><span class="hs-identifier hs-var">DVarE</span><span> </span><a href="Data.Singletons.Names.html#sFromIntegerName"><span class="hs-identifier hs-var">sFromIntegerName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppE</span><span class="hs-special">`</span><span>
</span><a name="line-858"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DVarE</span><span> </span><a href="Data.Singletons.Names.html#singMethName"><span class="hs-identifier hs-var">singMethName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DSigE</span><span class="hs-special">`</span><span>
</span><a name="line-859"></a><span>                 </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">DLitT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NumTyLit</span><span> </span><a href="#local-6989586621679208723"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679208724"><a href="#local-6989586621679208724"><span class="hs-identifier">sLit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Singletons.Single.html#singLit"><span class="hs-identifier hs-var">singLit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IntegerL</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><a href="#local-6989586621679208723"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-861"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DVarE</span><span> </span><a href="Data.Singletons.Names.html#sNegateName"><span class="hs-identifier hs-var">sNegateName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppE</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208724"><span class="hs-identifier hs-var">sLit</span></a><span>
</span><a name="line-862"></a><span class="hs-identifier">singLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StringL</span><span> </span><a name="local-6989586621679208725"><a href="#local-6989586621679208725"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-863"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679208726"><a href="#local-6989586621679208726"><span class="hs-identifier">sing_str_lit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DVarE</span><span> </span><a href="Data.Singletons.Names.html#singMethName"><span class="hs-identifier hs-var">singMethName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DSigE</span><span class="hs-special">`</span><span>
</span><a name="line-864"></a><span>                     </span><span class="hs-special">(</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">DLitT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StrTyLit</span><span> </span><a href="#local-6989586621679208725"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-865"></a><span>  </span><a name="local-6989586621679208727"><a href="#local-6989586621679208727"><span class="hs-identifier">os_enabled</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">qIsExtEnabled</span><span> </span><span class="hs-identifier hs-var">LangExt.OverloadedStrings</span><span>
</span><a name="line-866"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679208727"><span class="hs-identifier hs-var">os_enabled</span></a><span>
</span><a name="line-867"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">DVarE</span><span> </span><a href="Data.Singletons.Names.html#sFromStringName"><span class="hs-identifier hs-var">sFromStringName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DAppE</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208726"><span class="hs-identifier hs-var">sing_str_lit</span></a><span>
</span><a name="line-868"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679208726"><span class="hs-identifier hs-var">sing_str_lit</span></a><span>
</span><a name="line-869"></a><span class="hs-identifier">singLit</span><span> </span><a name="local-6989586621679208728"><a href="#local-6989586621679208728"><span class="hs-identifier">lit</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-870"></a><span>  </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Only string and natural number literals can be singled: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679208728"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-871"></a><span>
</span><a name="line-872"></a><span class="hs-identifier">maybeSigT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DType</span><span>
</span><a name="line-873"></a><a name="maybeSigT"><a href="Data.Singletons.Single.html#maybeSigT"><span class="hs-identifier">maybeSigT</span></a></a><span> </span><a name="local-6989586621679208729"><a href="#local-6989586621679208729"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679208729"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-874"></a><span class="hs-identifier">maybeSigT</span><span> </span><a name="local-6989586621679208730"><a href="#local-6989586621679208730"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679208731"><a href="#local-6989586621679208731"><span class="hs-identifier">ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679208730"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">DSigT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679208731"><span class="hs-identifier hs-var">ki</span></a><span>
</span><a name="line-875"></a></pre></body></html>